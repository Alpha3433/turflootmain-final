(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1615],{76207:function(e,t,i){var s=i(9109).Buffer;!function(e){"use strict";var t,i,r,n,o,a,l,h,d,f,c;e.OPERATION=void 0,(c=e.OPERATION||(e.OPERATION={}))[c.ADD=128]="ADD",c[c.REPLACE=0]="REPLACE",c[c.DELETE=64]="DELETE",c[c.DELETE_AND_MOVE=96]="DELETE_AND_MOVE",c[c.MOVE_AND_ADD=160]="MOVE_AND_ADD",c[c.DELETE_AND_ADD=192]="DELETE_AND_ADD",c[c.CLEAR=10]="CLEAR",c[c.REVERSE=15]="REVERSE",c[c.MOVE=32]="MOVE",c[c.DELETE_BY_REFID=33]="DELETE_BY_REFID",c[c.ADD_BY_REFID=129]="ADD_BY_REFID",Symbol.metadata??=Symbol.for("Symbol.metadata");let u="~track",g="~encoder",m="~decoder",p="~filter",E="~getByIndex",y="~deleteByIndex",O="~changes",b="~childType",I="~onEncodeEnd",v="~onDecodeEnd",A="~descriptors",T="~__numFields",x="~__refTypeFieldIndexes",C="~__viewFieldIndexes",R="$__fieldIndexesByViewTag";try{new TextEncoder}catch(e){}let N=new ArrayBuffer(8),P=new Int32Array(N),D=new Float32Array(N),$=new Float64Array(N),w=new BigInt64Array(N),S=void 0!==s&&s.byteLength?s.byteLength:function(e,t){for(var i=0,s=0,r=0,n=e.length;r<n;r++)(i=e.charCodeAt(r))<128?s+=1:i<2048?s+=2:i<55296||i>=57344?s+=3:(r++,s+=4);return s};function F(e,t,i){for(var s=0,r=0,n=t.length;r<n;r++)(s=t.charCodeAt(r))<128?e[i.offset++]=s:s<2048?(e[i.offset]=192|s>>6,e[i.offset+1]=128|63&s,i.offset+=2):s<55296||s>=57344?(e[i.offset]=224|s>>12,e[i.offset+1]=128|s>>6&63,e[i.offset+2]=128|63&s,i.offset+=3):(r++,s=65536+((1023&s)<<10|1023&t.charCodeAt(r)),e[i.offset]=240|s>>18,e[i.offset+1]=128|s>>12&63,e[i.offset+2]=128|s>>6&63,e[i.offset+3]=128|63&s,i.offset+=4)}function j(e,t,i){e[i.offset++]=255&t}function L(e,t,i){e[i.offset++]=255&t,e[i.offset++]=t>>8&255}function _(e,t,i){e[i.offset++]=255&t,e[i.offset++]=t>>8&255}function k(e,t,i){e[i.offset++]=255&t,e[i.offset++]=t>>8&255,e[i.offset++]=t>>16&255,e[i.offset++]=t>>24&255}function M(e,t,i){e[i.offset++]=255&t,e[i.offset++]=255&t>>8,e[i.offset++]=255&t>>16,e[i.offset++]=255&t>>24}function V(e,t,i){M(e,t>>>0,i),M(e,Math.floor(t/4294967296),i)}function B(e,t,i){M(e,t>>>0,i),M(e,t/4294967296>>0,i)}function q(e,t,i){D[0]=t,k(e,P[0],i)}function J(e,t,i){$[0]=t,k(e,P[0],i),k(e,P[1],i)}let z={int8:j,uint8:function(e,t,i){e[i.offset++]=255&t},int16:L,uint16:_,int32:k,uint32:M,int64:V,uint64:B,bigint64:function(e,t,i){w[0]=BigInt.asIntN(64,t),k(e,P[0],i),k(e,P[1],i)},biguint64:function(e,t,i){w[0]=BigInt.asIntN(64,t),k(e,P[0],i),k(e,P[1],i)},float32:q,float64:J,boolean:function(e,t,i){e[i.offset++]=t?1:0},string:function(e,t,i){t||(t="");let s=S(t,"utf8"),r=0;if(s<32)e[i.offset++]=160|s,r=1;else if(s<256)e[i.offset++]=217,e[i.offset++]=s%255,r=2;else if(s<65536)e[i.offset++]=218,_(e,s,i),r=3;else if(s<4294967296)e[i.offset++]=219,M(e,s,i),r=5;else throw Error("String too long");return F(e,t,i),r+s},number:function e(t,i,s){return isNaN(i)?e(t,0,s):isFinite(i)?i!==(0|i)?34028235e31>=Math.abs(i)&&(D[0]=i,1e-4>Math.abs(Math.abs(D[0])-Math.abs(i)))?(t[s.offset++]=202,q(t,i,s),5):(t[s.offset++]=203,J(t,i,s),9):i>=0?i<128?(t[s.offset++]=255&i,1):i<256?(t[s.offset++]=204,t[s.offset++]=255&i,2):i<65536?(t[s.offset++]=205,_(t,i,s),3):i<4294967296?(t[s.offset++]=206,M(t,i,s),5):(t[s.offset++]=207,B(t,i,s),9):i>=-32?(t[s.offset++]=224|i+32,1):i>=-128?(t[s.offset++]=208,j(t,i,s),2):i>=-32768?(t[s.offset++]=209,L(t,i,s),3):i>=-2147483648?(t[s.offset++]=210,k(t,i,s),5):(t[s.offset++]=211,V(t,i,s),9):e(t,i>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER,s)},utf8Write:F,utf8Length:S},U=new ArrayBuffer(8),W=new Int32Array(U),Y=new Float32Array(U),Z=new Float64Array(U),G=new BigUint64Array(U),K=new BigInt64Array(U);function X(e,t,i){for(var s="",r=0,n=t.offset,o=t.offset+i;n<o;n++){var a=e[n];if((128&a)==0){s+=String.fromCharCode(a);continue}if((224&a)==192){s+=String.fromCharCode((31&a)<<6|63&e[++n]);continue}if((240&a)==224){s+=String.fromCharCode((15&a)<<12|(63&e[++n])<<6|(63&e[++n])<<0);continue}if((248&a)==240){(r=(7&a)<<18|(63&e[++n])<<12|(63&e[++n])<<6|(63&e[++n])<<0)>=65536?(r-=65536,s+=String.fromCharCode((r>>>10)+55296,(1023&r)+56320)):s+=String.fromCharCode(r);continue}console.error("Invalid byte "+a.toString(16))}return t.offset+=i,s}function H(e,t){return Q(e,t)<<24>>24}function Q(e,t){return e[t.offset++]}function ee(e,t){return et(e,t)<<16>>16}function et(e,t){return e[t.offset++]|e[t.offset++]<<8}function ei(e,t){return e[t.offset++]|e[t.offset++]<<8|e[t.offset++]<<16|e[t.offset++]<<24}function es(e,t){return ei(e,t)>>>0}function er(e,t){return W[0]=ei(e,t),Y[0]}function en(e,t){return W[0]=ei(e,t),W[1]=ei(e,t),Z[0]}function eo(e,t){let i=es(e,t);return 4294967296*ei(e,t)+i}function ea(e,t){let i=es(e,t);return 4294967296*es(e,t)+i}let el={utf8Read:X,int8:H,uint8:Q,int16:ee,uint16:et,int32:ei,uint32:es,float32:er,float64:en,int64:eo,uint64:ea,bigint64:function(e,t){return W[0]=ei(e,t),W[1]=ei(e,t),K[0]},biguint64:function(e,t){return W[0]=ei(e,t),W[1]=ei(e,t),G[0]},boolean:function(e,t){return Q(e,t)>0},string:function(e,t){let i;let s=e[t.offset++];return s<192?i=31&s:217===s?i=Q(e,t):218===s?i=et(e,t):219===s&&(i=es(e,t)),X(e,t,i)},number:function(e,t){let i=e[t.offset++];if(i<128)return i;if(202===i)return er(e,t);if(203===i)return en(e,t);if(204===i)return Q(e,t);if(205===i)return et(e,t);if(206===i)return es(e,t);if(207===i)return ea(e,t);else if(208===i)return H(e,t);else if(209===i)return ee(e,t);else if(210===i)return ei(e,t);else if(211===i)return eo(e,t);else if(i>223)return-((255-i+1)*1)},stringCheck:function(e,t){let i=e[t.offset];return i<192&&i>160||217===i||218===i||219===i}},eh={},ed=new Map;function ef(e,t){t.constructor&&(ed.set(t.constructor,e),eh[e]=t),t.encode&&(z[e]=t.encode),t.decode&&(el[e]=t.decode)}class ec{static{this.inheritedTypes=new Map}static{this.cachedContexts=new Map}static register(e){let t=Object.getPrototypeOf(e);if(t!==eM){let i=ec.inheritedTypes.get(t);i||(i=new Set,ec.inheritedTypes.set(t,i)),i.add(e)}}static cache(e){let t=ec.cachedContexts.get(e);return t||(t=new ec(e),ec.cachedContexts.set(e,t)),t}constructor(e){this.types={},this.schemas=new Map,this.hasFilters=!1,this.parentFiltered={},e&&this.discoverTypes(e)}has(e){return this.schemas.has(e)}get(e){return this.types[e]}add(e,t=this.schemas.size){return!this.schemas.has(e)&&(this.types[t]=e,void 0===e[Symbol.metadata]&&eg.initialize(e),this.schemas.set(e,t),!0)}getTypeId(e){return this.schemas.get(e)}discoverTypes(e,t,i,s){if(s&&this.registerFilteredByParent(e,t,i),!this.add(e))return;ec.inheritedTypes.get(e)?.forEach(e=>{this.discoverTypes(e,t,i,s)});let r=e;for(;(r=Object.getPrototypeOf(r))&&r!==eM&&r!==Function.prototype;)this.discoverTypes(r);let n=e[Symbol.metadata]??={};for(let t in n[C]&&(this.hasFilters=!0),n){let i=n[t].type,r=void 0!==n[t].tag;if("string"!=typeof i){if("function"==typeof i)this.discoverTypes(i,e,t,s||r);else{let n=Object.values(i)[0];if("string"==typeof n)continue;this.discoverTypes(n,e,t,s||r)}}}}registerFilteredByParent(e,t,i){let s=this.schemas.get(e)??this.schemas.size,r=`${s}`;t&&(r+=`-${this.schemas.get(t)}`),r+=`-${i}`,this.parentFiltered[r]=!0}debug(){let e="";for(let t in this.parentFiltered){let i=t.split("-").map(Number),s=i.pop();e+=`
		${t}: ${i.reverse().map((e,t)=>{let i=this.types[e],r=i[Symbol.metadata],n=i.name;return 0===t&&(n+=`[${r[s].name}]`),`${n}`}).join(" -> ")}`}return`TypeContext ->
	Schema types: ${this.schemas.size}
	hasFilters: ${this.hasFilters}
	parentFiltered:${e}`}}function eu(e){if(Array.isArray(e))return{array:eu(e[0])};if(void 0!==e.type)return e.type;if(function(e){if("function"==typeof e&&e[Symbol.metadata])return!1;let t=Object.keys(e),i=t.filter(e=>/\d+/.test(e));return!!(i.length>0&&i.length===t.length/2&&e[e[i[0]]]==i[0]||t.length>0&&t.every(t=>"string"==typeof e[t]&&e[t]===t))}(e))return Object.keys(e).every(t=>"string"==typeof e[t])?"string":"number";if("object"==typeof e&&null!==e){let t=Object.keys(e).find(e=>void 0!==eh[e]);t&&(e[t]=eu(e[t]))}return e}let eg={addField(e,t,i,s,r){if(t>64)throw Error(`Can't define field '${i}'.
Schema instances may only have up to 64 fields.`);e[t]=Object.assign(e[t]||{},{type:eu(s),index:t,name:i}),Object.defineProperty(e,A,{value:e[A]||{},enumerable:!1,configurable:!0}),r?(e[A][i]=r,e[A][`_${i}`]={value:void 0,writable:!0,enumerable:!1,configurable:!0}):e[A][i]={value:void 0,writable:!0,enumerable:!0,configurable:!0},Object.defineProperty(e,T,{value:t,enumerable:!1,configurable:!0}),Object.defineProperty(e,i,{value:t,enumerable:!1,configurable:!0}),"string"!=typeof e[t].type&&(void 0===e[x]&&Object.defineProperty(e,x,{value:[],enumerable:!1,configurable:!0}),e[x].push(t))},setTag(e,t,i){let s=e[t];e[s].tag=i,e[C]||(Object.defineProperty(e,C,{value:[],enumerable:!1,configurable:!0}),Object.defineProperty(e,R,{value:{},enumerable:!1,configurable:!0})),e[C].push(s),e[R][i]||(e[R][i]=[]),e[R][i].push(s)},setFields(e,t){let i=e.prototype.constructor;ec.register(i);let s=Object.getPrototypeOf(i),r=s&&s[Symbol.metadata],n=eg.initialize(i);i[u]||(i[u]=eM[u]),i[g]||(i[g]=eM[g]),i[m]||(i[m]=eM[m]),i.prototype.toJSON||(i.prototype.toJSON=eM.prototype.toJSON);let o=n[T]??(r&&r[T])??-1;for(let e in o++,t){let i=eu(t[e]),s="string"==typeof Object.keys(i)[0]&&eh[Object.keys(i)[0]],r=s?Object.values(i)[0]:i;eg.addField(n,o,e,i,e_(`_${e}`,o,r,s)),o++}return e},isDeprecated:(e,t)=>!0===e[t].deprecated,init(e){let t={};e[Symbol.metadata]=t,Object.defineProperty(t,T,{value:0,enumerable:!1,configurable:!0})},initialize(e){let t=Object.getPrototypeOf(e),i=t[Symbol.metadata],s=e[Symbol.metadata]??Object.create(null);return t!==eM&&s===i&&(s=Object.create(null),i&&(Object.setPrototypeOf(s,i),Object.defineProperty(s,T,{value:i[T],enumerable:!1,configurable:!0,writable:!0}),void 0!==i[C]&&(Object.defineProperty(s,C,{value:[...i[C]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(s,R,{value:{...i[R]},enumerable:!1,configurable:!0,writable:!0})),void 0!==i[x]&&Object.defineProperty(s,x,{value:[...i[x]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(s,A,{value:{...i[A]},enumerable:!1,configurable:!0,writable:!0}))),e[Symbol.metadata]=s,s},isValidInstance:e=>e.constructor[Symbol.metadata]&&Object.prototype.hasOwnProperty.call(e.constructor[Symbol.metadata],T),getFields(e){let t=e[Symbol.metadata],i={};for(let e=0;e<=t[T];e++)i[t[e].name]=t[e].type;return i},hasViewTagAtIndex:(e,t)=>e?.[C]?.includes(t)};function em(e){return{indexes:{},operations:[],queueRootNode:e}}function ep(){return{next:void 0,tail:void 0}}function eE(e,t){let i=e.indexes[t];void 0===i?e.indexes[t]=e.operations.push(t)-1:e.operations[i]=t}function ey(e,t){let i=e.indexes[t];void 0===i&&(i=Object.values(e.indexes).at(-1),t=Object.entries(e.indexes).find(([e,t])=>t===i)?.[0]),e.operations[i]=void 0,delete e.indexes[t]}class eO{constructor(e){this.isFiltered=!1,this.indexedOperations={},this.changes={indexes:{},operations:[]},this.allChanges={indexes:{},operations:[]},this.isNew=!0,this.ref=e,this.metadata=e.constructor[Symbol.metadata],this.metadata?.[C]&&(this.allFilteredChanges={indexes:{},operations:[]},this.filteredChanges={indexes:{},operations:[]})}setRoot(e){this.root=e;let t=this.root.add(this);this.checkIsFiltered(this.parent,this.parentIndex,t),t&&this.forEachChild((t,i)=>{t.root!==e?t.setRoot(e):e.add(t)})}setParent(e,t,i){if(this.addParent(e,i),!t)return;let s=t.add(this);t!==this.root&&(this.root=t,this.checkIsFiltered(e,i,s)),s&&this.forEachChild((e,i)=>{if(e.root===t){t.add(e),t.moveNextToParent(e);return}e.setParent(this.ref,t,i)})}forEachChild(e){if(this.ref[b]){if("string"!=typeof this.ref[b])for(let[t,i]of this.ref.entries())e(i[O],this.indexes?.[t]??t)}else for(let t of this.metadata?.[x]??[]){let i=this.metadata[t],s=this.ref[i.name];s&&e(s[O],t)}}operation(e){void 0!==this.filteredChanges?(this.filteredChanges.operations.push(-e),this.root?.enqueueChangeTree(this,"filteredChanges")):(this.changes.operations.push(-e),this.root?.enqueueChangeTree(this,"changes"))}change(t,i=e.OPERATION.ADD){let s=this.isFiltered||this.metadata?.[t]?.tag!==void 0,r=s?this.filteredChanges:this.changes,n=this.indexedOperations[t];if(!n||n===e.OPERATION.DELETE){let s=n&&n===e.OPERATION.DELETE?e.OPERATION.DELETE_AND_ADD:i;this.indexedOperations[t]=s}eE(r,t),s?(eE(this.allFilteredChanges,t),this.root&&(this.root.enqueueChangeTree(this,"filteredChanges"),this.root.enqueueChangeTree(this,"allFilteredChanges"))):(eE(this.allChanges,t),this.root?.enqueueChangeTree(this,"changes"))}shiftChangeIndexes(e){let t=this.isFiltered?this.filteredChanges:this.changes,i={},s={};for(let r in this.indexedOperations)i[Number(r)+e]=this.indexedOperations[r],s[Number(r)+e]=t.indexes[r];this.indexedOperations=i,t.indexes=s,t.operations=t.operations.map(t=>t+e)}shiftAllChangeIndexes(e,t=0){void 0!==this.filteredChanges&&this._shiftAllChangeIndexes(e,t,this.allFilteredChanges),this._shiftAllChangeIndexes(e,t,this.allChanges)}_shiftAllChangeIndexes(e,t=0,i){let s={},r=0;for(let e in i.indexes)s[r++]=i.indexes[e];i.indexes=s;for(let s=0;s<i.operations.length;s++){let r=i.operations[s];r>t&&(i.operations[s]=r+e)}}indexedOperation(e,t,i=e){this.indexedOperations[e]=t,void 0!==this.filteredChanges?(eE(this.allFilteredChanges,i),eE(this.filteredChanges,e),this.root?.enqueueChangeTree(this,"filteredChanges")):(eE(this.allChanges,i),eE(this.changes,e),this.root?.enqueueChangeTree(this,"changes"))}getType(e){return this.ref[b]||this.metadata[e].type}getChange(e){return this.indexedOperations[e]}getValue(e,t=!1){return this.ref[E](e,t)}delete(t,i,s=t){if(void 0===t){try{throw Error(`@colyseus/schema ${this.ref.constructor.name}: trying to delete non-existing index '${t}'`)}catch(e){console.warn(e)}return}let r=void 0!==this.filteredChanges?this.filteredChanges:this.changes;this.indexedOperations[t]=i??e.OPERATION.DELETE,eE(r,t),ey(this.allChanges,s);let n=this.getValue(t);return n&&n[O]&&this.root?.remove(n[O]),void 0!==this.filteredChanges?(ey(this.allFilteredChanges,s),this.root?.enqueueChangeTree(this,"filteredChanges")):this.root?.enqueueChangeTree(this,"changes"),n}endEncode(e){this.indexedOperations={},this[e]=em(),this.ref[I]?.(),this.isNew=!1}discard(e=!1){this.ref[I]?.(),this.indexedOperations={},this.changes=em(this.changes.queueRootNode),void 0!==this.filteredChanges&&(this.filteredChanges=em(this.filteredChanges.queueRootNode)),e&&(this.allChanges=em(this.allChanges.queueRootNode),void 0!==this.allFilteredChanges&&(this.allFilteredChanges=em(this.allFilteredChanges.queueRootNode)))}discardAll(){let e=Object.keys(this.indexedOperations);for(let t=0,i=e.length;t<i;t++){let i=this.getValue(Number(e[t]));i&&i[O]&&i[O].discardAll()}this.discard()}get changed(){return Object.entries(this.indexedOperations).length>0}checkIsFiltered(e,t,i){this.root.types.hasFilters&&(this._checkFilteredByParent(e,t),void 0!==this.filteredChanges&&(this.root?.enqueueChangeTree(this,"filteredChanges"),i&&this.root?.enqueueChangeTree(this,"allFilteredChanges"))),!this.isFiltered&&(this.root?.enqueueChangeTree(this,"changes"),i&&this.root?.enqueueChangeTree(this,"allChanges"))}_checkFilteredByParent(e,t){let i;if(!e)return;let s=eg.isValidInstance(this.ref)?this.ref.constructor:this.ref[b],r=!eg.isValidInstance(e);r?(e=(i=e[O]).parent,t=i.parentIndex):i=e[O];let n=e.constructor,o=`${this.root.types.getTypeId(s)}`;n&&(o+=`-${this.root.types.schemas.get(n)}`),o+=`-${t}`;let a=eg.hasViewTagAtIndex(n?.[Symbol.metadata],t);this.isFiltered=e[O].isFiltered||this.root.types.parentFiltered[o]||a,this.isFiltered&&(this.isVisibilitySharedWithParent=i.isFiltered&&"string"!=typeof s&&!a&&r,this.filteredChanges||(this.filteredChanges=em(),this.allFilteredChanges=em()),this.changes.operations.length>0&&(this.changes.operations.forEach(e=>eE(this.filteredChanges,e)),this.allChanges.operations.forEach(e=>eE(this.allFilteredChanges,e)),this.changes=em(),this.allChanges=em()))}get parent(){return this.parentChain?.ref}get parentIndex(){return this.parentChain?.index}addParent(e,t){if(this.hasParent((t,i)=>t[O]===e[O])){this.parentChain.index=t;return}this.parentChain={ref:e,index:t,next:this.parentChain}}removeParent(e=this.parent){let t=this.parentChain,i=null;for(;t;){if(t.ref[O]===e[O])return i?i.next=t.next:this.parentChain=t.next,!0;i=t,t=t.next}return void 0===this.parentChain}findParent(e){let t=this.parentChain;for(;t;){if(e(t.ref,t.index))return t;t=t.next}}hasParent(e){return void 0!==this.findParent(e)}getAllParents(){let e=[],t=this.parentChain;for(;t;)e.push({ref:t.ref,index:t.index}),t=t.next;return e}}function eb(t,i,s,r,n,o){"string"==typeof s?z[s]?.(i,r,o):void 0!==s[Symbol.metadata]?(z.number(i,r[O].refId,o),(n&e.OPERATION.ADD)===e.OPERATION.ADD&&t.tryEncodeTypeId(i,s,r.constructor,o)):z.number(i,r[O].refId,o)}let eI=function(t,i,s,r,n,o,a,l,h){if(i[o.offset++]=(r|n)&255,n===e.OPERATION.DELETE)return;let d=s.ref,f=h[r];eb(t,i,h[r].type,d[f.name],n,o)},ev=function(t,i,s,r,n,o){if(i[o.offset++]=255&n,z.number(i,r,o),n===e.OPERATION.DELETE)return;let a=s.ref;if((n&e.OPERATION.ADD)===e.OPERATION.ADD&&"function"==typeof a.set){let e=s.ref.$indexes.get(r);z.string(i,e,o)}eb(t,i,a[b],a[E](r),n,o)},eA=function(t,i,s,r,n,o,a,l){let h;let d=s.ref;if(l&&s.isFiltered&&"string"!=typeof s.getType(r)){let t=d.tmpItems[r];if(!t)return;h=t[O].refId,n===e.OPERATION.DELETE?n=e.OPERATION.DELETE_BY_REFID:n===e.OPERATION.ADD&&(n=e.OPERATION.ADD_BY_REFID)}else h=r;i[o.offset++]=255&n,z.number(i,h,o),n!==e.OPERATION.DELETE&&n!==e.OPERATION.DELETE_BY_REFID&&eb(t,i,s.getType(r),s.getValue(r,a),n,o)};function eT(t,i,s,r,n,o,a,l){let h;let d=t.root,f=s[E](r);if((i&e.OPERATION.DELETE)===e.OPERATION.DELETE){let t=d.refIds.get(f);void 0!==t&&d.removeRef(t),i!==e.OPERATION.DELETE_AND_ADD&&s[y](r),h=void 0}if(i===e.OPERATION.DELETE);else if(eM.is(n)){let s=el.number(o,a);if(h=d.refs.get(s),(i&e.OPERATION.ADD)===e.OPERATION.ADD){let r=t.getInstanceType(o,a,n);h||(h=t.createInstanceOfType(r)),d.addRef(s,h,h!==f||i===e.OPERATION.DELETE_AND_ADD&&h===f)}}else if("string"==typeof n)h=el[n](o,a);else{let t=eh[Object.keys(n)[0]],s=el.number(o,a),r=d.refs.has(s)?f||d.refs.get(s):new t.constructor;if((h=r.clone(!0))[b]=Object.values(n)[0],f){let t=d.refIds.get(f);if(void 0!==t&&s!==t){let i;let s=f.entries();for(;(i=s.next())&&!i.done;){let[s,r]=i.value;"object"==typeof r&&(t=d.refIds.get(r),d.removeRef(t)),l.push({ref:f,refId:t,op:e.OPERATION.DELETE,field:s,value:void 0,previousValue:r})}}}d.addRef(s,h,r!==f||i===e.OPERATION.DELETE_AND_ADD&&r===f)}return{value:h,previousValue:f}}let ex=function(e,t,i,s,r){let n=t[i.offset++],o=s.constructor[Symbol.metadata],a=n>>6<<6,l=n%(a||255),h=o[l];if(void 0===h)return console.warn("@colyseus/schema: field not defined at",{index:l,ref:s.constructor.name,metadata:o}),-1;let{value:d,previousValue:f}=eT(e,a,s,l,h.type,t,i,r);null!=d&&(s[h.name]=d),f!==d&&r.push({ref:s,refId:e.currentRefId,op:a,field:h.name,value:d,previousValue:f})},eC=function(t,i,s,r,n){let o;let a=i[s.offset++];if(a===e.OPERATION.CLEAR){t.removeChildRefs(r,n),r.clear();return}let l=el.number(i,s),h=r[b];(a&e.OPERATION.ADD)===e.OPERATION.ADD?"function"==typeof r.set?(o=el.string(i,s),r.setIndex(l,o)):o=l:o=r.getIndex(l);let{value:d,previousValue:f}=eT(t,a,r,l,h,i,s,n);if(null!=d){if("function"==typeof r.set)r.$items.set(o,d);else if("function"==typeof r.$setAt)r.$setAt(l,d,a);else if("function"==typeof r.add){let e=r.add(d);"number"==typeof e&&r.setIndex(e,e)}}f!==d&&n.push({ref:r,refId:t.currentRefId,op:a,field:"",dynamicIndex:o,value:d,previousValue:f})},eR=function(t,i,s,r,n){let o,a=i[s.offset++];if(a===e.OPERATION.CLEAR){t.removeChildRefs(r,n),r.clear();return}if(a===e.OPERATION.REVERSE){r.reverse();return}if(a===e.OPERATION.DELETE_BY_REFID){let a=el.number(i,s),l=t.root.refs.get(a);o=r.findIndex(e=>e===l),r[y](o),n.push({ref:r,refId:t.currentRefId,op:e.OPERATION.DELETE,field:"",dynamicIndex:o,value:void 0,previousValue:l});return}if(a===e.OPERATION.ADD_BY_REFID){let e=el.number(i,s),n=t.root.refs.get(e);n&&(o=r.findIndex(e=>e===n)),(-1===o||void 0===o)&&(o=r.length)}else o=el.number(i,s);let l=r[b],h=o,{value:d,previousValue:f}=eT(t,a,r,o,l,i,s,n);null!=d&&d!==f&&r.$setAt(o,d,a),f!==d&&n.push({ref:r,refId:t.currentRefId,op:a,field:"",dynamicIndex:h,value:d,previousValue:f})};class eN extends Error{}function eP(e,t,i,s){if(!(e instanceof t))throw new eN(`a '${t.name}' was expected, but '${e&&e.constructor.name}' was provided in ${i.constructor.name}#${s}`)}let eD=(e,t)=>{let i=e.toString(),s=t.toString();return i<s?-1:i>s?1:0};class e${static{this[t]=eA}static{this[i]=eR}static[(t=g,i=m,p)](e,t,i){return!i||"string"==typeof e[b]||i.isChangeTreeVisible(e.tmpItems[t]?.[O])}static is(e){return Array.isArray(e)||void 0!==e.array}static from(e){return new e$(...Array.from(e))}constructor(...t){this.items=[],this.tmpItems=[],this.deletedIndexes={},this.isMovingItems=!1,Object.defineProperty(this,b,{value:void 0,enumerable:!1,writable:!0,configurable:!0});let i=new Proxy(this,{get:(e,t)=>"symbol"==typeof t||isNaN(t)?Reflect.get(e,t):this.items[t],set:(t,i,s)=>{if("symbol"==typeof i||isNaN(i))return Reflect.set(t,i,s);if(null==s)t.$deleteAt(i);else{if(s[O]){eP(s,t[b],t,i);let r=t.items[i];t.isMovingItems?(void 0!==r?s[O].isNew?t[O].indexedOperation(Number(i),e.OPERATION.MOVE_AND_ADD):(t[O].getChange(Number(i))&e.OPERATION.DELETE)===e.OPERATION.DELETE?t[O].indexedOperation(Number(i),e.OPERATION.DELETE_AND_MOVE):t[O].indexedOperation(Number(i),e.OPERATION.MOVE):s[O].isNew&&t[O].indexedOperation(Number(i),e.OPERATION.ADD),s[O].setParent(this,t[O].root,i)):t.$changeAt(Number(i),s),void 0!==r&&r[O].root?.remove(r[O])}else t.$changeAt(Number(i),s);t.items[i]=s,t.tmpItems[i]=s}return!0},deleteProperty:(e,t)=>("number"==typeof t?e.$deleteAt(t):delete e[t],!0),has:(e,t)=>"symbol"==typeof t||isNaN(Number(t))?Reflect.has(e,t):Reflect.has(this.items,t)});return Object.defineProperty(this,O,{value:new eO(i),enumerable:!1,writable:!0}),t.length>0&&this.push(...t),i}set length(e){0===e?this.clear():e<this.items.length?this.splice(e,this.length-e):console.warn("ArraySchema: can't set .length to a higher value than its length.")}get length(){return this.items.length}push(...t){let i=this.tmpItems.length,s=this[O];for(let r=0,n=t.length;r<n;r++,i++){let n=t[r];if(null==n)return;"object"==typeof n&&this[b]&&eP(n,this[b],this,r),s.indexedOperation(i,e.OPERATION.ADD,this.items.length),this.items.push(n),this.tmpItems.push(n),n[O]?.setParent(this,s.root,i)}return i}pop(){let e=-1;for(let t=this.tmpItems.length-1;t>=0;t--)if(!0!==this.deletedIndexes[t]){e=t;break}if(!(e<0))return this[O].delete(e,void 0,this.items.length-1),this.deletedIndexes[e]=!0,this.items.pop()}at(e){return e<0&&(e+=this.length),this.items[e]}$changeAt(t,i){if(null==i){console.error("ArraySchema items cannot be null nor undefined; Use `deleteAt(index)` instead.");return}if(this.items[t]===i)return;let s=void 0!==this.items[t]?"object"==typeof i?e.OPERATION.DELETE_AND_ADD:e.OPERATION.REPLACE:e.OPERATION.ADD,r=this[O];r.change(t,s),i[O]?.setParent(this,r.root,t)}$deleteAt(e,t){this[O].delete(e,t)}$setAt(t,i,s){0===t&&s===e.OPERATION.ADD&&void 0!==this.items[t]?this.items.unshift(i):(s===e.OPERATION.DELETE_AND_MOVE&&this.items.splice(t,1),this.items[t]=i)}clear(){if(0===this.items.length)return;let t=this[O];t.forEachChild((e,i)=>{t.root?.remove(e)}),t.discard(!0),t.operation(e.OPERATION.CLEAR),this.items.length=0,this.tmpItems.length=0}concat(...e){return new e$(...this.items.concat(...e))}join(e){return this.items.join(e)}reverse(){return this[O].operation(e.OPERATION.REVERSE),this.items.reverse(),this.tmpItems.reverse(),this}shift(){if(0===this.items.length)return;let t=this[O],i=this.tmpItems.findIndex(e=>e===this.items[0]),s=this.items.findIndex(e=>e===this.items[0]);return t.delete(i,e.OPERATION.DELETE,s),t.shiftAllChangeIndexes(-1,s),this.deletedIndexes[i]=!0,this.items.shift()}slice(e,t){let i=new e$;return i.push(...this.items.slice(e,t)),i}sort(t=eD){this.isMovingItems=!0;let i=this[O];return this.items.sort(t).forEach((t,s)=>i.change(s,e.OPERATION.REPLACE)),this.tmpItems.sort(t),this.isMovingItems=!1,this}splice(t,i,...s){let r=this[O],n=this.items.length,o=this.tmpItems.length,a=s.length,l=[];for(let e=0;e<o;e++)!0!==this.deletedIndexes[e]&&l.push(e);if(n>t){void 0===i&&(i=n-t);for(let s=t;s<t+i;s++){let t=l[s];r.delete(t,e.OPERATION.DELETE),this.deletedIndexes[t]=!0}}else i=0;if(a>0){if(a>i)throw console.error("Inserting more elements than deleting during ArraySchema#splice()"),Error("ArraySchema#splice(): insertCount must be equal or lower than deleteCount.");for(let i=0;i<a;i++){let o=(l[t]??n)+i;r.indexedOperation(o,this.deletedIndexes[o]?e.OPERATION.DELETE_AND_ADD:e.OPERATION.ADD),s[i][O]?.setParent(this,r.root,o)}}return i>a&&r.shiftAllChangeIndexes(-(i-a),l[t+a]),void 0!==r.filteredChanges?r.root?.enqueueChangeTree(r,"filteredChanges"):r.root?.enqueueChangeTree(r,"changes"),this.items.splice(t,i,...s)}unshift(...t){let i=this[O];return i.shiftChangeIndexes(t.length),i.isFiltered?eE(i.filteredChanges,this.items.length):eE(i.allChanges,this.items.length),t.forEach((t,s)=>{i.change(s,e.OPERATION.ADD)}),this.tmpItems.unshift(...t),this.items.unshift(...t)}indexOf(e,t){return this.items.indexOf(e,t)}lastIndexOf(e,t=this.length-1){return this.items.lastIndexOf(e,t)}every(e,t){return this.items.every(e,t)}some(e,t){return this.items.some(e,t)}forEach(e,t){return this.items.forEach(e,t)}map(e,t){return this.items.map(e,t)}filter(e,t){return this.items.filter(e,t)}reduce(e,t){return this.items.reduce(e,t)}reduceRight(e,t){return this.items.reduceRight(e,t)}find(e,t){return this.items.find(e,t)}findIndex(e,t){return this.items.findIndex(e,t)}fill(e,t,i){throw Error("ArraySchema#fill() not implemented")}copyWithin(e,t,i){throw Error("ArraySchema#copyWithin() not implemented")}toString(){return this.items.toString()}toLocaleString(){return this.items.toLocaleString()}[Symbol.iterator](){return this.items[Symbol.iterator]()}static get[Symbol.species](){return e$}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}includes(e,t){return this.items.includes(e,t)}flatMap(e,t){throw Error("ArraySchema#flatMap() is not supported.")}flat(e){throw Error("ArraySchema#flat() is not supported.")}findLast(){return this.items.findLast.apply(this.items,arguments)}findLastIndex(...e){return this.items.findLastIndex.apply(this.items,arguments)}with(e,t){let i=this.items.slice();return e<0&&(e+=this.length),i[e]=t,new e$(...i)}toReversed(){return this.items.slice().reverse()}toSorted(e){return this.items.slice().sort(e)}toSpliced(e,t,...i){return this.items.toSpliced.apply(copy,arguments)}shuffle(){return this.move(e=>{let t=this.items.length;for(;0!=t;){let e=Math.floor(Math.random()*t);t--,[this[t],this[e]]=[this[e],this[t]]}})}move(e){return this.isMovingItems=!0,e(this),this.isMovingItems=!1,this}[E](e,t=!1){return t?this.items[e]:this.deletedIndexes[e]?this.items[e]:this.tmpItems[e]||this.items[e]}[y](e){this.items[e]=void 0,this.tmpItems[e]=void 0}[I](){this.tmpItems=this.items.slice(),this.deletedIndexes={}}[v](){this.items=this.items.filter(e=>void 0!==e),this.tmpItems=this.items.slice()}toArray(){return this.items.slice(0)}toJSON(){return this.toArray().map(e=>"function"==typeof e.toJSON?e.toJSON():e)}clone(e){let t;return e?(t=new e$).push(...this.items):t=new e$(...this.map(e=>e[O]?e.clone():e)),t}}ef("array",{constructor:e$});class ew{static{this[r]=ev}static{this[n]=eC}static[(r=g,n=m,p)](e,t,i){return!i||"string"==typeof e[b]||i.isChangeTreeVisible((e[E](t)??e.deletedItems[t])[O])}static is(e){return void 0!==e.map}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={};let t=new eO(this);if(t.indexes={},Object.defineProperty(this,O,{value:t,enumerable:!1,writable:!0}),e){if(e instanceof Map||e instanceof ew)e.forEach((e,t)=>this.set(t,e));else for(let t in e)this.set(t,e[t])}Object.defineProperty(this,b,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}[Symbol.iterator](){return this.$items[Symbol.iterator]()}get[Symbol.toStringTag](){return this.$items[Symbol.toStringTag]}static get[Symbol.species](){return ew}set(t,i){let s,r;if(null==i)throw Error(`MapSchema#set('${t}', ${i}): trying to set ${i} value on '${t}'.`);"object"==typeof i&&this[b]&&eP(i,this[b],this,t),t=t.toString();let n=this[O],o=void 0!==i[O];if(void 0!==n.indexes[t]){s=n.indexes[t],r=e.OPERATION.REPLACE;let a=this.$items.get(t);if(a===i)return;o&&(r=e.OPERATION.DELETE_AND_ADD,void 0!==a&&a[O].root?.remove(a[O])),this.deletedItems[s]&&delete this.deletedItems[s]}else s=n.indexes[T]??0,r=e.OPERATION.ADD,this.$indexes.set(s,t),n.indexes[t]=s,n.indexes[T]=s+1;return this.$items.set(t,i),n.change(s,r),o&&i[O].setParent(this,n.root,s),this}get(e){return this.$items.get(e)}delete(e){let t=this[O].indexes[e];return this.deletedItems[t]=this[O].delete(t),this.$items.delete(e)}clear(){let t=this[O];t.discard(!0),t.indexes={},t.forEachChild((e,i)=>{t.root?.remove(e)}),this.$indexes.clear(),this.$items.clear(),t.operation(e.OPERATION.CLEAR)}has(e){return this.$items.has(e)}forEach(e){this.$items.forEach(e)}entries(){return this.$items.entries()}keys(){return this.$items.keys()}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[E](e){return this.$items.get(this.$indexes.get(e))}[y](e){let t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[I](){let e=this[O];for(let t in this.deletedItems){let i=parseInt(t),s=this.$indexes.get(i);delete e.indexes[s],this.$indexes.delete(i)}this.deletedItems={}}toJSON(){let e={};return this.forEach((t,i)=>{e[i]="function"==typeof t.toJSON?t.toJSON():t}),e}clone(e){let t;return e?t=Object.assign(new ew,this):(t=new ew,this.forEach((e,i)=>{e[O]?t.set(i,e.clone()):t.set(i,e)})),t}}ef("map",{constructor:ew});class eS{static{this[o]=ev}static{this[a]=eC}static[(o=g,a=m,p)](e,t,i){return!i||"string"==typeof e[b]||i.isChangeTreeVisible((e[E](t)??e.deletedItems[t])[O])}static is(e){return void 0!==e.collection}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[O]=new eO(this),this[O].indexes={},e&&e.forEach(e=>this.add(e)),Object.defineProperty(this,b,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(e){let t=this.$refId++;return void 0!==e[O]&&e[O].setParent(this,this[O].root,t),this[O].indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,e),this[O].change(t),t}at(e){let t=Array.from(this.$items.keys())[e];return this.$items.get(t)}entries(){return this.$items.entries()}delete(e){let t,i;let s=this.$items.entries();for(;(i=s.next())&&!i.done;)if(e===i.value[1]){t=i.value[0];break}return void 0!==t&&(this.deletedItems[t]=this[O].delete(t),this.$indexes.delete(t),this.$items.delete(t))}clear(){let t=this[O];t.discard(!0),t.indexes={},t.forEachChild((e,i)=>{t.root?.remove(e)}),this.$indexes.clear(),this.$items.clear(),t.operation(e.OPERATION.CLEAR)}has(e){return Array.from(this.$items.values()).some(t=>t===e)}forEach(e){this.$items.forEach((t,i,s)=>e(t,i,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[E](e){return this.$items.get(this.$indexes.get(e))}[y](e){let t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[I](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){let e=[];return this.forEach((t,i)=>{e.push("function"==typeof t.toJSON?t.toJSON():t)}),e}clone(e){let t;return e?t=Object.assign(new eS,this):(t=new eS,this.forEach(e=>{e[O]?t.add(e.clone()):t.add(e)})),t}}ef("collection",{constructor:eS});class eF{static{this[l]=ev}static{this[h]=eC}static[(l=g,h=m,p)](e,t,i){return!i||"string"==typeof e[b]||i.visible.has((e[E](t)??e.deletedItems[t])[O])}static is(e){return void 0!==e.set}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[O]=new eO(this),this[O].indexes={},e&&e.forEach(e=>this.add(e)),Object.defineProperty(this,b,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(t){if(this.has(t))return!1;let i=this.$refId++;void 0!==t[O]&&t[O].setParent(this,this[O].root,i);let s=this[O].indexes[i]?.op??e.OPERATION.ADD;return this[O].indexes[i]=i,this.$indexes.set(i,i),this.$items.set(i,t),this[O].change(i,s),i}entries(){return this.$items.entries()}delete(e){let t,i;let s=this.$items.entries();for(;(i=s.next())&&!i.done;)if(e===i.value[1]){t=i.value[0];break}return void 0!==t&&(this.deletedItems[t]=this[O].delete(t),this.$indexes.delete(t),this.$items.delete(t))}clear(){let t=this[O];t.discard(!0),t.indexes={},this.$indexes.clear(),this.$items.clear(),t.operation(e.OPERATION.CLEAR)}has(e){let t;let i=this.$items.values(),s=!1;for(;(t=i.next())&&!t.done;)if(e===t.value){s=!0;break}return s}forEach(e){this.$items.forEach((t,i,s)=>e(t,i,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[E](e){return this.$items.get(this.$indexes.get(e))}[y](e){let t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[I](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){let e=[];return this.forEach((t,i)=>{e.push("function"==typeof t.toJSON?t.toJSON():t)}),e}clone(e){let t;return e?t=Object.assign(new eF,this):(t=new eF,this.forEach(e=>{e[O]?t.add(e.clone()):t.add(e)})),t}}function ej(e=-1){return function(t,i){let s=t.constructor,r=Object.getPrototypeOf(s)[Symbol.metadata],n=s[Symbol.metadata]??=Object.assign({},s[Symbol.metadata],r??Object.create(null));eg.setTag(n,i,e)}}function eL(e,t){return function(i,s){let r=i.constructor;if(!e)throw Error(`${r.name}: @type() reference provided for "${s}" is undefined. Make sure you don't have any circular dependencies.`);e=eu(e),ec.register(r);let n=Object.getPrototypeOf(r)[Symbol.metadata],o=eg.initialize(r),a=o[s];if(void 0!==o[a]){if(o[a].deprecated)return;if(void 0!==o[a].type)try{throw Error(`@colyseus/schema: Duplicate '${s}' definition on '${r.name}'.
Check @type() annotation`)}catch(t){let e=t.stack.split("\n")[4].trim();throw Error(`${t.message} ${e}`)}}else a=o[T]??(n&&n[T])??-1,a++;if(t&&t.manual)eg.addField(o,a,s,e,{enumerable:!0,configurable:!0,writable:!0});else{let t="string"==typeof Object.keys(e)[0]&&eh[Object.keys(e)[0]],i=t?Object.values(e)[0]:e;eg.addField(o,a,s,e,e_(`_${s}`,a,i,t))}}}function e_(t,i,s,r){return{get:function(){return this[t]},set:function(n){let o=this[t]??void 0;if(n!==o){if(null!=n){r?(r.constructor!==e$||n instanceof e$||(n=new e$(...n)),r.constructor!==ew||n instanceof ew||(n=new ew(n)),n[b]=s):"string"!=typeof s?eP(n,s,this,t.substring(1)):function(e,t,i,s){let r;let n=!1;switch(t){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":r="number",isNaN(e)&&console.log(`trying to encode "NaN" in ${i.constructor.name}#${s}`);break;case"bigint64":case"biguint64":r="bigint";break;case"string":r="string",n=!0;break;default:return}if(typeof e!==r&&(!n||n&&null!==e)){let t=`'${JSON.stringify(e)}'${e&&e.constructor&&` (${e.constructor.name})`||""}`;throw new eN(`a '${r}' was expected, but ${t} was provided in ${i.constructor.name}#${s}`)}}(n,s,this,t.substring(1));let a=this[O];void 0!==o&&o[O]?(a.root?.remove(o[O]),this.constructor[u](a,i,e.OPERATION.DELETE_AND_ADD)):this.constructor[u](a,i,e.OPERATION.ADD),n[O]?.setParent(this,a.root,i)}else void 0!==o&&this[O].delete(i);this[t]=n}},enumerable:!0,configurable:!0}}function ek(e){return Array(e).fill(0).map((t,i)=>i===e-1?`└─ `:"   ").join("")}ef("set",{constructor:eF});class eM{static{this[d]=eI}static{this[f]=ex}static initialize(e){Object.defineProperty(e,O,{value:new eO(e),enumerable:!1,writable:!0}),Object.defineProperties(e,e.constructor[Symbol.metadata]?.[A]||{})}static is(e){return"object"==typeof e[Symbol.metadata]}static[(d=g,f=m,u)](t,i,s=e.OPERATION.ADD){t.change(i,s)}static[p](e,t,i){let s=e.constructor[Symbol.metadata],r=s[t]?.tag;if(void 0===i)return void 0===r;if(void 0===r)return!0;if(-1===r)return i.isChangeTreeVisible(e[O]);{let t=i.tags?.get(e[O]);return t&&t.has(r)}}constructor(...e){eM.initialize(this),e[0]&&Object.assign(this,e[0])}assign(e){return Object.assign(this,e),this}setDirty(e,t){let i=this.constructor[Symbol.metadata];this[O].change(i[i[e]].index,t)}clone(){let e=new this.constructor,t=this.constructor[Symbol.metadata];for(let i in t){let s=t[i].name;"object"==typeof this[s]&&"function"==typeof this[s]?.clone?e[s]=this[s].clone():e[s]=this[s]}return e}toJSON(){let e={},t=this.constructor[Symbol.metadata];for(let i in t){let s=t[i],r=s.name;s.deprecated||null===this[r]||void 0===this[r]||(e[r]="function"==typeof this[r].toJSON?this[r].toJSON():this[r])}return e}discardAllChanges(){this[O].discardAll()}[E](e){return this[this.constructor[Symbol.metadata][e].name]}[y](e){this[this.constructor[Symbol.metadata][e].name]=void 0}static debugRefIds(e,t=!1,i=0,s,r=""){let n=t?` - ${JSON.stringify(e.toJSON())}`:"",o=e[O],a=s?s.root.refIds.get(e):o.refId,l=s?s.root:o.root,h=l?.refCount?.[a]>1?` [\xd7${l.refCount[a]}]`:"",d=`${ek(i)}${r}${e.constructor.name} (refId: ${a})${h}${n}
`;return o.forEachChild((r,n)=>{let o=n;"number"==typeof n&&e.$indexes&&(o=e.$indexes.get(n)??n);let a=void 0!==e.forEach&&void 0!==o?`["${o}"]: `:"";d+=this.debugRefIds(r.ref,t,i+1,s,a)}),d}static debugRefIdEncodingOrder(e,t="allChanges"){let i=[],s=e[O].root[t].next;for(;s;)s.changeTree&&i.push(s.changeTree.refId),s=s.next;return i}static debugRefIdsFromDecoder(e){return this.debugRefIds(e.state,!1,0,e)}static debugChanges(t,i=!1){let s=t[O],r=i?s.allChanges:s.changes,n=i?"allChanges":"changes",o=`${t.constructor.name} (${s.refId}) -> .${n}:
`;function a(t){t.operations.filter(e=>e).forEach(t=>{let r=s.indexedOperations[t];o+=`- [${t}]: ${e.OPERATION[r]} (${JSON.stringify(s.getValue(Number(t),i))})
`})}return a(r),!i&&s.filteredChanges&&s.filteredChanges.operations.filter(e=>e).length>0&&(o+=`${t.constructor.name} (${s.refId}) -> .filteredChanges:
`,a(s.filteredChanges)),i&&s.allFilteredChanges&&s.allFilteredChanges.operations.filter(e=>e).length>0&&(o+=`${t.constructor.name} (${s.refId}) -> .allFilteredChanges:
`,a(s.allFilteredChanges)),o}static debugChangesDeep(t,i="changes"){let s="",r=t[O],n=r.root,o=new Map,a=[],l=0;for(let[e,s]of Object.entries(n[i])){let i=n.changeTrees[e];if(!i)continue;let h=!1,d=[],f=i.parent?.[O];if(i===r)h=!0;else for(;void 0!==f;){if(d.push(f),f.ref===t){h=!0;break}f=f.parent?.[O]}h&&(a.push(i.refId),l+=Object.keys(s).length,o.set(i,d.reverse()))}s+=`---
root refId: ${r.refId}
Total instances: ${a.length} (refIds: ${a.join(", ")})
Total changes: ${l}
---
`;let h=new WeakSet;for(let[t,i]of o.entries()){i.forEach((e,t)=>{h.has(e)||(s+=`${ek(t)}${e.ref.constructor.name} (refId: ${e.refId})
`,h.add(e))});let r=t.indexedOperations,n=i.length,o=ek(n),a=n>0?`(${t.parentIndex}) `:"";for(let i in s+=`${o}${a}${t.ref.constructor.name} (refId: ${t.refId}) - changes: ${Object.keys(r).length}
`,r){let t=r[i];s+=`${ek(n+1)}${e.OPERATION[t]}: ${i}
`}}return`${s}`}}function eV(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o}"function"==typeof SuppressedError&&SuppressedError;class eB{constructor(e){this.types=e,this.nextUniqueId=0,this.refCount={},this.changeTrees={},this.allChanges=ep(),this.allFilteredChanges=ep(),this.changes=ep(),this.filteredChanges=ep()}getNextUniqueId(){return this.nextUniqueId++}add(t){void 0===t.refId&&(t.refId=this.getNextUniqueId());let i=void 0===this.changeTrees[t.refId];i&&(this.changeTrees[t.refId]=t);let s=this.refCount[t.refId];if(0===s){let i=t.allChanges.operations,s=i.length;for(;s--;)t.indexedOperations[i[s]]=e.OPERATION.ADD,eE(t.changes,s)}return this.refCount[t.refId]=(s||0)+1,i}remove(e){let t=this.refCount[e.refId]-1;return t<=0?(e.root=void 0,delete this.changeTrees[e.refId],this.removeChangeFromChangeSet("allChanges",e),this.removeChangeFromChangeSet("changes",e),e.filteredChanges&&(this.removeChangeFromChangeSet("allFilteredChanges",e),this.removeChangeFromChangeSet("filteredChanges",e)),this.refCount[e.refId]=0,e.forEachChild((t,i)=>{t.removeParent(e.ref)&&(void 0===t.parentChain||t.parentChain&&this.refCount[t.refId]>0?this.remove(t):t.parentChain&&this.moveNextToParent(t))})):(this.refCount[e.refId]=t,this.recursivelyMoveNextToParent(e)),t}recursivelyMoveNextToParent(e){this.moveNextToParent(e),e.forEachChild((e,t)=>this.recursivelyMoveNextToParent(e))}moveNextToParent(e){e.filteredChanges?(this.moveNextToParentInChangeTreeList("filteredChanges",e),this.moveNextToParentInChangeTreeList("allFilteredChanges",e)):(this.moveNextToParentInChangeTreeList("changes",e),this.moveNextToParentInChangeTreeList("allChanges",e))}moveNextToParentInChangeTreeList(e,t){let i=this[e],s=t[e].queueRootNode;if(!s)return;let r=t.parent;if(!r||!r[O])return;let n=r[O][e]?.queueRootNode;if(!n||n===s)return;let o=n.position;s.position>o||(s.prev?s.prev.next=s.next:i.next=s.next,s.next?s.next.prev=s.prev:i.tail=s.prev,s.prev=n,s.next=n.next,n.next?n.next.prev=s:i.tail=s,n.next=s,this.updatePositionsAfterMove(i,s,o+1))}enqueueChangeTree(e,t,i=e[t].queueRootNode){i||(e[t].queueRootNode=this.addToChangeTreeList(this[t],e))}addToChangeTreeList(e,t){let i={changeTree:t,next:void 0,prev:void 0,position:e.tail?e.tail.position+1:0};return e.next?(i.prev=e.tail,e.tail.next=i):e.next=i,e.tail=i,i}updatePositionsAfterRemoval(e,t){let i=e.next,s=0;for(;i;)s>=t&&(i.position=s),i=i.next,s++}updatePositionsAfterMove(e,t,i){let s=e.next,r=0;for(;s;)s.position=r,s=s.next,r++}removeChangeFromChangeSet(e,t){let i=this[e],s=t[e].queueRootNode;if(s&&s.changeTree===t){let r=s.position;return s.prev?s.prev.next=s.next:i.next=s.next,s.next?s.next.prev=s.prev:i.tail=s.prev,this.updatePositionsAfterRemoval(i,r),t[e].queueRootNode=void 0,!0}return!1}}class eq{static{this.BUFFER_SIZE=void 0!==s&&s.poolSize||8192}constructor(e){this.sharedBuffer=s.allocUnsafe(eq.BUFFER_SIZE),this.context=ec.cache(e.constructor),this.root=new eB(this.context),this.setState(e)}setState(e){this.state=e,this.state[O].setRoot(this.root)}encode(t={offset:0},i,r=this.sharedBuffer,n="changes",o="allChanges"===n,a=t.offset){let l=void 0!==i,h=this.state[O],d=this.root[n];for(;d=d.next;){let s=d.changeTree;if(l){if(!i.isChangeTreeVisible(s)){i.invisible.add(s);continue}i.invisible.delete(s)}let f=s[n],c=s.ref,u=f.operations.length;if(0===u)continue;let m=c.constructor,E=m[g],y=m[p],O=m[Symbol.metadata];(l||t.offset>a||s!==h)&&(r[t.offset++]=255,z.number(r,s.refId,t));for(let n=0;n<u;n++){let a=f.operations[n];if(a<0){r[t.offset++]=255&Math.abs(a);continue}let h=o?e.OPERATION.ADD:s.indexedOperations[a];void 0!==a&&void 0!==h&&(!y||y(c,a,i))&&E(this,r,s,a,h,t,o,l,O)}}if(!(t.offset>r.byteLength))return r.subarray(0,t.offset);{let e=Math.ceil(t.offset/(s.poolSize??8192))*(s.poolSize??8192);return console.warn(`@colyseus/schema buffer overflow. Encoded state is higher than default BUFFER_SIZE. Use the following to increase default BUFFER_SIZE:

    import { Encoder } from "@colyseus/schema";
    Encoder.BUFFER_SIZE = ${Math.round(e/1024)} * 1024; // ${Math.round(e/1024)} KB
`),(r=s.alloc(e,r))===this.sharedBuffer&&(this.sharedBuffer=r),this.encode({offset:a},i,r,n,o)}}encodeAll(e={offset:0},t=this.sharedBuffer){return this.encode(e,void 0,t,"allChanges",!0)}encodeAllView(e,t,i,r=this.sharedBuffer){let n=i.offset;return this.encode(i,e,r,"allFilteredChanges",!0,n),s.concat([r.subarray(0,t),r.subarray(n,i.offset)])}debugChanges(t){let i=("string"==typeof t?this.root[t]:t).next;for(;i;){let s=i.changeTree,r=s[t],n=s.ref.constructor[Symbol.metadata];for(let t in console.log("->",{ref:s.ref.constructor.name,refId:s.refId,changes:Object.keys(r).length}),r){let i=r[t];console.log("  ->",{index:t,field:n?.[t],op:e.OPERATION[i]})}i=i.next}}encodeView(t,i,r,n=this.sharedBuffer){let o=r.offset;for(let[i,s]of t.changes){let o=this.root.changeTrees[i];if(void 0===o){t.changes.delete(i);continue}let a=Object.keys(s);if(0===a.length)continue;let l=o.ref.constructor,h=l[g],d=l[Symbol.metadata];n[r.offset++]=255,z.number(n,o.refId,r);for(let t=0,i=a.length;t<i;t++){let i=Number(a[t]),l=void 0!==o.ref[E](i)&&s[i]||e.OPERATION.DELETE;h(this,n,o,i,l,r,!1,!0,d)}}return t.changes.clear(),this.encode(r,t,n,"filteredChanges",!1,o),s.concat([n.subarray(0,i),n.subarray(o,r.offset)])}discardChanges(){let e=this.root.changes.next;for(;e;)e.changeTree.endEncode("changes"),e=e.next;for(this.root.changes=ep(),e=this.root.filteredChanges.next;e;)e.changeTree.endEncode("filteredChanges"),e=e.next;this.root.filteredChanges=ep()}tryEncodeTypeId(e,t,i,s){let r=this.context.getTypeId(t),n=this.context.getTypeId(i);if(void 0===n){console.warn(`@colyseus/schema WARNING: Class "${i.name}" is not registered on TypeRegistry - Please either tag the class with @entity or define a @type() field.`);return}r!==n&&(e[s.offset++]=213,z.number(e,n,s))}get hasChanges(){return void 0!==this.root.changes.next||void 0!==this.root.filteredChanges.next}}function eJ(e,t){if(-1===t||t>=e.length)return!1;let i=e.length-1;for(let s=t;s<i;s++)e[s]=e[s+1];return e.length=i,!0}class ez extends Error{constructor(e){super(e),this.name="DecodingWarning"}}class eU{constructor(){this.refs=new Map,this.refIds=new WeakMap,this.refCount={},this.deletedRefs=new Set,this.callbacks={},this.nextUniqueId=0}getNextUniqueId(){return this.nextUniqueId++}addRef(e,t,i=!0){this.refs.set(e,t),this.refIds.set(t,e),i&&(this.refCount[e]=(this.refCount[e]||0)+1),this.deletedRefs.has(e)&&this.deletedRefs.delete(e)}removeRef(e){let t=this.refCount[e];if(void 0===t){try{throw new ez("trying to remove refId that doesn't exist: "+e)}catch(e){console.warn(e)}return}if(0===t){try{let t=this.refs.get(e);throw new ez(`trying to remove refId '${e}' with 0 refCount (${t.constructor.name}: ${JSON.stringify(t)})`)}catch(e){console.warn(e)}return}(this.refCount[e]=t-1)<=0&&this.deletedRefs.add(e)}clearRefs(){this.refs.clear(),this.deletedRefs.clear(),this.callbacks={},this.refCount={}}garbageCollectDeletedRefs(){this.deletedRefs.forEach(e=>{if(this.refCount[e]>0)return;let t=this.refs.get(e);if(void 0!==t.constructor[Symbol.metadata]){let e=t.constructor[Symbol.metadata];for(let i in e){let s=e[i].name,r="object"==typeof t[s]&&this.refIds.get(t[s]);r&&!this.deletedRefs.has(r)&&this.removeRef(r)}}else"function"==typeof t[b]&&Array.from(t.values()).forEach(e=>{let t=this.refIds.get(e);this.deletedRefs.has(t)||this.removeRef(t)});this.refs.delete(e),delete this.refCount[e],delete this.callbacks[e]}),this.deletedRefs.clear()}addCallback(t,i,s){if(void 0===t){let t="number"==typeof i?e.OPERATION[i]:i;throw Error(`Can't addCallback on '${t}' (refId is undefined)`)}return this.callbacks[t]||(this.callbacks[t]={}),this.callbacks[t][i]||(this.callbacks[t][i]=[]),this.callbacks[t][i].push(s),()=>this.removeCallback(t,i,s)}removeCallback(e,t,i){let s=this.callbacks?.[e]?.[t]?.indexOf(i);void 0!==s&&-1!==s&&eJ(this.callbacks[e][t],s)}}class eW{constructor(e,t){this.currentRefId=0,this.setState(e),this.context=t||new ec(e.constructor)}setState(e){this.state=e,this.root=new eU,this.root.addRef(0,e)}decode(e,t={offset:0},i=this.state){let s=[],r=this.root,n=e.byteLength,o=i.constructor[m];for(this.currentRefId=0;t.offset<n;){if(255==e[t.offset]){t.offset++,i[v]?.();let s=el.number(e,t),a=r.refs.get(s);a?(o=(i=a).constructor[m],this.currentRefId=s):(console.error(`"refId" not found: ${s}`,{previousRef:i,previousRefId:this.currentRefId}),console.warn("Please report this issue to the developers."),this.skipCurrentStructure(e,t,n));continue}if(-1===o(this,e,t,i,s)){console.warn("@colyseus/schema: definition mismatch"),this.skipCurrentStructure(e,t,n);continue}}return i[v]?.(),this.triggerChanges?.(s),r.garbageCollectDeletedRefs(),s}skipCurrentStructure(e,t,i){let s={offset:t.offset};for(;t.offset<i&&!(255===e[t.offset]&&(s.offset=t.offset+1,this.root.refs.has(el.number(e,s))));)t.offset++}getInstanceType(e,t,i){let s;if(213===e[t.offset]){t.offset++;let i=el.number(e,t);s=this.context.get(i)}return s||i}createInstanceOfType(e){return new e}removeChildRefs(t,i){let s="string"!=typeof t[b],r=this.root.refIds.get(t);t.forEach((n,o)=>{i.push({ref:t,refId:r,op:e.OPERATION.DELETE,field:o,value:void 0,previousValue:n}),s&&this.root.removeRef(this.root.refIds.get(n))})}}class eY extends eM{}eV([eL("string")],eY.prototype,"name",void 0),eV([eL("string")],eY.prototype,"type",void 0),eV([eL("number")],eY.prototype,"referencedType",void 0);class eZ extends eM{constructor(){super(...arguments),this.fields=new e$}}eV([eL("number")],eZ.prototype,"id",void 0),eV([eL("number")],eZ.prototype,"extendsId",void 0),eV([eL([eY])],eZ.prototype,"fields",void 0);class eG extends eM{constructor(){super(...arguments),this.types=new e$}static encode(e,t={offset:0}){let i=e.context,r=new eG,n=new eq(r),o=i.schemas.get(e.state.constructor);o>0&&(r.rootType=o);let a=new Set,l={},h=e=>{if(void 0===e.extendsId||a.has(e.extendsId)){a.add(e.id),r.types.push(e);let t=l[e.id];void 0!==t&&(delete l[e.id],t.forEach(e=>h(e)))}else void 0===l[e.extendsId]&&(l[e.extendsId]=[]),l[e.extendsId].push(e)};for(let e in i.schemas.forEach((e,t)=>{let s=new eZ;s.id=Number(e);let r=Object.getPrototypeOf(t);r!==eM&&(s.extendsId=i.schemas.get(r));let n=t[Symbol.metadata];if(n!==r[Symbol.metadata])for(let e in n){let t;let r=Number(e),o=n[r].name;if(!Object.prototype.hasOwnProperty.call(n,o))continue;let a=new eY;a.name=o;let l=n[r];if("string"==typeof l.type)t=l.type;else{let e;eM.is(l.type)?(t="ref",e=l.type):(t=Object.keys(l.type)[0],"string"==typeof l.type[t]?t+=":"+l.type[t]:e=l.type[t]),a.referencedType=e?i.getTypeId(e):-1}a.type=t,s.fields.push(a)}h(s)}),l)l[e].forEach(e=>r.types.push(e));let d=n.encodeAll(t);return s.from(d,0,t.offset)}static decode(e,t){let i=new eG;new eW(i).decode(e,t);let s=new ec;i.types.forEach(e=>{let t=s.get(e.extendsId)??eM,i=class extends t{};ec.register(i),s.add(i,e.id)},{});let r=(e,t,i)=>{t.fields.forEach((t,r)=>{let n=i+r;if(void 0!==t.referencedType){let i=t.type,r=s.get(t.referencedType);if(!r){let e=t.type.split(":");i=e[0],r=e[1]}"ref"===i?eg.addField(e,n,t.name,r):eg.addField(e,n,t.name,{[i]:r})}else eg.addField(e,n,t.name,t.type)})};return i.types.forEach(e=>{let t=s.get(e.id),n=eg.initialize(t),o=[],a=e;do o.push(a),a=i.types.find(e=>e.id===a.extendsId);while(a);let l=0;o.reverse().forEach(e=>{r(n,e,l),l+=e.fields.length})}),new eW(new(s.get(i.rootType||0)),s)}}eV([eL([eZ])],eG.prototype,"types",void 0),eV([eL("number")],eG.prototype,"rootType",void 0);class eK{constructor(e=!1){this.iterable=e,this.visible=new WeakSet,this.invisible=new WeakSet,this.changes=new Map,e&&(this.items=[])}add(t,i=-1,s=!0){let r=t?.[O],n=r.parent;if(!r)return console.warn("StateView#add(), invalid object:",t),!1;if(!n&&0!==r.refId)throw Error(`Cannot add a detached instance to the StateView. Make sure to assign the "${r.ref.constructor.name}" instance to the state before calling view.add()`);let o=t.constructor[Symbol.metadata];this.visible.add(r),this.iterable&&s&&this.items.push(t),s&&n&&this.addParentOf(r,i);let a=this.changes.get(r.refId);void 0===a&&(a={},this.changes.set(r.refId,a));let l=!1;if(r.forEachChild((e,t)=>{(!o||void 0===o[t].tag||o[t].tag===i)&&this.add(e.ref,i,!1)&&(l=!0)}),-1!==i){let t;this.tags||(this.tags=new WeakMap),this.tags.has(r)?t=this.tags.get(r):(t=new Set,this.tags.set(r,t)),t.add(i),o?.[R]?.[i]?.forEach(t=>{r.getChange(t)!==e.OPERATION.DELETE&&(a[t]=e.OPERATION.ADD)})}else if(!r.isNew||l){let t=void 0!==r.filteredChanges?r.allFilteredChanges:r.allChanges,s=this.invisible.has(r);for(let n=0,h=t.operations.length;n<h;n++){let h=t.operations[n];if(void 0===h)continue;let d=r.indexedOperations[h]??e.OPERATION.ADD,f=o?.[h].tag;d!==e.OPERATION.DELETE&&(s||void 0===f||f===i)&&(a[h]=d,l=!0)}}return l}addParentOf(t,i){let s=t.parent[O],r=t.parentIndex;if(!this.visible.has(s)){this.visible.add(s);let e=s.parent?.[O];e&&void 0!==e.filteredChanges&&this.addParentOf(s,i)}if(s.getChange(r)!==e.OPERATION.DELETE){let t,n=this.changes.get(s.refId);void 0===n&&(n={},this.changes.set(s.refId,n)),this.tags||(this.tags=new WeakMap),this.tags.has(s)?t=this.tags.get(s):(t=new Set,this.tags.set(s,t)),t.add(i),n[r]=e.OPERATION.ADD}}remove(t,i=-1,s=!1){let r=t[O];if(!r)return console.warn("StateView#remove(), invalid object:",t),this;this.visible.delete(r),this.iterable&&!s&&eJ(this.items,this.items.indexOf(t));let n=r.ref.constructor[Symbol.metadata],o=this.changes.get(r.refId);if(void 0===o&&(o={},this.changes.set(r.refId,o)),-1===i){let t=r.parent;if(t&&!eg.isValidInstance(t)&&r.isFiltered){let i=t[O],s=this.changes.get(i.refId);void 0===s?(s={},this.changes.set(i.refId,s)):s[r.parentIndex]===e.OPERATION.ADD&&this.changes.delete(r.refId),s[r.parentIndex]=e.OPERATION.DELETE,this._recursiveDeleteVisibleChangeTree(r)}else n?.[C]?.forEach(t=>o[t]=e.OPERATION.DELETE)}else n?.[R][i].forEach(t=>o[t]=e.OPERATION.DELETE);if(this.tags&&this.tags.has(r)){let e=this.tags.get(r);void 0===i?this.tags.delete(r):(e.delete(i),0===e.size&&this.tags.delete(r))}return this}has(e){return this.visible.has(e[O])}hasTag(e,t=-1){let i=this.tags?.get(e[O]);return i?.has(t)??!1}clear(){if(!this.iterable)throw Error("StateView#clear() is only available for iterable StateView's. Use StateView(iterable: true) constructor.");for(let e=0,t=this.items.length;e<t;e++)this.remove(this.items[e],-1,!0);this.items.length=0}isChangeTreeVisible(e){let t=this.visible.has(e);return!t&&e.isVisibilitySharedWithParent&&this.visible.has(e.parent[O])&&(this.visible.add(e),t=!0),t}_recursiveDeleteVisibleChangeTree(e){e.forEachChild(e=>{this.visible.delete(e),this._recursiveDeleteVisibleChangeTree(e)})}}ef("map",{constructor:ew}),ef("array",{constructor:e$}),ef("set",{constructor:eF}),ef("collection",{constructor:eS}),e.$changes=O,e.$childType=b,e.$decoder=m,e.$deleteByIndex=y,e.$encoder=g,e.$filter=p,e.$getByIndex=E,e.$track=u,e.ArraySchema=e$,e.ChangeTree=eO,e.CollectionSchema=eS,e.Decoder=eW,e.Encoder=eq,e.MapSchema=ew,e.Metadata=eg,e.Reflection=eG,e.ReflectionField=eY,e.ReflectionType=eZ,e.Schema=eM,e.SetSchema=eF,e.StateView=eK,e.TypeContext=ec,e.decode=el,e.decodeKeyValueOperation=eC,e.decodeSchemaOperation=ex,e.defineCustomTypes=function(e){for(let t in e)ef(t,e[t]);return e=>eL(e)},e.defineTypes=function(e,t,i){for(let s in t)eL(t[s],i)(e.prototype,s);return e},e.deprecated=function(e=!0){return function(t,i){let s=t.constructor,r=Object.getPrototypeOf(s)[Symbol.metadata],n=s[Symbol.metadata]??=Object.assign({},s[Symbol.metadata],r??Object.create(null)),o=n[i];n[o].deprecated=!0,e&&(n[A]??={},n[A][i]={get:function(){throw Error(`${i} is deprecated.`)},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(n,o,{value:n[o],enumerable:!1,configurable:!0})}},e.dumpChanges=function(t){let i=t[O].root,s={ops:{},refs:[]},r=i.changes.next;for(;r;){let t=r.changeTree;if(void 0===t){r=r.next;continue}let i=t.indexedOperations;for(let r in s.refs.push(`refId#${t.refId}`),i){let t=i[r],n=e.OPERATION[t];s.ops[n]||(s.ops[n]=0),s.ops[e.OPERATION[t]]++}r=r.next}return s},e.encode=z,e.encodeArray=eA,e.encodeKeyValueOperation=ev,e.encodeSchemaOperation=eI,e.entity=function(e){return ec.register(e),e},e.getDecoderStateCallbacks=function(t){let i;let s=t.root,r=s.callbacks,n=new WeakMap;return t.triggerChanges=function(t){let i=new Set;for(let n=0,o=t.length;n<o;n++){let o=t[n],a=o.refId,l=o.ref,h=r[a];if(h){if((o.op&e.OPERATION.DELETE)===e.OPERATION.DELETE&&o.previousValue instanceof eM){let t=r[s.refIds.get(o.previousValue)]?.[e.OPERATION.DELETE];for(let e=t?.length-1;e>=0;e--)t[e]()}if(l instanceof eM){if(!i.has(a)){let t=h?.[e.OPERATION.REPLACE];for(let e=t?.length-1;e>=0;e--)t[e]()}if(h.hasOwnProperty(o.field)){let e=h[o.field];for(let t=e?.length-1;t>=0;t--)e[t](o.value,o.previousValue)}}else{if((o.op&e.OPERATION.DELETE)===e.OPERATION.DELETE){if(void 0!==o.previousValue){let t=h[e.OPERATION.DELETE];for(let e=t?.length-1;e>=0;e--)t[e](o.previousValue,o.dynamicIndex??o.field)}if((o.op&e.OPERATION.ADD)===e.OPERATION.ADD){let t=h[e.OPERATION.ADD];for(let e=t?.length-1;e>=0;e--)t[e](o.value,o.dynamicIndex??o.field)}}else if((o.op&e.OPERATION.ADD)===e.OPERATION.ADD&&o.previousValue!==o.value){let t=h[e.OPERATION.ADD];for(let e=t?.length-1;e>=0;e--)t[e](o.value,o.dynamicIndex??o.field)}if(o.value!==o.previousValue&&(void 0!==o.value||void 0!==o.previousValue)){let t=h[e.OPERATION.REPLACE];for(let e=t?.length-1;e>=0;e--)t[e](o.value,o.dynamicIndex??o.field)}}i.add(a)}}},function t(r){return function r(o,a){let l=a.instance?.constructor[Symbol.metadata]||o,h=a.instance&&"function"==typeof a.instance.forEach||o&&void 0===o[Symbol.metadata];if(l&&!h){let o=function(e,t,r,o){return o&&void 0!==a.instance[t]&&!n.has(i)&&r(a.instance[t],void 0),s.addCallback(s.refIds.get(e),t,r)};return new Proxy({listen:function(e,t,s=!0){if(a.instance)return o(a.instance,e,t,s);{let r=()=>{};return a.onInstanceAvailable((a,l)=>{r=o(a,e,t,s&&l&&!n.has(i))}),()=>r()}},onChange:function(t){return s.addCallback(s.refIds.get(a.instance),e.OPERATION.REPLACE,t)},bindTo:function(t,i){return i||(i=Object.keys(l).map(e=>l[e].name)),s.addCallback(s.refIds.get(a.instance),e.OPERATION.REPLACE,()=>{i.forEach(e=>t[e]=a.instance[e])})}},{get(e,i){let n=l[l[i]];if(!n)return e[i];{let e=a.instance?.[i];return r(n.type,{instance:s.refIds.get(e)&&e,parentInstance:a.instance,onInstanceAvailable:r=>{let n=t(a.instance).listen(i,(e,t)=>{r(e,!1),n?.()},!1);void 0!==s.refIds.get(e)&&r(e,!0)}})}},has:(e,t)=>void 0!==l[t],set(e,t,i){throw Error("not allowed")},deleteProperty(e,t){throw Error("not allowed")}})}{let t=function(t,r,o){return o&&t.forEach((e,t)=>r(e,t)),s.addCallback(s.refIds.get(t),e.OPERATION.ADD,(e,t)=>{n.set(r,!0),i=r,r(e,t),n.delete(r),i=void 0})},r=function(t,i){return s.addCallback(s.refIds.get(t),e.OPERATION.DELETE,i)},o=function(t,i){return s.addCallback(s.refIds.get(t),e.OPERATION.REPLACE,i)};return new Proxy({onAdd:function(e,s=!0){if(a.instance)return t(a.instance,e,s&&!n.has(i));if(a.onInstanceAvailable){let r=()=>{};return a.onInstanceAvailable((o,a)=>{r=t(o,e,s&&a&&!n.has(i))}),()=>r()}},onRemove:function(e){if(a.instance)return r(a.instance,e);if(a.onInstanceAvailable){let t=()=>{};return a.onInstanceAvailable(i=>{t=r(i,e)}),()=>t()}},onChange:function(e){if(a.instance)return o(a.instance,e);if(a.onInstanceAvailable){let t=()=>{};return a.onInstanceAvailable(i=>{t=o(i,e)}),()=>t()}}},{get(e,t){if(!e[t])throw Error(`Can't access '${t}' through callback proxy. access the instance directly.`);return e[t]},has:(e,t)=>void 0!==e[t],set(e,t,i){throw Error("not allowed")},deleteProperty(e,t){throw Error("not allowed")}})}}(void 0,{instance:r})}},e.getRawChangesCallback=function(e,t){e.triggerChanges=t},e.registerType=ef,e.schema=function e(t,i,s=eM){let r={},n={},o={},a={};for(let e in t){let i=t[e];"object"==typeof i?(void 0!==i.view&&(a[e]="boolean"==typeof i.view?-1:i.view),r[e]=eu(i),Object.prototype.hasOwnProperty.call(i,"default")?o[e]=i.default:Array.isArray(i)||void 0!==i.array?o[e]=new e$:void 0!==i.map?o[e]=new ew:void 0!==i.collection?o[e]=new eS:void 0!==i.set?o[e]=new eF:void 0!==i.type&&eM.is(i.type)&&(o[e]=new i.type)):"function"==typeof i?eM.is(i)?(o[e]=new i,r[e]=eu(i)):n[e]=i:r[e]=eu(i)}let l=()=>{let e={};for(let t in o){let i=o[t];i&&"function"==typeof i.clone?e[t]=i.clone():e[t]=i}return e},h=eg.setFields(class extends s{constructor(...e){e[0]=Object.assign({},l(),e[0]),super(...e)}},r);for(let e in a)ej(a[e])(h.prototype,e);for(let e in n)h.prototype[e]=n[e];return i&&Object.defineProperty(h,"name",{value:i}),h.extends=(t,i)=>e(t,i,h),h},e.type=eL,e.view=ej}(t)}}]);