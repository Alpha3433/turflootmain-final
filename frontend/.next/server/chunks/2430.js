"use strict";exports.id=2430,exports.ids=[2430],exports.modules={22430:(e,t,r)=>{let s,i,n,o,a,l,h,c,u,f,d,p,g;r.d(t,{joinArena:()=>sr});var m,y,b,_,v,w,E,S,x,C,k,I,O,T,A,D,$,R,N,L,P,M,B,U,j,F,V,W,z,q,H={};r.r(H),r.d(H,{del:()=>rQ,get:()=>rY,patch:()=>rX,post:()=>rZ,put:()=>r0,send:()=>rK}),ArrayBuffer.isView||(ArrayBuffer.isView=e=>null!==e&&"object"==typeof e&&e.buffer instanceof ArrayBuffer),"undefined"==typeof FormData&&(global.FormData=class{}),"undefined"==typeof globalThis&&"undefined"!=typeof window&&(window.globalThis=window),function(e){e[e.CONSENTED=4e3]="CONSENTED",e[e.DEVMODE_RESTART=4010]="DEVMODE_RESTART"}(w||(w={}));class G extends Error{code;constructor(e,t){super(t),this.name="ServerError",this.code=e}}class J extends Error{constructor(e){super(e),this.name="AbortError"}}(function(e){e[e.ADD=128]="ADD",e[e.REPLACE=0]="REPLACE",e[e.DELETE=64]="DELETE",e[e.DELETE_AND_MOVE=96]="DELETE_AND_MOVE",e[e.MOVE_AND_ADD=160]="MOVE_AND_ADD",e[e.DELETE_AND_ADD=192]="DELETE_AND_ADD",e[e.CLEAR=10]="CLEAR",e[e.REVERSE=15]="REVERSE",e[e.MOVE=32]="MOVE",e[e.DELETE_BY_REFID=33]="DELETE_BY_REFID",e[e.ADD_BY_REFID=129]="ADD_BY_REFID"})(E||(E={})),Symbol.metadata??=Symbol.for("Symbol.metadata");let K="~track",Y="~encoder",Z="~decoder",X="~filter",Q="~getByIndex",ee="~deleteByIndex",et="~changes",er="~childType",es="~onEncodeEnd",ei="~onDecodeEnd",en="~descriptors",eo="~__numFields",ea="~__refTypeFieldIndexes",el="~__viewFieldIndexes",eh="$__fieldIndexesByViewTag";try{new TextEncoder}catch(e){}let ec=new ArrayBuffer(8),eu=new Int32Array(ec),ef=new Float32Array(ec),ed=new Float64Array(ec),ep=new BigInt64Array(ec),eg="undefined"!=typeof Buffer&&Buffer.byteLength?Buffer.byteLength:function(e,t){for(var r=0,s=0,i=0,n=e.length;i<n;i++)(r=e.charCodeAt(i))<128?s+=1:r<2048?s+=2:r<55296||r>=57344?s+=3:(i++,s+=4);return s};function em(e,t,r){for(var s=0,i=0,n=t.length;i<n;i++)(s=t.charCodeAt(i))<128?e[r.offset++]=s:s<2048?(e[r.offset]=192|s>>6,e[r.offset+1]=128|63&s,r.offset+=2):s<55296||s>=57344?(e[r.offset]=224|s>>12,e[r.offset+1]=128|s>>6&63,e[r.offset+2]=128|63&s,r.offset+=3):(i++,s=65536+((1023&s)<<10|1023&t.charCodeAt(i)),e[r.offset]=240|s>>18,e[r.offset+1]=128|s>>12&63,e[r.offset+2]=128|s>>6&63,e[r.offset+3]=128|63&s,r.offset+=4)}function ey(e,t,r){e[r.offset++]=255&t}function eb(e,t,r){e[r.offset++]=255&t,e[r.offset++]=t>>8&255}function e_(e,t,r){e[r.offset++]=255&t,e[r.offset++]=t>>8&255}function ev(e,t,r){e[r.offset++]=255&t,e[r.offset++]=t>>8&255,e[r.offset++]=t>>16&255,e[r.offset++]=t>>24&255}function ew(e,t,r){e[r.offset++]=255&t,e[r.offset++]=255&t>>8,e[r.offset++]=255&t>>16,e[r.offset++]=255&t>>24}function eE(e,t,r){ew(e,t>>>0,r),ew(e,Math.floor(t/4294967296),r)}function eS(e,t,r){ew(e,t>>>0,r),ew(e,t/4294967296>>0,r)}function ex(e,t,r){ef[0]=t,ev(e,eu[0],r)}function eC(e,t,r){ed[0]=t,ev(e,eu[0],r),ev(e,eu[1],r)}let ek={int8:ey,uint8:function(e,t,r){e[r.offset++]=255&t},int16:eb,uint16:e_,int32:ev,uint32:ew,int64:eE,uint64:eS,bigint64:function(e,t,r){ep[0]=BigInt.asIntN(64,t),ev(e,eu[0],r),ev(e,eu[1],r)},biguint64:function(e,t,r){ep[0]=BigInt.asIntN(64,t),ev(e,eu[0],r),ev(e,eu[1],r)},float32:ex,float64:eC,boolean:function(e,t,r){e[r.offset++]=t?1:0},string:function(e,t,r){t||(t="");let s=eg(t,"utf8"),i=0;if(s<32)e[r.offset++]=160|s,i=1;else if(s<256)e[r.offset++]=217,e[r.offset++]=s%255,i=2;else if(s<65536)e[r.offset++]=218,e_(e,s,r),i=3;else if(s<4294967296)e[r.offset++]=219,ew(e,s,r),i=5;else throw Error("String too long");return em(e,t,r),i+s},number:function e(t,r,s){return isNaN(r)?e(t,0,s):isFinite(r)?r!==(0|r)?34028235e31>=Math.abs(r)&&(ef[0]=r,1e-4>Math.abs(Math.abs(ef[0])-Math.abs(r)))?(t[s.offset++]=202,ex(t,r,s),5):(t[s.offset++]=203,eC(t,r,s),9):r>=0?r<128?(t[s.offset++]=255&r,1):r<256?(t[s.offset++]=204,t[s.offset++]=255&r,2):r<65536?(t[s.offset++]=205,e_(t,r,s),3):r<4294967296?(t[s.offset++]=206,ew(t,r,s),5):(t[s.offset++]=207,eS(t,r,s),9):r>=-32?(t[s.offset++]=224|r+32,1):r>=-128?(t[s.offset++]=208,ey(t,r,s),2):r>=-32768?(t[s.offset++]=209,eb(t,r,s),3):r>=-2147483648?(t[s.offset++]=210,ev(t,r,s),5):(t[s.offset++]=211,eE(t,r,s),9):e(t,r>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER,s)},utf8Write:em,utf8Length:eg},eI=new ArrayBuffer(8),eO=new Int32Array(eI),eT=new Float32Array(eI),eA=new Float64Array(eI),eD=new BigUint64Array(eI),e$=new BigInt64Array(eI);function eR(e,t,r){for(var s="",i=0,n=t.offset,o=t.offset+r;n<o;n++){var a=e[n];if((128&a)==0){s+=String.fromCharCode(a);continue}if((224&a)==192){s+=String.fromCharCode((31&a)<<6|63&e[++n]);continue}if((240&a)==224){s+=String.fromCharCode((15&a)<<12|(63&e[++n])<<6|(63&e[++n])<<0);continue}if((248&a)==240){(i=(7&a)<<18|(63&e[++n])<<12|(63&e[++n])<<6|(63&e[++n])<<0)>=65536?(i-=65536,s+=String.fromCharCode((i>>>10)+55296,(1023&i)+56320)):s+=String.fromCharCode(i);continue}console.error("Invalid byte "+a.toString(16))}return t.offset+=r,s}function eN(e,t){return eL(e,t)<<24>>24}function eL(e,t){return e[t.offset++]}function eP(e,t){return eM(e,t)<<16>>16}function eM(e,t){return e[t.offset++]|e[t.offset++]<<8}function eB(e,t){return e[t.offset++]|e[t.offset++]<<8|e[t.offset++]<<16|e[t.offset++]<<24}function eU(e,t){return eB(e,t)>>>0}function ej(e,t){return eO[0]=eB(e,t),eT[0]}function eF(e,t){return eO[0]=eB(e,t),eO[1]=eB(e,t),eA[0]}function eV(e,t){let r=eU(e,t);return 4294967296*eB(e,t)+r}function eW(e,t){let r=eU(e,t);return 4294967296*eU(e,t)+r}let ez={utf8Read:eR,int8:eN,uint8:eL,int16:eP,uint16:eM,int32:eB,uint32:eU,float32:ej,float64:eF,int64:eV,uint64:eW,bigint64:function(e,t){return eO[0]=eB(e,t),eO[1]=eB(e,t),e$[0]},biguint64:function(e,t){return eO[0]=eB(e,t),eO[1]=eB(e,t),eD[0]},boolean:function(e,t){return eL(e,t)>0},string:function(e,t){let r;let s=e[t.offset++];return s<192?r=31&s:217===s?r=eL(e,t):218===s?r=eM(e,t):219===s&&(r=eU(e,t)),eR(e,t,r)},number:function(e,t){let r=e[t.offset++];if(r<128)return r;if(202===r)return ej(e,t);if(203===r)return eF(e,t);if(204===r)return eL(e,t);if(205===r)return eM(e,t);if(206===r)return eU(e,t);if(207===r)return eW(e,t);else if(208===r)return eN(e,t);else if(209===r)return eP(e,t);else if(210===r)return eB(e,t);else if(211===r)return eV(e,t);else if(r>223)return-((255-r+1)*1)},stringCheck:function(e,t){let r=e[t.offset];return r<192&&r>160||217===r||218===r||219===r}},eq={},eH=new Map;function eG(e,t){t.constructor&&(eH.set(t.constructor,e),eq[e]=t),t.encode&&(ek[e]=t.encode),t.decode&&(ez[e]=t.decode)}class eJ{static{this.inheritedTypes=new Map}static{this.cachedContexts=new Map}static register(e){let t=Object.getPrototypeOf(e);if(t!==tc){let r=eJ.inheritedTypes.get(t);r||(r=new Set,eJ.inheritedTypes.set(t,r)),r.add(e)}}static cache(e){let t=eJ.cachedContexts.get(e);return t||(t=new eJ(e),eJ.cachedContexts.set(e,t)),t}constructor(e){this.types={},this.schemas=new Map,this.hasFilters=!1,this.parentFiltered={},e&&this.discoverTypes(e)}has(e){return this.schemas.has(e)}get(e){return this.types[e]}add(e,t=this.schemas.size){return!this.schemas.has(e)&&(this.types[t]=e,void 0===e[Symbol.metadata]&&eY.initialize(e),this.schemas.set(e,t),!0)}getTypeId(e){return this.schemas.get(e)}discoverTypes(e,t,r,s){if(s&&this.registerFilteredByParent(e,t,r),!this.add(e))return;eJ.inheritedTypes.get(e)?.forEach(e=>{this.discoverTypes(e,t,r,s)});let i=e;for(;(i=Object.getPrototypeOf(i))&&i!==tc&&i!==Function.prototype;)this.discoverTypes(i);let n=e[Symbol.metadata]??={};for(let t in n[el]&&(this.hasFilters=!0),n){let r=n[t].type,i=void 0!==n[t].tag;if("string"!=typeof r){if("function"==typeof r)this.discoverTypes(r,e,t,s||i);else{let n=Object.values(r)[0];if("string"==typeof n)continue;this.discoverTypes(n,e,t,s||i)}}}}registerFilteredByParent(e,t,r){let s=this.schemas.get(e)??this.schemas.size,i=`${s}`;t&&(i+=`-${this.schemas.get(t)}`),i+=`-${r}`,this.parentFiltered[i]=!0}debug(){let e="";for(let t in this.parentFiltered){let r=t.split("-").map(Number),s=r.pop();e+=`
		${t}: ${r.reverse().map((e,t)=>{let r=this.types[e],i=r[Symbol.metadata],n=r.name;return 0===t&&(n+=`[${i[s].name}]`),`${n}`}).join(" -> ")}`}return`TypeContext ->
	Schema types: ${this.schemas.size}
	hasFilters: ${this.hasFilters}
	parentFiltered:${e}`}}function eK(e){if(Array.isArray(e))return{array:eK(e[0])};if(void 0!==e.type)return e.type;if(function(e){if("function"==typeof e&&e[Symbol.metadata])return!1;let t=Object.keys(e),r=t.filter(e=>/\d+/.test(e));return!!(r.length>0&&r.length===t.length/2&&e[e[r[0]]]==r[0]||t.length>0&&t.every(t=>"string"==typeof e[t]&&e[t]===t))}(e))return Object.keys(e).every(t=>"string"==typeof e[t])?"string":"number";if("object"==typeof e&&null!==e){let t=Object.keys(e).find(e=>void 0!==eq[e]);t&&(e[t]=eK(e[t]))}return e}let eY={addField(e,t,r,s,i){if(t>64)throw Error(`Can't define field '${r}'.
Schema instances may only have up to 64 fields.`);e[t]=Object.assign(e[t]||{},{type:eK(s),index:t,name:r}),Object.defineProperty(e,en,{value:e[en]||{},enumerable:!1,configurable:!0}),i?(e[en][r]=i,e[en][`_${r}`]={value:void 0,writable:!0,enumerable:!1,configurable:!0}):e[en][r]={value:void 0,writable:!0,enumerable:!0,configurable:!0},Object.defineProperty(e,eo,{value:t,enumerable:!1,configurable:!0}),Object.defineProperty(e,r,{value:t,enumerable:!1,configurable:!0}),"string"!=typeof e[t].type&&(void 0===e[ea]&&Object.defineProperty(e,ea,{value:[],enumerable:!1,configurable:!0}),e[ea].push(t))},setTag(e,t,r){let s=e[t];e[s].tag=r,e[el]||(Object.defineProperty(e,el,{value:[],enumerable:!1,configurable:!0}),Object.defineProperty(e,eh,{value:{},enumerable:!1,configurable:!0})),e[el].push(s),e[eh][r]||(e[eh][r]=[]),e[eh][r].push(s)},setFields(e,t){let r=e.prototype.constructor;eJ.register(r);let s=Object.getPrototypeOf(r),i=s&&s[Symbol.metadata],n=eY.initialize(r);r[K]||(r[K]=tc[K]),r[Y]||(r[Y]=tc[Y]),r[Z]||(r[Z]=tc[Z]),r.prototype.toJSON||(r.prototype.toJSON=tc.prototype.toJSON);let o=n[eo]??(i&&i[eo])??-1;for(let e in o++,t){let r=eK(t[e]),s="string"==typeof Object.keys(r)[0]&&eq[Object.keys(r)[0]],i=s?Object.values(r)[0]:r;eY.addField(n,o,e,r,tl(`_${e}`,o,i,s)),o++}return e},isDeprecated:(e,t)=>!0===e[t].deprecated,init(e){let t={};e[Symbol.metadata]=t,Object.defineProperty(t,eo,{value:0,enumerable:!1,configurable:!0})},initialize(e){let t=Object.getPrototypeOf(e),r=t[Symbol.metadata],s=e[Symbol.metadata]??Object.create(null);return t!==tc&&s===r&&(s=Object.create(null),r&&(Object.setPrototypeOf(s,r),Object.defineProperty(s,eo,{value:r[eo],enumerable:!1,configurable:!0,writable:!0}),void 0!==r[el]&&(Object.defineProperty(s,el,{value:[...r[el]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(s,eh,{value:{...r[eh]},enumerable:!1,configurable:!0,writable:!0})),void 0!==r[ea]&&Object.defineProperty(s,ea,{value:[...r[ea]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(s,en,{value:{...r[en]},enumerable:!1,configurable:!0,writable:!0}))),e[Symbol.metadata]=s,s},isValidInstance:e=>e.constructor[Symbol.metadata]&&Object.prototype.hasOwnProperty.call(e.constructor[Symbol.metadata],eo),getFields(e){let t=e[Symbol.metadata],r={};for(let e=0;e<=t[eo];e++)r[t[e].name]=t[e].type;return r},hasViewTagAtIndex:(e,t)=>e?.[el]?.includes(t)};function eZ(e){return{indexes:{},operations:[],queueRootNode:e}}function eX(){return{next:void 0,tail:void 0}}function eQ(e,t){let r=e.indexes[t];void 0===r?e.indexes[t]=e.operations.push(t)-1:e.operations[r]=t}function e0(e,t){let r=e.indexes[t];void 0===r&&(r=Object.values(e.indexes).at(-1),t=Object.entries(e.indexes).find(([e,t])=>t===r)?.[0]),e.operations[r]=void 0,delete e.indexes[t]}class e1{constructor(e){this.isFiltered=!1,this.indexedOperations={},this.changes={indexes:{},operations:[]},this.allChanges={indexes:{},operations:[]},this.isNew=!0,this.ref=e,this.metadata=e.constructor[Symbol.metadata],this.metadata?.[el]&&(this.allFilteredChanges={indexes:{},operations:[]},this.filteredChanges={indexes:{},operations:[]})}setRoot(e){this.root=e;let t=this.root.add(this);this.checkIsFiltered(this.parent,this.parentIndex,t),t&&this.forEachChild((t,r)=>{t.root!==e?t.setRoot(e):e.add(t)})}setParent(e,t,r){if(this.addParent(e,r),!t)return;let s=t.add(this);t!==this.root&&(this.root=t,this.checkIsFiltered(e,r,s)),s&&this.forEachChild((e,r)=>{if(e.root===t){t.add(e),t.moveNextToParent(e);return}e.setParent(this.ref,t,r)})}forEachChild(e){if(this.ref[er]){if("string"!=typeof this.ref[er])for(let[t,r]of this.ref.entries())e(r[et],this.indexes?.[t]??t)}else for(let t of this.metadata?.[ea]??[]){let r=this.metadata[t],s=this.ref[r.name];s&&e(s[et],t)}}operation(e){void 0!==this.filteredChanges?(this.filteredChanges.operations.push(-e),this.root?.enqueueChangeTree(this,"filteredChanges")):(this.changes.operations.push(-e),this.root?.enqueueChangeTree(this,"changes"))}change(e,t=E.ADD){let r=this.isFiltered||this.metadata?.[e]?.tag!==void 0,s=r?this.filteredChanges:this.changes,i=this.indexedOperations[e];if(!i||i===E.DELETE){let r=i&&i===E.DELETE?E.DELETE_AND_ADD:t;this.indexedOperations[e]=r}eQ(s,e),r?(eQ(this.allFilteredChanges,e),this.root&&(this.root.enqueueChangeTree(this,"filteredChanges"),this.root.enqueueChangeTree(this,"allFilteredChanges"))):(eQ(this.allChanges,e),this.root?.enqueueChangeTree(this,"changes"))}shiftChangeIndexes(e){let t=this.isFiltered?this.filteredChanges:this.changes,r={},s={};for(let i in this.indexedOperations)r[Number(i)+e]=this.indexedOperations[i],s[Number(i)+e]=t.indexes[i];this.indexedOperations=r,t.indexes=s,t.operations=t.operations.map(t=>t+e)}shiftAllChangeIndexes(e,t=0){void 0!==this.filteredChanges&&this._shiftAllChangeIndexes(e,t,this.allFilteredChanges),this._shiftAllChangeIndexes(e,t,this.allChanges)}_shiftAllChangeIndexes(e,t=0,r){let s={},i=0;for(let e in r.indexes)s[i++]=r.indexes[e];r.indexes=s;for(let s=0;s<r.operations.length;s++){let i=r.operations[s];i>t&&(r.operations[s]=i+e)}}indexedOperation(e,t,r=e){this.indexedOperations[e]=t,void 0!==this.filteredChanges?(eQ(this.allFilteredChanges,r),eQ(this.filteredChanges,e),this.root?.enqueueChangeTree(this,"filteredChanges")):(eQ(this.allChanges,r),eQ(this.changes,e),this.root?.enqueueChangeTree(this,"changes"))}getType(e){return this.ref[er]||this.metadata[e].type}getChange(e){return this.indexedOperations[e]}getValue(e,t=!1){return this.ref[Q](e,t)}delete(e,t,r=e){if(void 0===e){try{throw Error(`@colyseus/schema ${this.ref.constructor.name}: trying to delete non-existing index '${e}'`)}catch(e){console.warn(e)}return}let s=void 0!==this.filteredChanges?this.filteredChanges:this.changes;this.indexedOperations[e]=t??E.DELETE,eQ(s,e),e0(this.allChanges,r);let i=this.getValue(e);return i&&i[et]&&this.root?.remove(i[et]),void 0!==this.filteredChanges?(e0(this.allFilteredChanges,r),this.root?.enqueueChangeTree(this,"filteredChanges")):this.root?.enqueueChangeTree(this,"changes"),i}endEncode(e){this.indexedOperations={},this[e]=eZ(),this.ref[es]?.(),this.isNew=!1}discard(e=!1){this.ref[es]?.(),this.indexedOperations={},this.changes=eZ(this.changes.queueRootNode),void 0!==this.filteredChanges&&(this.filteredChanges=eZ(this.filteredChanges.queueRootNode)),e&&(this.allChanges=eZ(this.allChanges.queueRootNode),void 0!==this.allFilteredChanges&&(this.allFilteredChanges=eZ(this.allFilteredChanges.queueRootNode)))}discardAll(){let e=Object.keys(this.indexedOperations);for(let t=0,r=e.length;t<r;t++){let r=this.getValue(Number(e[t]));r&&r[et]&&r[et].discardAll()}this.discard()}get changed(){return Object.entries(this.indexedOperations).length>0}checkIsFiltered(e,t,r){this.root.types.hasFilters&&(this._checkFilteredByParent(e,t),void 0!==this.filteredChanges&&(this.root?.enqueueChangeTree(this,"filteredChanges"),r&&this.root?.enqueueChangeTree(this,"allFilteredChanges"))),!this.isFiltered&&(this.root?.enqueueChangeTree(this,"changes"),r&&this.root?.enqueueChangeTree(this,"allChanges"))}_checkFilteredByParent(e,t){let r;if(!e)return;let s=eY.isValidInstance(this.ref)?this.ref.constructor:this.ref[er],i=!eY.isValidInstance(e);i?(e=(r=e[et]).parent,t=r.parentIndex):r=e[et];let n=e.constructor,o=`${this.root.types.getTypeId(s)}`;n&&(o+=`-${this.root.types.schemas.get(n)}`),o+=`-${t}`;let a=eY.hasViewTagAtIndex(n?.[Symbol.metadata],t);this.isFiltered=e[et].isFiltered||this.root.types.parentFiltered[o]||a,this.isFiltered&&(this.isVisibilitySharedWithParent=r.isFiltered&&"string"!=typeof s&&!a&&i,this.filteredChanges||(this.filteredChanges=eZ(),this.allFilteredChanges=eZ()),this.changes.operations.length>0&&(this.changes.operations.forEach(e=>eQ(this.filteredChanges,e)),this.allChanges.operations.forEach(e=>eQ(this.allFilteredChanges,e)),this.changes=eZ(),this.allChanges=eZ()))}get parent(){return this.parentChain?.ref}get parentIndex(){return this.parentChain?.index}addParent(e,t){if(this.hasParent((t,r)=>t[et]===e[et])){this.parentChain.index=t;return}this.parentChain={ref:e,index:t,next:this.parentChain}}removeParent(e=this.parent){let t=this.parentChain,r=null;for(;t;){if(t.ref[et]===e[et])return r?r.next=t.next:this.parentChain=t.next,!0;r=t,t=t.next}return void 0===this.parentChain}findParent(e){let t=this.parentChain;for(;t;){if(e(t.ref,t.index))return t;t=t.next}}hasParent(e){return void 0!==this.findParent(e)}getAllParents(){let e=[],t=this.parentChain;for(;t;)e.push({ref:t.ref,index:t.index}),t=t.next;return e}}function e2(e,t,r,s,i,n){"string"==typeof r?ek[r]?.(t,s,n):void 0!==r[Symbol.metadata]?(ek.number(t,s[et].refId,n),(i&E.ADD)===E.ADD&&e.tryEncodeTypeId(t,r,s.constructor,n)):ek.number(t,s[et].refId,n)}let e6=function(e,t,r,s,i,n,o,a,l){if(t[n.offset++]=(s|i)&255,i===E.DELETE)return;let h=r.ref,c=l[s];e2(e,t,l[s].type,h[c.name],i,n)},e4=function(e,t,r,s,i,n){if(t[n.offset++]=255&i,ek.number(t,s,n),i===E.DELETE)return;let o=r.ref;if((i&E.ADD)===E.ADD&&"function"==typeof o.set){let e=r.ref.$indexes.get(s);ek.string(t,e,n)}e2(e,t,o[er],o[Q](s),i,n)},e3=function(e,t,r,s,i,n,o,a){let l;let h=r.ref;if(a&&r.isFiltered&&"string"!=typeof r.getType(s)){let e=h.tmpItems[s];if(!e)return;l=e[et].refId,i===E.DELETE?i=E.DELETE_BY_REFID:i===E.ADD&&(i=E.ADD_BY_REFID)}else l=s;t[n.offset++]=255&i,ek.number(t,l,n),i!==E.DELETE&&i!==E.DELETE_BY_REFID&&e2(e,t,r.getType(s),r.getValue(s,o),i,n)};function e8(e,t,r,s,i,n,o,a){let l;let h=e.root,c=r[Q](s);if((t&E.DELETE)===E.DELETE){let e=h.refIds.get(c);void 0!==e&&h.removeRef(e),t!==E.DELETE_AND_ADD&&r[ee](s),l=void 0}if(t===E.DELETE);else if(tc.is(i)){let r=ez.number(n,o);if(l=h.refs.get(r),(t&E.ADD)===E.ADD){let s=e.getInstanceType(n,o,i);l||(l=e.createInstanceOfType(s)),h.addRef(r,l,l!==c||t===E.DELETE_AND_ADD&&l===c)}}else if("string"==typeof i)l=ez[i](n,o);else{let e=eq[Object.keys(i)[0]],r=ez.number(n,o),s=h.refs.has(r)?c||h.refs.get(r):new e.constructor;if((l=s.clone(!0))[er]=Object.values(i)[0],c){let e=h.refIds.get(c);if(void 0!==e&&r!==e){let t;let r=c.entries();for(;(t=r.next())&&!t.done;){let[r,s]=t.value;"object"==typeof s&&(e=h.refIds.get(s),h.removeRef(e)),a.push({ref:c,refId:e,op:E.DELETE,field:r,value:void 0,previousValue:s})}}}h.addRef(r,l,s!==c||t===E.DELETE_AND_ADD&&s===c)}return{value:l,previousValue:c}}let e5=function(e,t,r,s,i){let n=t[r.offset++],o=s.constructor[Symbol.metadata],a=n>>6<<6,l=n%(a||255),h=o[l];if(void 0===h)return console.warn("@colyseus/schema: field not defined at",{index:l,ref:s.constructor.name,metadata:o}),-1;let{value:c,previousValue:u}=e8(e,a,s,l,h.type,t,r,i);null!=c&&(s[h.name]=c),u!==c&&i.push({ref:s,refId:e.currentRefId,op:a,field:h.name,value:c,previousValue:u})},e9=function(e,t,r,s,i){let n;let o=t[r.offset++];if(o===E.CLEAR){e.removeChildRefs(s,i),s.clear();return}let a=ez.number(t,r),l=s[er];(o&E.ADD)===E.ADD?"function"==typeof s.set?(n=ez.string(t,r),s.setIndex(a,n)):n=a:n=s.getIndex(a);let{value:h,previousValue:c}=e8(e,o,s,a,l,t,r,i);if(null!=h){if("function"==typeof s.set)s.$items.set(n,h);else if("function"==typeof s.$setAt)s.$setAt(a,h,o);else if("function"==typeof s.add){let e=s.add(h);"number"==typeof e&&s.setIndex(e,e)}}c!==h&&i.push({ref:s,refId:e.currentRefId,op:o,field:"",dynamicIndex:n,value:h,previousValue:c})},e7=function(e,t,r,s,i){let n,o=t[r.offset++];if(o===E.CLEAR){e.removeChildRefs(s,i),s.clear();return}if(o===E.REVERSE){s.reverse();return}if(o===E.DELETE_BY_REFID){let o=ez.number(t,r),a=e.root.refs.get(o);n=s.findIndex(e=>e===a),s[ee](n),i.push({ref:s,refId:e.currentRefId,op:E.DELETE,field:"",dynamicIndex:n,value:void 0,previousValue:a});return}if(o===E.ADD_BY_REFID){let i=ez.number(t,r),o=e.root.refs.get(i);o&&(n=s.findIndex(e=>e===o)),(-1===n||void 0===n)&&(n=s.length)}else n=ez.number(t,r);let a=s[er],l=n,{value:h,previousValue:c}=e8(e,o,s,n,a,t,r,i);null!=h&&h!==c&&s.$setAt(n,h,o),c!==h&&i.push({ref:s,refId:e.currentRefId,op:o,field:"",dynamicIndex:l,value:h,previousValue:c})};class te extends Error{}function tt(e,t,r,s){if(!(e instanceof t))throw new te(`a '${t.name}' was expected, but '${e&&e.constructor.name}' was provided in ${r.constructor.name}#${s}`)}let tr=(e,t)=>{let r=e.toString(),s=t.toString();return r<s?-1:r>s?1:0};class ts{static{this[S]=e3}static{this[x]=e7}static[(S=Y,x=Z,X)](e,t,r){return!r||"string"==typeof e[er]||r.isChangeTreeVisible(e.tmpItems[t]?.[et])}static is(e){return Array.isArray(e)||void 0!==e.array}static from(e){return new ts(...Array.from(e))}constructor(...e){this.items=[],this.tmpItems=[],this.deletedIndexes={},this.isMovingItems=!1,Object.defineProperty(this,er,{value:void 0,enumerable:!1,writable:!0,configurable:!0});let t=new Proxy(this,{get:(e,t)=>"symbol"==typeof t||isNaN(t)?Reflect.get(e,t):this.items[t],set:(e,t,r)=>{if("symbol"==typeof t||isNaN(t))return Reflect.set(e,t,r);if(null==r)e.$deleteAt(t);else{if(r[et]){tt(r,e[er],e,t);let s=e.items[t];e.isMovingItems?(void 0!==s?r[et].isNew?e[et].indexedOperation(Number(t),E.MOVE_AND_ADD):(e[et].getChange(Number(t))&E.DELETE)===E.DELETE?e[et].indexedOperation(Number(t),E.DELETE_AND_MOVE):e[et].indexedOperation(Number(t),E.MOVE):r[et].isNew&&e[et].indexedOperation(Number(t),E.ADD),r[et].setParent(this,e[et].root,t)):e.$changeAt(Number(t),r),void 0!==s&&s[et].root?.remove(s[et])}else e.$changeAt(Number(t),r);e.items[t]=r,e.tmpItems[t]=r}return!0},deleteProperty:(e,t)=>("number"==typeof t?e.$deleteAt(t):delete e[t],!0),has:(e,t)=>"symbol"==typeof t||isNaN(Number(t))?Reflect.has(e,t):Reflect.has(this.items,t)});return Object.defineProperty(this,et,{value:new e1(t),enumerable:!1,writable:!0}),e.length>0&&this.push(...e),t}set length(e){0===e?this.clear():e<this.items.length?this.splice(e,this.length-e):console.warn("ArraySchema: can't set .length to a higher value than its length.")}get length(){return this.items.length}push(...e){let t=this.tmpItems.length,r=this[et];for(let s=0,i=e.length;s<i;s++,t++){let i=e[s];if(null==i)return;"object"==typeof i&&this[er]&&tt(i,this[er],this,s),r.indexedOperation(t,E.ADD,this.items.length),this.items.push(i),this.tmpItems.push(i),i[et]?.setParent(this,r.root,t)}return t}pop(){let e=-1;for(let t=this.tmpItems.length-1;t>=0;t--)if(!0!==this.deletedIndexes[t]){e=t;break}if(!(e<0))return this[et].delete(e,void 0,this.items.length-1),this.deletedIndexes[e]=!0,this.items.pop()}at(e){return e<0&&(e+=this.length),this.items[e]}$changeAt(e,t){if(null==t){console.error("ArraySchema items cannot be null nor undefined; Use `deleteAt(index)` instead.");return}if(this.items[e]===t)return;let r=void 0!==this.items[e]?"object"==typeof t?E.DELETE_AND_ADD:E.REPLACE:E.ADD,s=this[et];s.change(e,r),t[et]?.setParent(this,s.root,e)}$deleteAt(e,t){this[et].delete(e,t)}$setAt(e,t,r){0===e&&r===E.ADD&&void 0!==this.items[e]?this.items.unshift(t):(r===E.DELETE_AND_MOVE&&this.items.splice(e,1),this.items[e]=t)}clear(){if(0===this.items.length)return;let e=this[et];e.forEachChild((t,r)=>{e.root?.remove(t)}),e.discard(!0),e.operation(E.CLEAR),this.items.length=0,this.tmpItems.length=0}concat(...e){return new ts(...this.items.concat(...e))}join(e){return this.items.join(e)}reverse(){return this[et].operation(E.REVERSE),this.items.reverse(),this.tmpItems.reverse(),this}shift(){if(0===this.items.length)return;let e=this[et],t=this.tmpItems.findIndex(e=>e===this.items[0]),r=this.items.findIndex(e=>e===this.items[0]);return e.delete(t,E.DELETE,r),e.shiftAllChangeIndexes(-1,r),this.deletedIndexes[t]=!0,this.items.shift()}slice(e,t){let r=new ts;return r.push(...this.items.slice(e,t)),r}sort(e=tr){this.isMovingItems=!0;let t=this[et];return this.items.sort(e).forEach((e,r)=>t.change(r,E.REPLACE)),this.tmpItems.sort(e),this.isMovingItems=!1,this}splice(e,t,...r){let s=this[et],i=this.items.length,n=this.tmpItems.length,o=r.length,a=[];for(let e=0;e<n;e++)!0!==this.deletedIndexes[e]&&a.push(e);if(i>e){void 0===t&&(t=i-e);for(let r=e;r<e+t;r++){let e=a[r];s.delete(e,E.DELETE),this.deletedIndexes[e]=!0}}else t=0;if(o>0){if(o>t)throw console.error("Inserting more elements than deleting during ArraySchema#splice()"),Error("ArraySchema#splice(): insertCount must be equal or lower than deleteCount.");for(let t=0;t<o;t++){let n=(a[e]??i)+t;s.indexedOperation(n,this.deletedIndexes[n]?E.DELETE_AND_ADD:E.ADD),r[t][et]?.setParent(this,s.root,n)}}return t>o&&s.shiftAllChangeIndexes(-(t-o),a[e+o]),void 0!==s.filteredChanges?s.root?.enqueueChangeTree(s,"filteredChanges"):s.root?.enqueueChangeTree(s,"changes"),this.items.splice(e,t,...r)}unshift(...e){let t=this[et];return t.shiftChangeIndexes(e.length),t.isFiltered?eQ(t.filteredChanges,this.items.length):eQ(t.allChanges,this.items.length),e.forEach((e,r)=>{t.change(r,E.ADD)}),this.tmpItems.unshift(...e),this.items.unshift(...e)}indexOf(e,t){return this.items.indexOf(e,t)}lastIndexOf(e,t=this.length-1){return this.items.lastIndexOf(e,t)}every(e,t){return this.items.every(e,t)}some(e,t){return this.items.some(e,t)}forEach(e,t){return this.items.forEach(e,t)}map(e,t){return this.items.map(e,t)}filter(e,t){return this.items.filter(e,t)}reduce(e,t){return this.items.reduce(e,t)}reduceRight(e,t){return this.items.reduceRight(e,t)}find(e,t){return this.items.find(e,t)}findIndex(e,t){return this.items.findIndex(e,t)}fill(e,t,r){throw Error("ArraySchema#fill() not implemented")}copyWithin(e,t,r){throw Error("ArraySchema#copyWithin() not implemented")}toString(){return this.items.toString()}toLocaleString(){return this.items.toLocaleString()}[Symbol.iterator](){return this.items[Symbol.iterator]()}static get[Symbol.species](){return ts}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}includes(e,t){return this.items.includes(e,t)}flatMap(e,t){throw Error("ArraySchema#flatMap() is not supported.")}flat(e){throw Error("ArraySchema#flat() is not supported.")}findLast(){return this.items.findLast.apply(this.items,arguments)}findLastIndex(...e){return this.items.findLastIndex.apply(this.items,arguments)}with(e,t){let r=this.items.slice();return e<0&&(e+=this.length),r[e]=t,new ts(...r)}toReversed(){return this.items.slice().reverse()}toSorted(e){return this.items.slice().sort(e)}toSpliced(e,t,...r){return this.items.toSpliced.apply(copy,arguments)}shuffle(){return this.move(e=>{let t=this.items.length;for(;0!=t;){let e=Math.floor(Math.random()*t);t--,[this[t],this[e]]=[this[e],this[t]]}})}move(e){return this.isMovingItems=!0,e(this),this.isMovingItems=!1,this}[Q](e,t=!1){return t?this.items[e]:this.deletedIndexes[e]?this.items[e]:this.tmpItems[e]||this.items[e]}[ee](e){this.items[e]=void 0,this.tmpItems[e]=void 0}[es](){this.tmpItems=this.items.slice(),this.deletedIndexes={}}[ei](){this.items=this.items.filter(e=>void 0!==e),this.tmpItems=this.items.slice()}toArray(){return this.items.slice(0)}toJSON(){return this.toArray().map(e=>"function"==typeof e.toJSON?e.toJSON():e)}clone(e){let t;return e?(t=new ts).push(...this.items):t=new ts(...this.map(e=>e[et]?e.clone():e)),t}}eG("array",{constructor:ts});class ti{static{this[C]=e4}static{this[k]=e9}static[(C=Y,k=Z,X)](e,t,r){return!r||"string"==typeof e[er]||r.isChangeTreeVisible((e[Q](t)??e.deletedItems[t])[et])}static is(e){return void 0!==e.map}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={};let t=new e1(this);if(t.indexes={},Object.defineProperty(this,et,{value:t,enumerable:!1,writable:!0}),e){if(e instanceof Map||e instanceof ti)e.forEach((e,t)=>this.set(t,e));else for(let t in e)this.set(t,e[t])}Object.defineProperty(this,er,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}[Symbol.iterator](){return this.$items[Symbol.iterator]()}get[Symbol.toStringTag](){return this.$items[Symbol.toStringTag]}static get[Symbol.species](){return ti}set(e,t){let r,s;if(null==t)throw Error(`MapSchema#set('${e}', ${t}): trying to set ${t} value on '${e}'.`);"object"==typeof t&&this[er]&&tt(t,this[er],this,e),e=e.toString();let i=this[et],n=void 0!==t[et];if(void 0!==i.indexes[e]){r=i.indexes[e],s=E.REPLACE;let o=this.$items.get(e);if(o===t)return;n&&(s=E.DELETE_AND_ADD,void 0!==o&&o[et].root?.remove(o[et])),this.deletedItems[r]&&delete this.deletedItems[r]}else r=i.indexes[eo]??0,s=E.ADD,this.$indexes.set(r,e),i.indexes[e]=r,i.indexes[eo]=r+1;return this.$items.set(e,t),i.change(r,s),n&&t[et].setParent(this,i.root,r),this}get(e){return this.$items.get(e)}delete(e){let t=this[et].indexes[e];return this.deletedItems[t]=this[et].delete(t),this.$items.delete(e)}clear(){let e=this[et];e.discard(!0),e.indexes={},e.forEachChild((t,r)=>{e.root?.remove(t)}),this.$indexes.clear(),this.$items.clear(),e.operation(E.CLEAR)}has(e){return this.$items.has(e)}forEach(e){this.$items.forEach(e)}entries(){return this.$items.entries()}keys(){return this.$items.keys()}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[Q](e){return this.$items.get(this.$indexes.get(e))}[ee](e){let t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[es](){let e=this[et];for(let t in this.deletedItems){let r=parseInt(t),s=this.$indexes.get(r);delete e.indexes[s],this.$indexes.delete(r)}this.deletedItems={}}toJSON(){let e={};return this.forEach((t,r)=>{e[r]="function"==typeof t.toJSON?t.toJSON():t}),e}clone(e){let t;return e?t=Object.assign(new ti,this):(t=new ti,this.forEach((e,r)=>{e[et]?t.set(r,e.clone()):t.set(r,e)})),t}}eG("map",{constructor:ti});class tn{static{this[I]=e4}static{this[O]=e9}static[(I=Y,O=Z,X)](e,t,r){return!r||"string"==typeof e[er]||r.isChangeTreeVisible((e[Q](t)??e.deletedItems[t])[et])}static is(e){return void 0!==e.collection}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[et]=new e1(this),this[et].indexes={},e&&e.forEach(e=>this.add(e)),Object.defineProperty(this,er,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(e){let t=this.$refId++;return void 0!==e[et]&&e[et].setParent(this,this[et].root,t),this[et].indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,e),this[et].change(t),t}at(e){let t=Array.from(this.$items.keys())[e];return this.$items.get(t)}entries(){return this.$items.entries()}delete(e){let t,r;let s=this.$items.entries();for(;(r=s.next())&&!r.done;)if(e===r.value[1]){t=r.value[0];break}return void 0!==t&&(this.deletedItems[t]=this[et].delete(t),this.$indexes.delete(t),this.$items.delete(t))}clear(){let e=this[et];e.discard(!0),e.indexes={},e.forEachChild((t,r)=>{e.root?.remove(t)}),this.$indexes.clear(),this.$items.clear(),e.operation(E.CLEAR)}has(e){return Array.from(this.$items.values()).some(t=>t===e)}forEach(e){this.$items.forEach((t,r,s)=>e(t,r,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[Q](e){return this.$items.get(this.$indexes.get(e))}[ee](e){let t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[es](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){let e=[];return this.forEach((t,r)=>{e.push("function"==typeof t.toJSON?t.toJSON():t)}),e}clone(e){let t;return e?t=Object.assign(new tn,this):(t=new tn,this.forEach(e=>{e[et]?t.add(e.clone()):t.add(e)})),t}}eG("collection",{constructor:tn});class to{static{this[T]=e4}static{this[A]=e9}static[(T=Y,A=Z,X)](e,t,r){return!r||"string"==typeof e[er]||r.visible.has((e[Q](t)??e.deletedItems[t])[et])}static is(e){return void 0!==e.set}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[et]=new e1(this),this[et].indexes={},e&&e.forEach(e=>this.add(e)),Object.defineProperty(this,er,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(e){if(this.has(e))return!1;let t=this.$refId++;void 0!==e[et]&&e[et].setParent(this,this[et].root,t);let r=this[et].indexes[t]?.op??E.ADD;return this[et].indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,e),this[et].change(t,r),t}entries(){return this.$items.entries()}delete(e){let t,r;let s=this.$items.entries();for(;(r=s.next())&&!r.done;)if(e===r.value[1]){t=r.value[0];break}return void 0!==t&&(this.deletedItems[t]=this[et].delete(t),this.$indexes.delete(t),this.$items.delete(t))}clear(){let e=this[et];e.discard(!0),e.indexes={},this.$indexes.clear(),this.$items.clear(),e.operation(E.CLEAR)}has(e){let t;let r=this.$items.values(),s=!1;for(;(t=r.next())&&!t.done;)if(e===t.value){s=!0;break}return s}forEach(e){this.$items.forEach((t,r,s)=>e(t,r,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[Q](e){return this.$items.get(this.$indexes.get(e))}[ee](e){let t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[es](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){let e=[];return this.forEach((t,r)=>{e.push("function"==typeof t.toJSON?t.toJSON():t)}),e}clone(e){let t;return e?t=Object.assign(new to,this):(t=new to,this.forEach(e=>{e[et]?t.add(e.clone()):t.add(e)})),t}}function ta(e,t){return function(r,s){let i=r.constructor;if(!e)throw Error(`${i.name}: @type() reference provided for "${s}" is undefined. Make sure you don't have any circular dependencies.`);e=eK(e),eJ.register(i);let n=Object.getPrototypeOf(i)[Symbol.metadata],o=eY.initialize(i),a=o[s];if(void 0!==o[a]){if(o[a].deprecated)return;if(void 0!==o[a].type)try{throw Error(`@colyseus/schema: Duplicate '${s}' definition on '${i.name}'.
Check @type() annotation`)}catch(t){let e=t.stack.split("\n")[4].trim();throw Error(`${t.message} ${e}`)}}else a=o[eo]??(n&&n[eo])??-1,a++;if(t&&t.manual)eY.addField(o,a,s,e,{enumerable:!0,configurable:!0,writable:!0});else{let t="string"==typeof Object.keys(e)[0]&&eq[Object.keys(e)[0]],r=t?Object.values(e)[0]:e;eY.addField(o,a,s,e,tl(`_${s}`,a,r,t))}}}function tl(e,t,r,s){return{get:function(){return this[e]},set:function(i){let n=this[e]??void 0;if(i!==n){if(null!=i){s?(s.constructor!==ts||i instanceof ts||(i=new ts(...i)),s.constructor!==ti||i instanceof ti||(i=new ti(i)),i[er]=r):"string"!=typeof r?tt(i,r,this,e.substring(1)):function(e,t,r,s){let i;let n=!1;switch(t){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":i="number",isNaN(e)&&console.log(`trying to encode "NaN" in ${r.constructor.name}#${s}`);break;case"bigint64":case"biguint64":i="bigint";break;case"string":i="string",n=!0;break;default:return}if(typeof e!==i&&(!n||n&&null!==e)){let t=`'${JSON.stringify(e)}'${e&&e.constructor&&` (${e.constructor.name})`||""}`;throw new te(`a '${i}' was expected, but ${t} was provided in ${r.constructor.name}#${s}`)}}(i,r,this,e.substring(1));let o=this[et];void 0!==n&&n[et]?(o.root?.remove(n[et]),this.constructor[K](o,t,E.DELETE_AND_ADD)):this.constructor[K](o,t,E.ADD),i[et]?.setParent(this,o.root,t)}else void 0!==n&&this[et].delete(t);this[e]=i}},enumerable:!0,configurable:!0}}function th(e){return Array(e).fill(0).map((t,r)=>r===e-1?`└─ `:"   ").join("")}eG("set",{constructor:to});class tc{static{this[D]=e6}static{this[$]=e5}static initialize(e){Object.defineProperty(e,et,{value:new e1(e),enumerable:!1,writable:!0}),Object.defineProperties(e,e.constructor[Symbol.metadata]?.[en]||{})}static is(e){return"object"==typeof e[Symbol.metadata]}static[(D=Y,$=Z,K)](e,t,r=E.ADD){e.change(t,r)}static[X](e,t,r){let s=e.constructor[Symbol.metadata],i=s[t]?.tag;if(void 0===r)return void 0===i;if(void 0===i)return!0;if(-1===i)return r.isChangeTreeVisible(e[et]);{let t=r.tags?.get(e[et]);return t&&t.has(i)}}constructor(...e){tc.initialize(this),e[0]&&Object.assign(this,e[0])}assign(e){return Object.assign(this,e),this}setDirty(e,t){let r=this.constructor[Symbol.metadata];this[et].change(r[r[e]].index,t)}clone(){let e=new this.constructor,t=this.constructor[Symbol.metadata];for(let r in t){let s=t[r].name;"object"==typeof this[s]&&"function"==typeof this[s]?.clone?e[s]=this[s].clone():e[s]=this[s]}return e}toJSON(){let e={},t=this.constructor[Symbol.metadata];for(let r in t){let s=t[r],i=s.name;s.deprecated||null===this[i]||void 0===this[i]||(e[i]="function"==typeof this[i].toJSON?this[i].toJSON():this[i])}return e}discardAllChanges(){this[et].discardAll()}[Q](e){return this[this.constructor[Symbol.metadata][e].name]}[ee](e){this[this.constructor[Symbol.metadata][e].name]=void 0}static debugRefIds(e,t=!1,r=0,s,i=""){let n=t?` - ${JSON.stringify(e.toJSON())}`:"",o=e[et],a=s?s.root.refIds.get(e):o.refId,l=s?s.root:o.root,h=l?.refCount?.[a]>1?` [\xd7${l.refCount[a]}]`:"",c=`${th(r)}${i}${e.constructor.name} (refId: ${a})${h}${n}
`;return o.forEachChild((i,n)=>{let o=n;"number"==typeof n&&e.$indexes&&(o=e.$indexes.get(n)??n);let a=void 0!==e.forEach&&void 0!==o?`["${o}"]: `:"";c+=this.debugRefIds(i.ref,t,r+1,s,a)}),c}static debugRefIdEncodingOrder(e,t="allChanges"){let r=[],s=e[et].root[t].next;for(;s;)s.changeTree&&r.push(s.changeTree.refId),s=s.next;return r}static debugRefIdsFromDecoder(e){return this.debugRefIds(e.state,!1,0,e)}static debugChanges(e,t=!1){let r=e[et],s=t?r.allChanges:r.changes,i=t?"allChanges":"changes",n=`${e.constructor.name} (${r.refId}) -> .${i}:
`;function o(e){e.operations.filter(e=>e).forEach(e=>{let s=r.indexedOperations[e];n+=`- [${e}]: ${E[s]} (${JSON.stringify(r.getValue(Number(e),t))})
`})}return o(s),!t&&r.filteredChanges&&r.filteredChanges.operations.filter(e=>e).length>0&&(n+=`${e.constructor.name} (${r.refId}) -> .filteredChanges:
`,o(r.filteredChanges)),t&&r.allFilteredChanges&&r.allFilteredChanges.operations.filter(e=>e).length>0&&(n+=`${e.constructor.name} (${r.refId}) -> .allFilteredChanges:
`,o(r.allFilteredChanges)),n}static debugChangesDeep(e,t="changes"){let r="",s=e[et],i=s.root,n=new Map,o=[],a=0;for(let[r,l]of Object.entries(i[t])){let t=i.changeTrees[r];if(!t)continue;let h=!1,c=[],u=t.parent?.[et];if(t===s)h=!0;else for(;void 0!==u;){if(c.push(u),u.ref===e){h=!0;break}u=u.parent?.[et]}h&&(o.push(t.refId),a+=Object.keys(l).length,n.set(t,c.reverse()))}r+=`---
root refId: ${s.refId}
Total instances: ${o.length} (refIds: ${o.join(", ")})
Total changes: ${a}
---
`;let l=new WeakSet;for(let[e,t]of n.entries()){t.forEach((e,t)=>{l.has(e)||(r+=`${th(t)}${e.ref.constructor.name} (refId: ${e.refId})
`,l.add(e))});let s=e.indexedOperations,i=t.length,n=th(i),o=i>0?`(${e.parentIndex}) `:"";for(let t in r+=`${n}${o}${e.ref.constructor.name} (refId: ${e.refId}) - changes: ${Object.keys(s).length}
`,s){let e=s[t];r+=`${th(i+1)}${E[e]}: ${t}
`}}return`${r}`}}function tu(e,t,r,s){var i,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(n<3?i(o):n>3?i(t,r,o):i(t,r))||o);return n>3&&o&&Object.defineProperty(t,r,o),o}"function"==typeof SuppressedError&&SuppressedError;class tf{constructor(e){this.types=e,this.nextUniqueId=0,this.refCount={},this.changeTrees={},this.allChanges=eX(),this.allFilteredChanges=eX(),this.changes=eX(),this.filteredChanges=eX()}getNextUniqueId(){return this.nextUniqueId++}add(e){void 0===e.refId&&(e.refId=this.getNextUniqueId());let t=void 0===this.changeTrees[e.refId];t&&(this.changeTrees[e.refId]=e);let r=this.refCount[e.refId];if(0===r){let t=e.allChanges.operations,r=t.length;for(;r--;)e.indexedOperations[t[r]]=E.ADD,eQ(e.changes,r)}return this.refCount[e.refId]=(r||0)+1,t}remove(e){let t=this.refCount[e.refId]-1;return t<=0?(e.root=void 0,delete this.changeTrees[e.refId],this.removeChangeFromChangeSet("allChanges",e),this.removeChangeFromChangeSet("changes",e),e.filteredChanges&&(this.removeChangeFromChangeSet("allFilteredChanges",e),this.removeChangeFromChangeSet("filteredChanges",e)),this.refCount[e.refId]=0,e.forEachChild((t,r)=>{t.removeParent(e.ref)&&(void 0===t.parentChain||t.parentChain&&this.refCount[t.refId]>0?this.remove(t):t.parentChain&&this.moveNextToParent(t))})):(this.refCount[e.refId]=t,this.recursivelyMoveNextToParent(e)),t}recursivelyMoveNextToParent(e){this.moveNextToParent(e),e.forEachChild((e,t)=>this.recursivelyMoveNextToParent(e))}moveNextToParent(e){e.filteredChanges?(this.moveNextToParentInChangeTreeList("filteredChanges",e),this.moveNextToParentInChangeTreeList("allFilteredChanges",e)):(this.moveNextToParentInChangeTreeList("changes",e),this.moveNextToParentInChangeTreeList("allChanges",e))}moveNextToParentInChangeTreeList(e,t){let r=this[e],s=t[e].queueRootNode;if(!s)return;let i=t.parent;if(!i||!i[et])return;let n=i[et][e]?.queueRootNode;if(!n||n===s)return;let o=n.position;s.position>o||(s.prev?s.prev.next=s.next:r.next=s.next,s.next?s.next.prev=s.prev:r.tail=s.prev,s.prev=n,s.next=n.next,n.next?n.next.prev=s:r.tail=s,n.next=s,this.updatePositionsAfterMove(r,s,o+1))}enqueueChangeTree(e,t,r=e[t].queueRootNode){r||(e[t].queueRootNode=this.addToChangeTreeList(this[t],e))}addToChangeTreeList(e,t){let r={changeTree:t,next:void 0,prev:void 0,position:e.tail?e.tail.position+1:0};return e.next?(r.prev=e.tail,e.tail.next=r):e.next=r,e.tail=r,r}updatePositionsAfterRemoval(e,t){let r=e.next,s=0;for(;r;)s>=t&&(r.position=s),r=r.next,s++}updatePositionsAfterMove(e,t,r){let s=e.next,i=0;for(;s;)s.position=i,s=s.next,i++}removeChangeFromChangeSet(e,t){let r=this[e],s=t[e].queueRootNode;if(s&&s.changeTree===t){let i=s.position;return s.prev?s.prev.next=s.next:r.next=s.next,s.next?s.next.prev=s.prev:r.tail=s.prev,this.updatePositionsAfterRemoval(r,i),t[e].queueRootNode=void 0,!0}return!1}}class td{static{this.BUFFER_SIZE="undefined"!=typeof Buffer&&Buffer.poolSize||8192}constructor(e){this.sharedBuffer=Buffer.allocUnsafe(td.BUFFER_SIZE),this.context=eJ.cache(e.constructor),this.root=new tf(this.context),this.setState(e)}setState(e){this.state=e,this.state[et].setRoot(this.root)}encode(e={offset:0},t,r=this.sharedBuffer,s="changes",i="allChanges"===s,n=e.offset){let o=void 0!==t,a=this.state[et],l=this.root[s];for(;l=l.next;){let h=l.changeTree;if(o){if(!t.isChangeTreeVisible(h)){t.invisible.add(h);continue}t.invisible.delete(h)}let c=h[s],u=h.ref,f=c.operations.length;if(0===f)continue;let d=u.constructor,p=d[Y],g=d[X],m=d[Symbol.metadata];(o||e.offset>n||h!==a)&&(r[e.offset++]=255,ek.number(r,h.refId,e));for(let s=0;s<f;s++){let n=c.operations[s];if(n<0){r[e.offset++]=255&Math.abs(n);continue}let a=i?E.ADD:h.indexedOperations[n];void 0!==n&&void 0!==a&&(!g||g(u,n,t))&&p(this,r,h,n,a,e,i,o,m)}}if(!(e.offset>r.byteLength))return r.subarray(0,e.offset);{let o=Math.ceil(e.offset/(Buffer.poolSize??8192))*(Buffer.poolSize??8192);return console.warn(`@colyseus/schema buffer overflow. Encoded state is higher than default BUFFER_SIZE. Use the following to increase default BUFFER_SIZE:

    import { Encoder } from "@colyseus/schema";
    Encoder.BUFFER_SIZE = ${Math.round(o/1024)} * 1024; // ${Math.round(o/1024)} KB
`),(r=Buffer.alloc(o,r))===this.sharedBuffer&&(this.sharedBuffer=r),this.encode({offset:n},t,r,s,i)}}encodeAll(e={offset:0},t=this.sharedBuffer){return this.encode(e,void 0,t,"allChanges",!0)}encodeAllView(e,t,r,s=this.sharedBuffer){let i=r.offset;return this.encode(r,e,s,"allFilteredChanges",!0,i),Buffer.concat([s.subarray(0,t),s.subarray(i,r.offset)])}debugChanges(e){let t=("string"==typeof e?this.root[e]:e).next;for(;t;){let r=t.changeTree,s=r[e],i=r.ref.constructor[Symbol.metadata];for(let e in console.log("->",{ref:r.ref.constructor.name,refId:r.refId,changes:Object.keys(s).length}),s){let t=s[e];console.log("  ->",{index:e,field:i?.[e],op:E[t]})}t=t.next}}encodeView(e,t,r,s=this.sharedBuffer){let i=r.offset;for(let[t,i]of e.changes){let n=this.root.changeTrees[t];if(void 0===n){e.changes.delete(t);continue}let o=Object.keys(i);if(0===o.length)continue;let a=n.ref.constructor,l=a[Y],h=a[Symbol.metadata];s[r.offset++]=255,ek.number(s,n.refId,r);for(let e=0,t=o.length;e<t;e++){let t=Number(o[e]),a=void 0!==n.ref[Q](t)&&i[t]||E.DELETE;l(this,s,n,t,a,r,!1,!0,h)}}return e.changes.clear(),this.encode(r,e,s,"filteredChanges",!1,i),Buffer.concat([s.subarray(0,t),s.subarray(i,r.offset)])}discardChanges(){let e=this.root.changes.next;for(;e;)e.changeTree.endEncode("changes"),e=e.next;for(this.root.changes=eX(),e=this.root.filteredChanges.next;e;)e.changeTree.endEncode("filteredChanges"),e=e.next;this.root.filteredChanges=eX()}tryEncodeTypeId(e,t,r,s){let i=this.context.getTypeId(t),n=this.context.getTypeId(r);if(void 0===n){console.warn(`@colyseus/schema WARNING: Class "${r.name}" is not registered on TypeRegistry - Please either tag the class with @entity or define a @type() field.`);return}i!==n&&(e[s.offset++]=213,ek.number(e,n,s))}get hasChanges(){return void 0!==this.root.changes.next||void 0!==this.root.filteredChanges.next}}class tp extends Error{constructor(e){super(e),this.name="DecodingWarning"}}class tg{constructor(){this.refs=new Map,this.refIds=new WeakMap,this.refCount={},this.deletedRefs=new Set,this.callbacks={},this.nextUniqueId=0}getNextUniqueId(){return this.nextUniqueId++}addRef(e,t,r=!0){this.refs.set(e,t),this.refIds.set(t,e),r&&(this.refCount[e]=(this.refCount[e]||0)+1),this.deletedRefs.has(e)&&this.deletedRefs.delete(e)}removeRef(e){let t=this.refCount[e];if(void 0===t){try{throw new tp("trying to remove refId that doesn't exist: "+e)}catch(e){console.warn(e)}return}if(0===t){try{let t=this.refs.get(e);throw new tp(`trying to remove refId '${e}' with 0 refCount (${t.constructor.name}: ${JSON.stringify(t)})`)}catch(e){console.warn(e)}return}(this.refCount[e]=t-1)<=0&&this.deletedRefs.add(e)}clearRefs(){this.refs.clear(),this.deletedRefs.clear(),this.callbacks={},this.refCount={}}garbageCollectDeletedRefs(){this.deletedRefs.forEach(e=>{if(this.refCount[e]>0)return;let t=this.refs.get(e);if(void 0!==t.constructor[Symbol.metadata]){let e=t.constructor[Symbol.metadata];for(let r in e){let s=e[r].name,i="object"==typeof t[s]&&this.refIds.get(t[s]);i&&!this.deletedRefs.has(i)&&this.removeRef(i)}}else"function"==typeof t[er]&&Array.from(t.values()).forEach(e=>{let t=this.refIds.get(e);this.deletedRefs.has(t)||this.removeRef(t)});this.refs.delete(e),delete this.refCount[e],delete this.callbacks[e]}),this.deletedRefs.clear()}addCallback(e,t,r){if(void 0===e){let e="number"==typeof t?E[t]:t;throw Error(`Can't addCallback on '${e}' (refId is undefined)`)}return this.callbacks[e]||(this.callbacks[e]={}),this.callbacks[e][t]||(this.callbacks[e][t]=[]),this.callbacks[e][t].push(r),()=>this.removeCallback(e,t,r)}removeCallback(e,t,r){let s=this.callbacks?.[e]?.[t]?.indexOf(r);void 0!==s&&-1!==s&&function(e,t){if(-1===t||t>=e.length)return;let r=e.length-1;for(let s=t;s<r;s++)e[s]=e[s+1];e.length=r}(this.callbacks[e][t],s)}}class tm{constructor(e,t){this.currentRefId=0,this.setState(e),this.context=t||new eJ(e.constructor)}setState(e){this.state=e,this.root=new tg,this.root.addRef(0,e)}decode(e,t={offset:0},r=this.state){let s=[],i=this.root,n=e.byteLength,o=r.constructor[Z];for(this.currentRefId=0;t.offset<n;){if(255==e[t.offset]){t.offset++,r[ei]?.();let s=ez.number(e,t),a=i.refs.get(s);a?(o=(r=a).constructor[Z],this.currentRefId=s):(console.error(`"refId" not found: ${s}`,{previousRef:r,previousRefId:this.currentRefId}),console.warn("Please report this issue to the developers."),this.skipCurrentStructure(e,t,n));continue}if(-1===o(this,e,t,r,s)){console.warn("@colyseus/schema: definition mismatch"),this.skipCurrentStructure(e,t,n);continue}}return r[ei]?.(),this.triggerChanges?.(s),i.garbageCollectDeletedRefs(),s}skipCurrentStructure(e,t,r){let s={offset:t.offset};for(;t.offset<r&&!(255===e[t.offset]&&(s.offset=t.offset+1,this.root.refs.has(ez.number(e,s))));)t.offset++}getInstanceType(e,t,r){let s;if(213===e[t.offset]){t.offset++;let r=ez.number(e,t);s=this.context.get(r)}return s||r}createInstanceOfType(e){return new e}removeChildRefs(e,t){let r="string"!=typeof e[er],s=this.root.refIds.get(e);e.forEach((i,n)=>{t.push({ref:e,refId:s,op:E.DELETE,field:n,value:void 0,previousValue:i}),r&&this.root.removeRef(this.root.refIds.get(i))})}}class ty extends tc{}tu([ta("string")],ty.prototype,"name",void 0),tu([ta("string")],ty.prototype,"type",void 0),tu([ta("number")],ty.prototype,"referencedType",void 0);class tb extends tc{constructor(){super(...arguments),this.fields=new ts}}tu([ta("number")],tb.prototype,"id",void 0),tu([ta("number")],tb.prototype,"extendsId",void 0),tu([ta([ty])],tb.prototype,"fields",void 0);class t_ extends tc{constructor(){super(...arguments),this.types=new ts}static encode(e,t={offset:0}){let r=e.context,s=new t_,i=new td(s),n=r.schemas.get(e.state.constructor);n>0&&(s.rootType=n);let o=new Set,a={},l=e=>{if(void 0===e.extendsId||o.has(e.extendsId)){o.add(e.id),s.types.push(e);let t=a[e.id];void 0!==t&&(delete a[e.id],t.forEach(e=>l(e)))}else void 0===a[e.extendsId]&&(a[e.extendsId]=[]),a[e.extendsId].push(e)};for(let e in r.schemas.forEach((e,t)=>{let s=new tb;s.id=Number(e);let i=Object.getPrototypeOf(t);i!==tc&&(s.extendsId=r.schemas.get(i));let n=t[Symbol.metadata];if(n!==i[Symbol.metadata])for(let e in n){let t;let i=Number(e),o=n[i].name;if(!Object.prototype.hasOwnProperty.call(n,o))continue;let a=new ty;a.name=o;let l=n[i];if("string"==typeof l.type)t=l.type;else{let e;tc.is(l.type)?(t="ref",e=l.type):(t=Object.keys(l.type)[0],"string"==typeof l.type[t]?t+=":"+l.type[t]:e=l.type[t]),a.referencedType=e?r.getTypeId(e):-1}a.type=t,s.fields.push(a)}l(s)}),a)a[e].forEach(e=>s.types.push(e));let h=i.encodeAll(t);return Buffer.from(h,0,t.offset)}static decode(e,t){let r=new t_;new tm(r).decode(e,t);let s=new eJ;r.types.forEach(e=>{let t=s.get(e.extendsId)??tc,r=class extends t{};eJ.register(r),s.add(r,e.id)},{});let i=(e,t,r)=>{t.fields.forEach((t,i)=>{let n=r+i;if(void 0!==t.referencedType){let r=t.type,i=s.get(t.referencedType);if(!i){let e=t.type.split(":");r=e[0],i=e[1]}"ref"===r?eY.addField(e,n,t.name,i):eY.addField(e,n,t.name,{[r]:i})}else eY.addField(e,n,t.name,t.type)})};return r.types.forEach(e=>{let t=s.get(e.id),n=eY.initialize(t),o=[],a=e;do o.push(a),a=r.types.find(e=>e.id===a.extendsId);while(a);let l=0;o.reverse().forEach(e=>{i(n,e,l),l+=e.fields.length})}),new tm(new(s.get(r.rootType||0)),s)}}tu([ta([tb])],t_.prototype,"types",void 0),tu([ta("number")],t_.prototype,"rootType",void 0),eG("map",{constructor:ti}),eG("array",{constructor:ts}),eG("set",{constructor:to}),eG("collection",{constructor:tn});class tv{events;wt;isOpen=!1;reader;writer;unreliableReader;unreliableWriter;lengthPrefixBuffer=new Uint8Array(9);constructor(e){this.events=e}connect(e,t={}){let r=t.fingerprint&&{serverCertificateHashes:[{algorithm:"sha-256",value:new Uint8Array(t.fingerprint).buffer}]}||void 0;this.wt=new WebTransport(e,r),this.wt.ready.then(e=>{console.log("WebTransport ready!",e),this.isOpen=!0,this.unreliableReader=this.wt.datagrams.readable.getReader(),this.unreliableWriter=this.wt.datagrams.writable.getWriter(),this.wt.incomingBidirectionalStreams.getReader().read().then(e=>{this.reader=e.value.readable.getReader(),this.writer=e.value.writable.getWriter(),this.sendSeatReservation(t.room.roomId,t.sessionId,t.reconnectionToken),this.readIncomingData(),this.readIncomingUnreliableData()}).catch(e=>{console.error("failed to read incoming stream",e),console.error("TODO: close the connection")})}).catch(e=>{console.log("WebTransport not ready!",e),this._close()}),this.wt.closed.then(e=>{console.log("WebTransport closed w/ success",e),this.events.onclose({code:e.closeCode,reason:e.reason})}).catch(e=>{console.log("WebTransport closed w/ error",e),this.events.onerror(e),this.events.onclose({code:e.closeCode,reason:e.reason})}).finally(()=>{this._close()})}send(e){let t=ek.number(this.lengthPrefixBuffer,e.length,{offset:0}),r=new Uint8Array(t+e.length);r.set(this.lengthPrefixBuffer.subarray(0,t),0),r.set(e,t),this.writer.write(r)}sendUnreliable(e){let t=ek.number(this.lengthPrefixBuffer,e.length,{offset:0}),r=new Uint8Array(t+e.length);r.set(this.lengthPrefixBuffer.subarray(0,t),0),r.set(e,t),this.unreliableWriter.write(r)}close(e,t){try{this.wt.close({closeCode:e,reason:t})}catch(e){console.error(e)}}async readIncomingData(){let e;for(;this.isOpen;){try{let t=(e=await this.reader.read()).value,r={offset:0};do{let e=ez.number(t,r);this.events.onmessage({data:t.subarray(r.offset,r.offset+e)}),r.offset+=e}while(r.offset<t.length)}catch(e){-1===e.message.indexOf("session is closed")&&console.error("H3Transport: failed to read incoming data",e);break}if(e.done)break}}async readIncomingUnreliableData(){let e;for(;this.isOpen;){try{let t=(e=await this.unreliableReader.read()).value,r={offset:0};do{let e=ez.number(t,r);this.events.onmessage({data:t.subarray(r.offset,r.offset+e)}),r.offset+=e}while(r.offset<t.length)}catch(e){-1===e.message.indexOf("session is closed")&&console.error("H3Transport: failed to read incoming data",e);break}if(e.done)break}}sendSeatReservation(e,t,r){let s={offset:0},i=[];ek.string(i,e,s),ek.string(i,t,s),r&&ek.string(i,r,s),this.writer.write(new Uint8Array(i).buffer)}_close(){this.isOpen=!1}}r(42504),r(83958),r(74036);var tw=r(46342);r(30359);let tE=globalThis.WebSocket||tw;class tS{events;ws;protocols;constructor(e){this.events=e}send(e){this.ws.send(e)}sendUnreliable(e){console.warn("colyseus.js: The WebSocket transport does not support unreliable messages")}connect(e,t){try{this.ws=new tE(e,{headers:t,protocols:this.protocols})}catch(t){this.ws=new tE(e,this.protocols)}this.ws.binaryType="arraybuffer",this.ws.onopen=this.events.onopen,this.ws.onmessage=this.events.onmessage,this.ws.onclose=this.events.onclose,this.ws.onerror=this.events.onerror}close(e,t){this.ws.close(e,t)}get isOpen(){return this.ws.readyState===tE.OPEN}}class tx{transport;events={};constructor(e){"h3"===e?this.transport=new tv(this.events):this.transport=new tS(this.events)}connect(e,t){this.transport.connect.call(this.transport,e,t)}send(e){this.transport.send(e)}sendUnreliable(e){this.transport.sendUnreliable(e)}close(e,t){this.transport.close(e,t)}get isOpen(){return this.transport.isOpen}}(function(e){e[e.HANDSHAKE=9]="HANDSHAKE",e[e.JOIN_ROOM=10]="JOIN_ROOM",e[e.ERROR=11]="ERROR",e[e.LEAVE_ROOM=12]="LEAVE_ROOM",e[e.ROOM_DATA=13]="ROOM_DATA",e[e.ROOM_STATE=14]="ROOM_STATE",e[e.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",e[e.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",e[e.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES"})(R||(R={})),function(e){e[e.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",e[e.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",e[e.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",e[e.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",e[e.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",e[e.AUTH_FAILED=4215]="AUTH_FAILED",e[e.APPLICATION_ERROR=4216]="APPLICATION_ERROR"}(N||(N={}));let tC={};function tk(e){let t=tC[e];if(!t)throw Error("missing serializer: "+e);return t}let tI=()=>({emit(e,...t){let r=this.events[e]||[];for(let e=0,s=r.length;e<s;e++)r[e](...t)},events:{},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter(e=>t!==e)}}});class tO{handlers=[];register(e,t=!1){return this.handlers.push(e),this}invoke(...e){this.handlers.forEach(t=>t.apply(this,e))}invokeAsync(...e){return Promise.all(this.handlers.map(t=>t.apply(this,e)))}remove(e){let t=this.handlers.indexOf(e);this.handlers[t]=this.handlers[this.handlers.length-1],this.handlers.pop()}clear(){this.handlers=[]}}function tT(){let e=new tO;function t(t){return e.register(t,this===null)}return t.once=t=>{let r=function(...s){t.apply(this,s),e.remove(r)};e.register(r)},t.remove=t=>e.remove(t),t.invoke=(...t)=>e.invoke(...t),t.invokeAsync=(...t)=>e.invokeAsync(...t),t.clear=()=>e.clear(),t}class tA{state;decoder;setState(e,t){this.decoder.decode(e,t)}getState(){return this.state}patch(e,t){return this.decoder.decode(e,t)}teardown(){this.decoder.root.clearRefs()}handshake(e,t){this.state?(t_.decode(e,t),this.decoder=new tm(this.state)):(this.decoder=t_.decode(e,t),this.state=this.decoder.state)}}try{L=new TextDecoder}catch(e){}var tD=0;let t$=[];var tR=t$,tN=0,tL={},tP=0,tM=0,tB=[],tU={useRecords:!1,mapsAsObjects:!0};class tj{}let tF=new tj;tF.name="MessagePack 0xC1";var tV=!1,tW=2;try{Function("")}catch(e){tW=1/0}class tz{constructor(e){e&&(!1===e.useRecords&&void 0===e.mapsAsObjects&&(e.mapsAsObjects=!0),!e.sequential||!1===e.trusted||(e.trusted=!0,e.structures||!1==e.useRecords||(e.structures=[],e.maxSharedStructures||(e.maxSharedStructures=0))),e.structures?e.structures.sharedLength=e.structures.length:e.getStructures&&((e.structures=[]).uninitialized=!0,e.structures.sharedLength=0),e.int64AsNumber&&(e.int64AsType="number")),Object.assign(this,e)}unpack(e,t){if(P)return rh(()=>(rc(),this?this.unpack(e,t):tz.prototype.unpack.call(tU,e,t)));e.buffer||e.constructor!==ArrayBuffer||(e="undefined"!=typeof Buffer?Buffer.from(e):new Uint8Array(e)),"object"==typeof t?(M=t.end||e.length,tD=t.start||0):(tD=0,M=t>-1?t:e.length),tN=0,tM=0,U=null,tR=t$,j=null,P=e;try{V=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(t){if(P=null,e instanceof Uint8Array)throw t;throw Error("Source must be a Uint8Array or Buffer but was a "+(e&&"object"==typeof e?e.constructor.name:typeof e))}return this instanceof tz?(tL=this,this.structures?B=this.structures:(!B||B.length>0)&&(B=[])):(tL=tU,(!B||B.length>0)&&(B=[])),tq(t)}unpackMultiple(e,t){let r,s=0;try{tV=!0;let i=e.length,n=this?this.unpack(e,i):rf.unpack(e,i);if(t){if(!1===t(n,s,tD))return;for(;tD<i;)if(s=tD,!1===t(tq(),s,tD))return}else{for(r=[n];tD<i;)s=tD,r.push(tq());return r}}catch(e){throw e.lastPosition=s,e.values=r,e}finally{tV=!1,rc()}}_mergeStructures(e,t){z&&(e=z.call(this,e)),Object.isFrozen(e=e||[])&&(e=e.map(e=>e.slice(0)));for(let t=0,r=e.length;t<r;t++){let r=e[t];r&&(r.isShared=!0,t>=32&&(r.highByte=t-32>>5))}for(let r in e.sharedLength=e.length,t||[])if(r>=0){let s=e[r],i=t[r];i&&(s&&((e.restoreStructures||(e.restoreStructures=[]))[r]=s),e[r]=i)}return this.structures=e}decode(e,t){return this.unpack(e,t)}}function tq(e){try{let t;if(!tL.trusted&&!tV){let e=B.sharedLength||0;e<B.length&&(B.length=e)}if(tL.randomAccessStructure&&P[tD]<64&&P[tD]>=32&&W?(t=W(P,tD,M,tL),P=null,!(e&&e.lazy)&&t&&(t=t.toJSON()),tD=M):t=tG(),j&&(tD=j.postBundlePosition,j=null),tV&&(B.restoreStructures=null),tD==M)B&&B.restoreStructures&&tH(),B=null,P=null,F&&(F=null);else if(tD>M)throw Error("Unexpected end of MessagePack data");else if(!tV){let e;try{e=JSON.stringify(t,(e,t)=>"bigint"==typeof t?`${t}n`:t).slice(0,100)}catch(t){e="(JSON view not available "+t+")"}throw Error("Data read, but end of buffer not reached "+e)}return t}catch(e){throw B&&B.restoreStructures&&tH(),rc(),(e instanceof RangeError||e.message.startsWith("Unexpected end of buffer")||tD>M)&&(e.incomplete=!0),e}}function tH(){for(let e in B.restoreStructures)B[e]=B.restoreStructures[e];B.restoreStructures=null}function tG(){let e=P[tD++];if(e<160){if(e<128){if(e<64)return e;{let t=B[63&e]||tL.getStructures&&tZ()[63&e];return t?(t.read||(t.read=tK(t,63&e)),t.read()):e}}if(e<144){if(e-=128,tL.mapsAsObjects){let t={};for(let r=0;r<e;r++){let e=rr();"__proto__"===e&&(e="__proto_"),t[e]=tG()}return t}{let t=new Map;for(let r=0;r<e;r++)t.set(tG(),tG());return t}}{let t=Array(e-=144);for(let r=0;r<e;r++)t[r]=tG();return tL.freezeData?Object.freeze(t):t}}if(e<192){let t=e-160;if(tM>=tD)return U.slice(tD-tP,(tD+=t)-tP);if(0==tM&&M<140){let e=t<16?t5(t):t8(t);if(null!=e)return e}return tX(t)}{let t;switch(e){case 192:return null;case 193:if(j){if((t=tG())>0)return j[1].slice(j.position1,j.position1+=t);return j[0].slice(j.position0,j.position0-=t)}return tF;case 194:return!1;case 195:return!0;case 196:if(void 0===(t=P[tD++]))throw Error("Unexpected end of buffer");return t7(t);case 197:return t=V.getUint16(tD),tD+=2,t7(t);case 198:return t=V.getUint32(tD),tD+=4,t7(t);case 199:return re(P[tD++]);case 200:return t=V.getUint16(tD),tD+=2,re(t);case 201:return t=V.getUint32(tD),tD+=4,re(t);case 202:if(t=V.getFloat32(tD),tL.useFloat32>2){let e=ru[(127&P[tD])<<1|P[tD+1]>>7];return tD+=4,(e*t+(t>0?.5:-.5)>>0)/e}return tD+=4,t;case 203:return t=V.getFloat64(tD),tD+=8,t;case 204:return P[tD++];case 205:return t=V.getUint16(tD),tD+=2,t;case 206:return t=V.getUint32(tD),tD+=4,t;case 207:return"number"===tL.int64AsType?t=4294967296*V.getUint32(tD)+V.getUint32(tD+4):"string"===tL.int64AsType?t=V.getBigUint64(tD).toString():"auto"===tL.int64AsType?(t=V.getBigUint64(tD))<=BigInt(2)<<BigInt(52)&&(t=Number(t)):t=V.getBigUint64(tD),tD+=8,t;case 208:return V.getInt8(tD++);case 209:return t=V.getInt16(tD),tD+=2,t;case 210:return t=V.getInt32(tD),tD+=4,t;case 211:return"number"===tL.int64AsType?t=4294967296*V.getInt32(tD)+V.getUint32(tD+4):"string"===tL.int64AsType?t=V.getBigInt64(tD).toString():"auto"===tL.int64AsType?(t=V.getBigInt64(tD))>=BigInt(-2)<<BigInt(52)&&t<=BigInt(2)<<BigInt(52)&&(t=Number(t)):t=V.getBigInt64(tD),tD+=8,t;case 212:if(114==(t=P[tD++]))return ri(63&P[tD++]);{let e=tB[t];if(e){if(e.read)return tD++,e.read(tG());if(e.noBuffer)return tD++,e();return e(P.subarray(tD,++tD))}throw Error("Unknown extension "+t)}case 213:if(114==(t=P[tD]))return tD++,ri(63&P[tD++],P[tD++]);return re(2);case 214:return re(4);case 215:return re(8);case 216:return re(16);case 217:if(t=P[tD++],tM>=tD)return U.slice(tD-tP,(tD+=t)-tP);return tQ(t);case 218:if(t=V.getUint16(tD),tD+=2,tM>=tD)return U.slice(tD-tP,(tD+=t)-tP);return t0(t);case 219:if(t=V.getUint32(tD),tD+=4,tM>=tD)return U.slice(tD-tP,(tD+=t)-tP);return t1(t);case 220:return t=V.getUint16(tD),tD+=2,t6(t);case 221:return t=V.getUint32(tD),tD+=4,t6(t);case 222:return t=V.getUint16(tD),tD+=2,t4(t);case 223:return t=V.getUint32(tD),tD+=4,t4(t);default:if(e>=224)return e-256;if(void 0===e){let e=Error("Unexpected end of MessagePack data");throw e.incomplete=!0,e}throw Error("Unknown MessagePack token "+e)}}}let tJ=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function tK(e,t){function r(){if(r.count++>tW){let r=e.read=Function("r","return function(){return "+(tL.freezeData?"Object.freeze":"")+"({"+e.map(e=>"__proto__"===e?"__proto_:r()":tJ.test(e)?e+":r()":"["+JSON.stringify(e)+"]:r()").join(",")+"})}")(tG);return 0===e.highByte&&(e.read=tY(t,e.read)),r()}let s={};for(let t=0,r=e.length;t<r;t++){let r=e[t];"__proto__"===r&&(r="__proto_"),s[r]=tG()}return tL.freezeData?Object.freeze(s):s}return(r.count=0,0===e.highByte)?tY(t,r):r}let tY=(e,t)=>function(){let r=P[tD++];if(0===r)return t();let s=e<32?-(e+(r<<5)):e+(r<<5),i=B[s]||tZ()[s];if(!i)throw Error("Record id is not defined for "+s);return i.read||(i.read=tK(i,e)),i.read()};function tZ(){let e=rh(()=>(P=null,tL.getStructures()));return B=tL._mergeStructures(e,B)}var tX=t2,tQ=t2,t0=t2,t1=t2;function t2(e){let t;if(e<16&&(t=t5(e)))return t;if(e>64&&L)return L.decode(P.subarray(tD,tD+=e));let r=tD+e,s=[];for(t="";tD<r;){let e=P[tD++];if((128&e)==0)s.push(e);else if((224&e)==192){let t=63&P[tD++];s.push((31&e)<<6|t)}else if((240&e)==224){let t=63&P[tD++],r=63&P[tD++];s.push((31&e)<<12|t<<6|r)}else if((248&e)==240){let t=(7&e)<<18|(63&P[tD++])<<12|(63&P[tD++])<<6|63&P[tD++];t>65535&&(t-=65536,s.push(t>>>10&1023|55296),t=56320|1023&t),s.push(t)}else s.push(e);s.length>=4096&&(t+=t3.apply(String,s),s.length=0)}return s.length>0&&(t+=t3.apply(String,s)),t}function t6(e){let t=Array(e);for(let r=0;r<e;r++)t[r]=tG();return tL.freezeData?Object.freeze(t):t}function t4(e){if(tL.mapsAsObjects){let t={};for(let r=0;r<e;r++){let e=rr();"__proto__"===e&&(e="__proto_"),t[e]=tG()}return t}{let t=new Map;for(let r=0;r<e;r++)t.set(tG(),tG());return t}}var t3=String.fromCharCode;function t8(e){let t=tD,r=Array(e);for(let s=0;s<e;s++){let e=P[tD++];if((128&e)>0){tD=t;return}r[s]=e}return t3.apply(String,r)}function t5(e){if(e<4){if(e<2){if(0===e)return"";{let e=P[tD++];if((128&e)>1){tD-=1;return}return t3(e)}}{let t=P[tD++],r=P[tD++];if((128&t)>0||(128&r)>0){tD-=2;return}if(e<3)return t3(t,r);let s=P[tD++];if((128&s)>0){tD-=3;return}return t3(t,r,s)}}{let t=P[tD++],r=P[tD++],s=P[tD++],i=P[tD++];if((128&t)>0||(128&r)>0||(128&s)>0||(128&i)>0){tD-=4;return}if(e<6){if(4===e)return t3(t,r,s,i);{let e=P[tD++];if((128&e)>0){tD-=5;return}return t3(t,r,s,i,e)}}if(e<8){let n=P[tD++],o=P[tD++];if((128&n)>0||(128&o)>0){tD-=6;return}if(e<7)return t3(t,r,s,i,n,o);let a=P[tD++];if((128&a)>0){tD-=7;return}return t3(t,r,s,i,n,o,a)}{let n=P[tD++],o=P[tD++],a=P[tD++],l=P[tD++];if((128&n)>0||(128&o)>0||(128&a)>0||(128&l)>0){tD-=8;return}if(e<10){if(8===e)return t3(t,r,s,i,n,o,a,l);{let e=P[tD++];if((128&e)>0){tD-=9;return}return t3(t,r,s,i,n,o,a,l,e)}}if(e<12){let h=P[tD++],c=P[tD++];if((128&h)>0||(128&c)>0){tD-=10;return}if(e<11)return t3(t,r,s,i,n,o,a,l,h,c);let u=P[tD++];if((128&u)>0){tD-=11;return}return t3(t,r,s,i,n,o,a,l,h,c,u)}{let h=P[tD++],c=P[tD++],u=P[tD++],f=P[tD++];if((128&h)>0||(128&c)>0||(128&u)>0||(128&f)>0){tD-=12;return}if(e<14){if(12===e)return t3(t,r,s,i,n,o,a,l,h,c,u,f);{let e=P[tD++];if((128&e)>0){tD-=13;return}return t3(t,r,s,i,n,o,a,l,h,c,u,f,e)}}{let d=P[tD++],p=P[tD++];if((128&d)>0||(128&p)>0){tD-=14;return}if(e<15)return t3(t,r,s,i,n,o,a,l,h,c,u,f,d,p);let g=P[tD++];if((128&g)>0){tD-=15;return}return t3(t,r,s,i,n,o,a,l,h,c,u,f,d,p,g)}}}}}function t9(){let e,t=P[tD++];if(t<192)e=t-160;else switch(t){case 217:e=P[tD++];break;case 218:e=V.getUint16(tD),tD+=2;break;case 219:e=V.getUint32(tD),tD+=4;break;default:throw Error("Expected string")}return t2(e)}function t7(e){return tL.copyBuffers?Uint8Array.prototype.slice.call(P,tD,tD+=e):P.subarray(tD,tD+=e)}function re(e){let t=P[tD++];if(tB[t]){let r;return tB[t](P.subarray(tD,r=tD+=e),e=>{tD=e;try{return tG()}finally{tD=r}})}throw Error("Unknown extension type "+t)}var rt=Array(4096);function rr(){let e,t=P[tD++];if(!(t>=160)||!(t<192))return tD--,rs(tG());if(t-=160,tM>=tD)return U.slice(tD-tP,(tD+=t)-tP);if(!(0==tM&&M<180))return tX(t);let r=(t<<5^(t>1?V.getUint16(tD):t>0?P[tD]:0))&4095,s=rt[r],i=tD,n=tD+t-3,o=0;if(s&&s.bytes==t){for(;i<n;){if((e=V.getUint32(i))!=s[o++]){i=1879048192;break}i+=4}for(n+=3;i<n;)if((e=P[i++])!=s[o++]){i=1879048192;break}if(i===n)return tD=i,s.string;n-=3,i=tD}for(s=[],rt[r]=s,s.bytes=t;i<n;)e=V.getUint32(i),s.push(e),i+=4;for(n+=3;i<n;)e=P[i++],s.push(e);let a=t<16?t5(t):t8(t);return null!=a?s.string=a:s.string=tX(t)}function rs(e){if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e||"bigint"==typeof e)return e.toString();if(null==e)return e+"";if(tL.allowArraysInMapKeys&&Array.isArray(e)&&e.flat().every(e=>["string","number","boolean","bigint"].includes(typeof e)))return e.flat().toString();throw Error(`Invalid property type for record: ${typeof e}`)}let ri=(e,t)=>{let r=tG().map(rs),s=e;void 0!==t&&(e=e<32?-((t<<5)+e):(t<<5)+e,r.highByte=t);let i=B[e];return i&&(i.isShared||tV)&&((B.restoreStructures||(B.restoreStructures=[]))[e]=i),B[e]=r,r.read=tK(r,s),r.read()};tB[0]=()=>{},tB[0].noBuffer=!0,tB[66]=e=>{let t=e.length,r=BigInt(128&e[0]?e[0]-256:e[0]);for(let s=1;s<t;s++)r<<=BigInt(8),r+=BigInt(e[s]);return r};let rn={Error,TypeError,ReferenceError};tB[101]=()=>{let e=tG();return(rn[e[0]]||Error)(e[1],{cause:e[2]})},tB[105]=e=>{let t;if(!1===tL.structuredClone)throw Error("Structured clone extension is disabled");let r=V.getUint32(tD-4);F||(F=new Map);let s=P[tD],i={target:t=s>=144&&s<160||220==s||221==s?[]:{}};F.set(r,i);let n=tG();return i.used?Object.assign(t,n):(i.target=n,n)},tB[112]=e=>{if(!1===tL.structuredClone)throw Error("Structured clone extension is disabled");let t=V.getUint32(tD-4),r=F.get(t);return r.used=!0,r.target},tB[115]=()=>new Set(tG());let ro=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(e=>e+"Array"),ra="object"==typeof globalThis?globalThis:window;tB[116]=e=>{let t=e[0],r=ro[t];if(!r){if(16===t){let t=new ArrayBuffer(e.length-1);return new Uint8Array(t).set(e.subarray(1)),t}throw Error("Could not find typed array for code "+t)}return new ra[r](Uint8Array.prototype.slice.call(e,1).buffer)},tB[120]=()=>{let e=tG();return new RegExp(e[0],e[1])};let rl=[];function rh(e){q&&q();let t=M,r=tD,s=tN,i=tP,n=tM,o=U,a=tR,l=F,h=j,c=new Uint8Array(P.slice(0,M)),u=B,f=B.slice(0,B.length),d=tL,p=tV,g=e();return M=t,tD=r,tN=s,tP=i,tM=n,U=o,tR=a,F=l,j=h,P=c,tV=p,(B=u).splice(0,B.length,...f),tL=d,V=new DataView(P.buffer,P.byteOffset,P.byteLength),g}function rc(){P=null,F=null,B=null}tB[98]=e=>{let t=(e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3],r=tD;return tD+=t-e.length,j=rl,(j=[t9(),t9()]).position0=0,j.position1=0,j.postBundlePosition=tD,tD=r,tG()},tB[255]=e=>new Date(4==e.length?(16777216*e[0]+(e[1]<<16)+(e[2]<<8)+e[3])*1e3:8==e.length?((e[0]<<22)+(e[1]<<14)+(e[2]<<6)+(e[3]>>2))/1e6+((3&e[3])*4294967296+16777216*e[4]+(e[5]<<16)+(e[6]<<8)+e[7])*1e3:12==e.length?((e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3])/1e6+((128&e[4]?-281474976710656:0)+1099511627776*e[6]+4294967296*e[7]+16777216*e[8]+(e[9]<<16)+(e[10]<<8)+e[11])*1e3:"invalid");let ru=Array(147);for(let e=0;e<256;e++)ru[e]=+("1e"+Math.floor(45.15-.30103*e));var rf=new tz({useRecords:!1});let rd=rf.unpack;rf.unpackMultiple,rf.unpack,new Uint8Array(new Float32Array(1).buffer,0,4);try{s=new TextEncoder}catch(e){}let rp="undefined"!=typeof Buffer,rg=rp?function(e){return Buffer.allocUnsafeSlow(e)}:Uint8Array,rm=rp?Buffer:Uint8Array,ry=rp?4294967296:2144337920,rb=0,r_=null,rv=/[\u0080-\uFFFF]/,rw=Symbol("record-id");class rE extends tz{constructor(e){let t,r,u,f;super(e),this.offset=0;let d=rm.prototype.utf8Write?function(e,t){return o.utf8Write(e,t,o.byteLength-t)}:!!s&&!!s.encodeInto&&function(e,t){return s.encodeInto(e,o.subarray(t)).written},p=this;e||(e={});let g=e&&e.sequential,m=e.structures||e.saveStructures,y=e.maxSharedStructures;if(null==y&&(y=m?32:0),y>8160)throw Error("Maximum maxSharedStructure is 8160");e.structuredClone&&void 0==e.moreTypes&&(this.moreTypes=!0);let b=e.maxOwnStructures;null==b&&(b=m?32:64),this.structures||!1==e.useRecords||(this.structures=[]);let _=y>32||b+y>64,v=y+64,w=y+b+64;if(w>8256)throw Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let E=[],S=0,x=0;this.pack=this.encode=function(e,s){let i;if(o||(l=(o=new rg(8192)).dataView||(o.dataView=new DataView(o.buffer,0,8192)),rb=0),(h=o.length-10)-rb<2048?(l=(o=new rg(o.length)).dataView||(o.dataView=new DataView(o.buffer,0,o.length)),h=o.length-10,rb=0):rb=rb+7&2147483640,t=rb,s&rN&&(rb+=255&s),f=p.structuredClone?new Map:null,p.bundleStrings&&"string"!=typeof e?(r_=[]).size=1/0:r_=null,u=p.structures){u.uninitialized&&(u=p._mergeStructures(p.getStructures()));let e=u.sharedLength||0;if(e>y)throw Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+u.sharedLength);if(!u.transitions){u.transitions=Object.create(null);for(let t=0;t<e;t++){let e=u[t];if(!e)continue;let r,s=u.transitions;for(let t=0,i=e.length;t<i;t++){let i=e[t];(r=s[i])||(r=s[i]=Object.create(null)),s=r}s[rw]=t+64}this.lastNamedStructuresLength=e}g||(u.nextId=e+64)}r&&(r=!1);try{p.randomAccessStructure&&e&&e.constructor&&e.constructor===Object?L(e):I(e);let r=r_;if(r_&&rC(t,I,0),f&&f.idsToInsert){let e=f.idsToInsert.sort((e,t)=>e.offset>t.offset?1:-1),s=e.length,i=-1;for(;r&&s>0;){let n=e[--s].offset+t;n<r.stringsPosition+t&&-1===i&&(i=0),n>r.position+t?i>=0&&(i+=6):(i>=0&&(l.setUint32(r.position+t,l.getUint32(r.position+t)+i),i=-1),r=r.previous,s++)}i>=0&&r&&l.setUint32(r.position+t,l.getUint32(r.position+t)+i),(rb+=6*e.length)>h&&$(rb),p.offset=rb;let n=function(e,t){let r;let s=6*t.length,i=e.length-s;for(;r=t.pop();){let t=r.offset,n=r.id;e.copyWithin(t+s,t,i);let o=t+(s-=6);e[o++]=214,e[o++]=105,e[o++]=n>>24,e[o++]=n>>16&255,e[o++]=n>>8&255,e[o++]=255&n,i=t}return e}(o.subarray(t,rb),e);return f=null,n}if(p.offset=rb,s&r$)return o.start=t,o.end=rb,o;return o.subarray(t,rb)}catch(e){throw i=e,e}finally{if(u&&(C(),r&&p.saveStructures)){let r=u.sharedLength||0,n=o.subarray(t,rb),a=rk(u,p);if(!i){if(!1===p.saveStructures(a,a.isCompatible))return p.pack(e,s);return p.lastNamedStructuresLength=r,o.length>1073741824&&(o=null),n}}o.length>1073741824&&(o=null),s&rR&&(rb=t)}};let C=()=>{x<10&&x++;let e=u.sharedLength||0;if(u.length>e&&!g&&(u.length=e),S>1e4)u.transitions=null,x=0,S=0,E.length>0&&(E=[]);else if(E.length>0&&!g){for(let e=0,t=E.length;e<t;e++)E[e][rw]=0;E=[]}},k=e=>{var t=e.length;t<16?o[rb++]=144|t:t<65536?(o[rb++]=220,o[rb++]=t>>8,o[rb++]=255&t):(o[rb++]=221,l.setUint32(rb,t),rb+=4);for(let r=0;r<t;r++)I(e[r])},I=e=>{rb>h&&(o=$(rb));var r,s=typeof e;if("string"===s){let s,i=e.length;if(r_&&i>=4&&i<4096){if((r_.size+=i)>21760){let e,r;let s=(r_[0]?3*r_[0].length+r_[1].length:0)+10;rb+s>h&&(o=$(rb+s)),r_.position?(r=r_,o[rb]=200,rb+=3,o[rb++]=98,e=rb-t,rb+=4,rC(t,I,0),l.setUint16(e+t-3,rb-t-e)):(o[rb++]=214,o[rb++]=98,e=rb-t,rb+=4),(r_=["",""]).previous=r,r_.size=0,r_.position=e}let r=rv.test(e);r_[r?0:1]+=e,o[rb++]=193,I(r?-i:i);return}s=i<32?1:i<256?2:i<65536?3:5;let n=3*i;if(rb+n>h&&(o=$(rb+n)),i<64||!d){let t,n,a,l=rb+s;for(t=0;t<i;t++)(n=e.charCodeAt(t))<128?o[l++]=n:(n<2048?o[l++]=n>>6|192:((64512&n)==55296&&(64512&(a=e.charCodeAt(t+1)))==56320?(n=65536+((1023&n)<<10)+(1023&a),t++,o[l++]=n>>18|240,o[l++]=n>>12&63|128):o[l++]=n>>12|224,o[l++]=n>>6&63|128),o[l++]=63&n|128);r=l-rb-s}else r=d(e,rb+s);r<32?o[rb++]=160|r:r<256?(s<2&&o.copyWithin(rb+2,rb+1,rb+1+r),o[rb++]=217,o[rb++]=r):r<65536?(s<3&&o.copyWithin(rb+3,rb+2,rb+2+r),o[rb++]=218,o[rb++]=r>>8,o[rb++]=255&r):(s<5&&o.copyWithin(rb+5,rb+3,rb+3+r),o[rb++]=219,l.setUint32(rb,r),rb+=4),rb+=r}else if("number"===s){if(e>>>0===e)e<32||e<128&&!1===this.useRecords||e<64&&!this.randomAccessStructure?o[rb++]=e:e<256?(o[rb++]=204,o[rb++]=e):e<65536?(o[rb++]=205,o[rb++]=e>>8,o[rb++]=255&e):(o[rb++]=206,l.setUint32(rb,e),rb+=4);else if(e>>0===e)e>=-32?o[rb++]=256+e:e>=-128?(o[rb++]=208,o[rb++]=e+256):e>=-32768?(o[rb++]=209,l.setInt16(rb,e),rb+=2):(o[rb++]=210,l.setInt32(rb,e),rb+=4);else{let t;if((t=this.useFloat32)>0&&e<4294967296&&e>=-2147483648){let r;if(o[rb++]=202,l.setFloat32(rb,e),t<4||(r=e*ru[(127&o[rb])<<1|o[rb+1]>>7])>>0===r){rb+=4;return}rb--}o[rb++]=203,l.setFloat64(rb,e),rb+=8}}else if("object"===s||"function"===s){if(e){if(f){let r=f.get(e);if(r){if(!r.id){let e=f.idsToInsert||(f.idsToInsert=[]);r.id=e.push(r)}o[rb++]=214,o[rb++]=112,l.setUint32(rb,r.id),rb+=4;return}f.set(e,{offset:rb-t})}let a=e.constructor;if(a===Object)D(e);else if(a===Array)k(e);else if(a===Map){if(this.mapAsEmptyObject)o[rb++]=128;else for(let[t,s]of((r=e.size)<16?o[rb++]=128|r:r<65536?(o[rb++]=222,o[rb++]=r>>8,o[rb++]=255&r):(o[rb++]=223,l.setUint32(rb,r),rb+=4),e))I(t),I(s)}else{for(let t=0,r=i.length;t<r;t++)if(e instanceof n[t]){let r,s=i[t];if(s.write){s.type&&(o[rb++]=212,o[rb++]=s.type,o[rb++]=0);let t=s.write.call(this,e);t===e?Array.isArray(e)?k(e):D(e):I(t);return}let n=o,a=l,c=rb;o=null;try{r=s.pack.call(this,e,e=>(o=n,n=null,(rb+=e)>h&&$(rb),{target:o,targetView:l,position:rb-e}),I)}finally{n&&(o=n,l=a,rb=c,h=o.length-10)}r&&(r.length+rb>h&&$(r.length+rb),rb=function(e,t,r,s){let i=e.length;switch(i){case 1:t[r++]=212;break;case 2:t[r++]=213;break;case 4:t[r++]=214;break;case 8:t[r++]=215;break;case 16:t[r++]=216;break;default:i<256?(t[r++]=199,t[r++]=i):(i<65536?(t[r++]=200,t[r++]=i>>8):(t[r++]=201,t[r++]=i>>24,t[r++]=i>>16&255,t[r++]=i>>8&255),t[r++]=255&i)}return t[r++]=s,t.set(e,r),r+=i}(r,o,rb,s.type));return}if(Array.isArray(e))k(e);else{if(e.toJSON){let t=e.toJSON();if(t!==e)return I(t)}if("function"===s)return I(this.writeFunction&&this.writeFunction(e));D(e)}}}else o[rb++]=192}else if("boolean"===s)o[rb++]=e?195:194;else if("bigint"===s){if(e<BigInt(1)<<BigInt(63)&&e>=-(BigInt(1)<<BigInt(63)))o[rb++]=211,l.setBigInt64(rb,e);else if(e<BigInt(1)<<BigInt(64)&&e>0)o[rb++]=207,l.setBigUint64(rb,e);else if(this.largeBigIntToFloat)o[rb++]=203,l.setFloat64(rb,Number(e));else if(this.largeBigIntToString)return I(e.toString());else if(this.useBigIntExtension&&e<BigInt(2)**BigInt(1023)&&e>-(BigInt(2)**BigInt(1023))){let t;o[rb++]=199,rb++,o[rb++]=66;let r=[];do{let s=e&BigInt(255);t=(s&BigInt(128))===(e<BigInt(0)?BigInt(128):BigInt(0)),r.push(s),e>>=BigInt(8)}while(!((e===BigInt(0)||e===BigInt(-1))&&t));o[rb-2]=r.length;for(let e=r.length;e>0;)o[rb++]=Number(r[--e]);return}else throw RangeError(e+" was too large to fit in MessagePack 64-bit integer format, use useBigIntExtension, or set largeBigIntToFloat to convert to float-64, or set largeBigIntToString to convert to string");rb+=8}else if("undefined"===s)this.encodeUndefinedAsNil?o[rb++]=192:(o[rb++]=212,o[rb++]=0,o[rb++]=0);else throw Error("Unknown type: "+s)},O=this.variableMapSize||this.coercibleKeyAsNumber||this.skipValues?e=>{let t,r;if(this.skipValues)for(let r in t=[],e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(r))&&!this.skipValues.includes(e[r])&&t.push(r);else t=Object.keys(e);let s=t.length;if(s<16?o[rb++]=128|s:s<65536?(o[rb++]=222,o[rb++]=s>>8,o[rb++]=255&s):(o[rb++]=223,l.setUint32(rb,s),rb+=4),this.coercibleKeyAsNumber)for(let i=0;i<s;i++){let s=Number(r=t[i]);I(isNaN(s)?r:s),I(e[r])}else for(let i=0;i<s;i++)I(r=t[i]),I(e[r])}:e=>{o[rb++]=222;let r=rb-t;rb+=2;let s=0;for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&(I(t),I(e[t]),s++);if(s>65535)throw Error('Object is too large to serialize with fast 16-bit map size, use the "variableMapSize" option to serialize this object');o[r+++t]=s>>8,o[r+t]=255&s},T=!1===this.useRecords?O:e.progressiveRecords&&!_?e=>{let r,s,i=u.transitions||(u.transitions=Object.create(null)),n=rb++-t;for(let o in e)if("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(o)){if(s=i[o])i=s;else{let a=Object.keys(e),l=i;i=u.transitions;let h=0;for(let e=0,t=a.length;e<t;e++){let t=a[e];!(s=i[t])&&(s=i[t]=Object.create(null),h++),i=s}n+t+1==rb?(rb--,R(i,a,h)):N(i,a,n,h),r=!0,i=l[o]}I(e[o])}if(!r){let r=i[rw];r?o[n+t]=r:N(i,Object.keys(e),n,0)}}:e=>{let t,r=u.transitions||(u.transitions=Object.create(null)),s=0;for(let i in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(i))&&(!(t=r[i])&&(t=r[i]=Object.create(null),s++),r=t);let i=r[rw];for(let t in i?i>=96&&_?(o[rb++]=(31&(i-=96))+96,o[rb++]=i>>5):o[rb++]=i:R(r,r.__keys__||Object.keys(e),s),e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&I(e[t])},A="function"==typeof this.useRecords&&this.useRecords,D=A?e=>{A(e)?T(e):O(e)}:T,$=e=>{let r;if(e>16777216){if(e-t>ry)throw Error("Packed buffer would be larger than maximum buffer size");r=Math.min(ry,4096*Math.round(Math.max((e-t)*(e>67108864?1.25:2),4194304)/4096))}else r=(Math.max(e-t<<2,o.length-1)>>12)+1<<12;let s=new rg(r);return l=s.dataView||(s.dataView=new DataView(s.buffer,0,r)),e=Math.min(e,o.length),o.copy?o.copy(s,0,t,e):s.set(o.slice(t,e)),rb-=t,t=0,h=s.length-10,o=s},R=(e,t,s)=>{let i=u.nextId;i||(i=64),i<v&&this.shouldShareStructure&&!this.shouldShareStructure(t)?((i=u.nextOwnId)<w||(i=v),u.nextOwnId=i+1):(i>=w&&(i=v),u.nextId=i+1);let n=t.highByte=i>=96&&_?i-96>>5:-1;e[rw]=i,e.__keys__=t,u[i-64]=t,i<v?(t.isShared=!0,u.sharedLength=i-63,r=!0,n>=0?(o[rb++]=(31&i)+96,o[rb++]=n):o[rb++]=i):(n>=0?(o[rb++]=213,o[rb++]=114,o[rb++]=(31&i)+96,o[rb++]=n):(o[rb++]=212,o[rb++]=114,o[rb++]=i),s&&(S+=x*s),E.length>=b&&(E.shift()[rw]=0),E.push(e),I(t))},N=(e,r,s,i)=>{let n=o,l=rb,c=h,u=t;rb=0,t=0,(o=a)||(a=o=new rg(8192)),h=o.length-10,R(e,r,i),a=o;let f=rb;if(o=n,rb=l,h=c,t=u,f>1){let e=rb+f-1;e>h&&$(e);let r=s+t;o.copyWithin(r+f,r+1,rb),o.set(a.slice(0,f),r),rb=e}else o[s+t]=a[0]},L=e=>{let s=c(e,o,t,rb,u,$,(e,t,s)=>{if(s)return r=!0;rb=t;let i=o;return(I(e),C(),i!==o)?{position:rb,targetView:l,target:o}:rb},this);if(0===s)return D(e);rb=s}}useBuffer(e){(o=e).dataView||(o.dataView=new DataView(o.buffer,o.byteOffset,o.byteLength)),rb=0}set position(e){rb=e}get position(){return rb}set buffer(e){o=e}get buffer(){return o}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}}function rS(e,t,r,s){let i=e.byteLength;if(i+1<256){var{target:n,position:o}=r(4+i);n[o++]=199,n[o++]=i+1}else if(i+1<65536){var{target:n,position:o}=r(5+i);n[o++]=200,n[o++]=i+1>>8,n[o++]=i+1&255}else{var{target:n,position:o,targetView:a}=r(7+i);n[o++]=201,a.setUint32(o,i+1),o+=4}n[o++]=116,n[o++]=t,e.buffer||(e=new Uint8Array(e)),n.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),o)}function rx(e,t){let r=e.byteLength;if(r<256){var s,i,{target:s,position:i}=t(r+2);s[i++]=196,s[i++]=r}else if(r<65536){var{target:s,position:i}=t(r+3);s[i++]=197,s[i++]=r>>8,s[i++]=255&r}else{var{target:s,position:i,targetView:n}=t(r+5);s[i++]=198,n.setUint32(i,r),i+=4}s.set(e,i)}function rC(e,t,r){if(r_.length>0){l.setUint32(r_.position+e,rb+r-r_.position-e),r_.stringsPosition=rb-e;let s=r_;r_=null,t(s[0]),t(s[1])}}function rk(e,t){return e.isCompatible=e=>{let r=!e||(t.lastNamedStructuresLength||0)===e.length;return r||t._mergeStructures(e),r},e}n=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,tj],i=[{pack(e,t,r){let s=e.getTime()/1e3;if((this.useTimestamp32||0===e.getMilliseconds())&&s>=0&&s<4294967296){let{target:e,targetView:r,position:i}=t(6);e[i++]=214,e[i++]=255,r.setUint32(i,s)}else if(s>0&&s<4294967296){let{target:r,targetView:i,position:n}=t(10);r[n++]=215,r[n++]=255,i.setUint32(n,4e6*e.getMilliseconds()+(s/1e3/4294967296>>0)),i.setUint32(n+4,s)}else if(isNaN(s)){if(this.onInvalidDate)return t(0),r(this.onInvalidDate());let{target:e,targetView:s,position:i}=t(3);e[i++]=212,e[i++]=255,e[i++]=255}else{let{target:r,targetView:i,position:n}=t(15);r[n++]=199,r[n++]=12,r[n++]=255,i.setUint32(n,1e6*e.getMilliseconds()),i.setBigInt64(n+4,BigInt(Math.floor(s)))}}},{pack(e,t,r){if(this.setAsEmptyObject)return t(0),r({});let s=Array.from(e),{target:i,position:n}=t(this.moreTypes?3:0);this.moreTypes&&(i[n++]=212,i[n++]=115,i[n++]=0),r(s)}},{pack(e,t,r){let{target:s,position:i}=t(this.moreTypes?3:0);this.moreTypes&&(s[i++]=212,s[i++]=101,s[i++]=0),r([e.name,e.message,e.cause])}},{pack(e,t,r){let{target:s,position:i}=t(this.moreTypes?3:0);this.moreTypes&&(s[i++]=212,s[i++]=120,s[i++]=0),r([e.source,e.flags])}},{pack(e,t){this.moreTypes?rS(e,16,t):rx(rp?Buffer.from(e):new Uint8Array(e),t)}},{pack(e,t){let r=e.constructor;r!==rm&&this.moreTypes?rS(e,ro.indexOf(r.name),t):rx(e,t)}},{pack(e,t){let{target:r,position:s}=t(1);r[s]=193}}];let rI=new rE({useRecords:!1});rI.pack,rI.pack;let{NEVER:rO,ALWAYS:rT,DECIMAL_ROUND:rA,DECIMAL_FIT:rD}={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4},r$=512,rR=1024,rN=2048,rL=["num","object","string","ascii"];rL[16]="date";let rP=[!1,!0,!0,!1,!1,!0,!0,!1];try{Function(""),u=!0}catch(e){}let rM="undefined"!=typeof Buffer;try{d=new TextEncoder}catch(e){}let rB=rM?function(e,t,r){return e.utf8Write(t,r,e.byteLength-r)}:!!d&&!!d.encodeInto&&function(e,t,r){return d.encodeInto(t,e.subarray(r)).written};function rU(e,t,r,s){let i;return(i=e.ascii8||e.num8)?(r.setInt8(t,s,!0),f=t+1,i):(i=e.string16||e.object16)?(r.setInt16(t,s,!0),f=t+2,i):(i=e.num32)?(r.setUint32(t,3758096640+s,!0),f=t+4,i):(i=e.num64)?(r.setFloat64(t,NaN,!0),r.setInt8(t,s),f=t+8,i):void(f=t)}function rj(e,t,r){let s=rL[t]+(r<<3),i=e[s]||(e[s]=Object.create(null));return i.__type=t,i.__size=r,i.__parent=e,i}Symbol("type"),Symbol("parent"),m=function e(t,r,s,i,n,o,a,l){let h,c=l.typedStructs||(l.typedStructs=[]),u=r.dataView,d=(c.lastStringStart||100)+i,p=r.length-10,g=i;i>p&&(u=(r=o(i)).dataView,i-=s,g-=s,d-=s,s=0,p=r.length-10);let m,y=d,b=c.transitions||(c.transitions=Object.create(null)),_=c.nextId||c.length,v=_<15?1:_<240?2:_<61440?3:_<15728640?4:0;if(0===v)return 0;i+=v;let w=[],E=0;for(let e in t){let n=t[e],l=b[e];switch(l||(b[e]=l={key:e,parent:b,enumerationOffset:0,ascii0:null,ascii8:null,num8:null,string16:null,object16:null,num32:null,float64:null,date64:null}),i>p&&(u=(r=o(i)).dataView,i-=s,g-=s,d-=s,y-=s,s=0,p=r.length-10),typeof n){case"number":if(_<200||!l.num64){if(n>>0===n&&n<536870912&&n>-520093696){n<246&&n>=0&&(l.num8&&!(_>200&&l.num32)||n<32&&!l.num32)?(b=l.num8||rj(l,0,1),r[i++]=n):(b=l.num32||rj(l,0,4),u.setUint32(i,n,!0),i+=4);break}if(n<4294967296&&n>=-2147483648&&(u.setFloat32(i,n,!0),rP[r[i+3]>>>5])){let e;if((e=n*ru[(127&r[i+3])<<1|r[i+2]>>7])>>0===e){b=l.num32||rj(l,0,4),i+=4;break}}}b=l.num64||rj(l,0,8),u.setFloat64(i,n,!0),i+=8;break;case"string":let v,S=n.length;if(m=y-d,(S<<2)+y>p&&(u=(r=o((S<<2)+y)).dataView,i-=s,g-=s,d-=s,y-=s,s=0,p=r.length-10),S>65280+m>>2){w.push(e,n,i-g);break}let x=y;if(S<64){let e,t,s;for(e=0;e<S;e++)(t=n.charCodeAt(e))<128?r[y++]=t:(t<2048?(v=!0,r[y++]=t>>6|192):((64512&t)==55296&&(64512&(s=n.charCodeAt(e+1)))==56320?(v=!0,t=65536+((1023&t)<<10)+(1023&s),e++,r[y++]=t>>18|240,r[y++]=t>>12&63|128):(v=!0,r[y++]=t>>12|224),r[y++]=t>>6&63|128),r[y++]=63&t|128)}else y+=rB(r,n,y),v=y-x>S;if(m<160||m<246&&(l.ascii8||l.string8)){if(v)(b=l.string8)||(c.length>10&&(b=l.ascii8)?(b.__type=2,l.ascii8=null,l.string8=b,a(null,0,!0)):b=rj(l,2,1));else if(0!==m||h)(b=l.ascii8)||c.length>10&&(b=l.string8)||(b=rj(l,3,1));else{h=!0,b=l.ascii0||rj(l,3,0);break}r[i++]=m}else b=l.string16||rj(l,2,2),u.setUint16(i,m,!0),i+=2;break;case"object":n?n.constructor===Date?(b=l.date64||rj(l,16,8),u.setFloat64(i,n.getTime(),!0),i+=8):w.push(e,n,E):(l=rU(l,i,u,-10))?(b=l,i=f):w.push(e,n,E);break;case"boolean":b=l.num8||l.ascii8||rj(l,0,1),r[i++]=n?249:248;break;case"undefined":(l=rU(l,i,u,-9))?(b=l,i=f):w.push(e,n,E);break;default:w.push(e,n,E)}E++}for(let e=0,t=w.length;e<t;){let t,n=w[e++],o=w[e++],l=w[e++],h=b[n];if(h||(b[n]=h={key:n,parent:b,enumerationOffset:l-E,ascii0:null,ascii8:null,num8:null,string16:null,object16:null,num32:null,float64:null}),o){let e;(m=y-d)<65280?(b=h.object16)?e=2:(b=h.object32)?e=4:(b=rj(h,1,2),e=2):(b=h.object32||rj(h,1,4),e=4),"object"==typeof(t=a(o,y))?(y=t.position,u=t.targetView,r=t.target,d-=s,i-=s,g-=s,s=0):y=t,2===e?(u.setUint16(i,m,!0),i+=2):(u.setUint32(i,m,!0),i+=4)}else b=h.object16||rj(h,1,2),u.setInt16(i,null===o?-10:-9,!0),i+=2;E++}let S=b[rw];if(null==S){let e;S=l.typedStructs.length;let t=[],r=b;for(;void 0!==(e=r.__type);){let s=[e,r.__size,(r=r.__parent).key];r.enumerationOffset&&s.push(r.enumerationOffset),t.push(s),r=r.parent}t.reverse(),b[rw]=S,l.typedStructs[S]=t,a(null,0,!0)}switch(v){case 1:if(S>=16)return 0;r[g]=S+32;break;case 2:if(S>=256)return 0;r[g]=56,r[g+1]=S;break;case 3:if(S>=65536)return 0;r[g]=57,u.setUint16(g+1,S,!0);break;case 4:if(S>=16777216)return 0;u.setUint32(g,(S<<8)+58,!0)}if(i<d){if(d===y)return i;r.copyWithin(i,d,y),y+=i-d,c.lastStringStart=i-g}else if(i>d)return d===y?i:(c.lastStringStart=i-g,e(t,r,s,g,n,o,a,l));return y},y=function(e,t){if(t.typedStructs){let r=new Map;r.set("named",e),r.set("typed",t.typedStructs),e=r}let r=t.lastTypedStructuresLength||0;return e.isCompatible=e=>{let s=!0;return e instanceof Map?((e.get("named")||[]).length!==(t.lastNamedStructuresLength||0)&&(s=!1),(e.get("typed")||[]).length!==r&&(s=!1)):(e instanceof Array||Array.isArray(e))&&e.length!==(t.lastNamedStructuresLength||0)&&(s=!1),s||t._mergeStructures(e),s},t.lastTypedStructuresLength=t.typedStructs&&t.typedStructs.length,e},c=m,rk=y;var rF=Symbol.for("source");function rV(e){switch(e){case 246:return null;case 247:return;case 248:return!1;case 249:return!0}throw Error("Unknown constant")}b=function(e,t,r,s){let i=e[t++]-32;if(i>=24)switch(i){case 24:i=e[t++];break;case 25:i=e[t++]+(e[t++]<<8);break;case 26:i=e[t++]+(e[t++]<<8)+(e[t++]<<16);break;case 27:i=e[t++]+(e[t++]<<8)+(e[t++]<<16)+(e[t++]<<24)}let n=s.typedStructs&&s.typedStructs[i];if(!n){if(e=Uint8Array.prototype.slice.call(e,t,r),r-=t,t=0,!s.getStructures)throw Error(`Reference to shared structure ${i} without getStructures method`);if(s._mergeStructures(s.getStructures()),!s.typedStructs)throw Error("Could not find any shared typed structures");if(s.lastTypedStructuresLength=s.typedStructs.length,!(n=s.typedStructs[i]))throw Error("Could not find typed structure "+i)}var o=n.construct;if(!o){let e;var a=(o=n.construct=function(){}).prototype;let t=[],r=0;for(let i=0,o=n.length;i<o;i++){let o,a;let[l,h,c,u]=n[i];"__proto__"===c&&(c="__proto_");let f={key:c,offset:r};switch(u?t.splice(i+u,0,f):t.push(f),h){case 0:o=()=>0;break;case 1:o=(e,t)=>{let r=e.bytes[t+f.offset];return r>=246?rV(r):r};break;case 2:o=(e,t)=>{let r=e.bytes,s=(r.dataView||(r.dataView=new DataView(r.buffer,r.byteOffset,r.byteLength))).getUint16(t+f.offset,!0);return s>=65280?rV(255&s):s};break;case 4:o=(e,t)=>{let r=e.bytes,s=(r.dataView||(r.dataView=new DataView(r.buffer,r.byteOffset,r.byteLength))).getUint32(t+f.offset,!0);return s>=4294967040?rV(255&s):s}}switch(f.getRef=o,r+=h,l){case 3:e&&!e.next&&(e.next=f),e=f,f.multiGetCount=0,a=function(e){let t=e.bytes,s=e.position,i=r+s,n=o(e,s);if("number"!=typeof n)return n;let a,l=f.next;for(;l&&"number"!=typeof(a=l.getRef(e,s));)a=null,l=l.next;return(null==a&&(a=e.bytesEnd-i),e.srcString)?e.srcString.slice(n,a):function(e,t,r){let s=P;P=e,tD=t;try{return t2(r)}finally{P=s}}(t,n+i,a-n)};break;case 2:case 1:e&&!e.next&&(e.next=f),e=f,a=function(e){let t=e.position,i=r+t,n=o(e,t);if("number"!=typeof n)return n;let a=e.bytes,h,c=f.next;for(;c&&"number"!=typeof(h=c.getRef(e,t));)h=null,c=c.next;if(null==h&&(h=e.bytesEnd-i),2===l)return a.toString("utf8",n+i,h+i);p=e;try{return s.unpack(a,{start:n+i,end:h+i})}finally{p=null}};break;case 0:switch(h){case 4:a=function(e){let t=e.bytes,r=t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength)),s=e.position+f.offset,i=r.getInt32(s,!0);if(i<536870912){if(i>-520093696)return i;if(i>-536870912)return rV(255&i)}let n=r.getFloat32(s,!0),o=ru[(127&t[s+3])<<1|t[s+2]>>7];return(o*n+(n>0?.5:-.5)>>0)/o};break;case 8:a=function(e){let t=e.bytes,r=(t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))).getFloat64(e.position+f.offset,!0);if(isNaN(r)){let r=t[e.position+f.offset];if(r>=246)return rV(r)}return r};break;case 1:a=function(e){let t=e.bytes[e.position+f.offset];return t<246?t:rV(t)}}break;case 16:a=function(e){let t=e.bytes;return new Date((t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))).getFloat64(e.position+f.offset,!0))}}f.get=a}if(u){let e,r=[],i=[],n=0;for(let o of t){if(s.alwaysLazyProperty&&s.alwaysLazyProperty(o.key)){e=!0;continue}Object.defineProperty(a,o.key,{get:function(e){return function(){return e(this[rF])}}(o.get),enumerable:!0});let t="v"+n++;i.push(t),r.push("["+JSON.stringify(o.key)+"]:"+t+"(s)")}e&&r.push("__proto__:this");let o=Function(...i,"return function(s){return{"+r.join(",")+"}}").apply(null,t.map(e=>e.get));Object.defineProperty(a,"toJSON",{value(e){return o.call(this,this[rF])}})}else Object.defineProperty(a,"toJSON",{value(e){let r={};for(let e=0,s=t.length;e<s;e++){let s=t[e].key;r[s]=this[s]}return r}})}var l=new o;return l[rF]={bytes:e,position:t,srcString:"",bytesEnd:r},l},_=function(e){if(!(e instanceof Map))return e;let t=e.get("typed")||[];Object.isFrozen(t)&&(t=t.map(e=>e.slice(0)));let r=e.get("named"),s=Object.create(null);for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s;for(let[e,t,s]of r){let r=i[s];r||(i[s]=r={key:s,parent:i,enumerationOffset:0,ascii0:null,ascii8:null,num8:null,string16:null,object16:null,num32:null,float64:null,date64:null}),i=rj(r,e,t)}i[rw]=e}return t.transitions=s,this.typedStructs=t,this.lastTypedStructuresLength=t.length,r},v=function(){p&&(p.bytes=Uint8Array.prototype.slice.call(p.bytes,p.position,p.bytesEnd),p.position=0,p.bytesEnd=p.bytes.length)},W=b,z=_,q=v,r(12781);var rW=r(98188);if(!(void 0!==process.env.MSGPACKR_NATIVE_ACCELERATION_DISABLED&&"true"===process.env.MSGPACKR_NATIVE_ACCELERATION_DISABLED.toLowerCase())){let e;try{"function"==typeof require?e=require("msgpackr-extract"):e=(0,rW.createRequire)("file:///app/frontend/node_modules/@colyseus/msgpackr/node-index.js")("msgpackr-extract"),e&&function(e){function t(t){return function(r){let s=tR[tN++];if(null==s){if(j)return t2(r);let i=P.byteOffset,n=e(tD-t+i,M+i,P.buffer);if("string"==typeof n)s=n,tR=t$;else if(tN=1,tM=1,void 0===(s=(tR=n)[0]))throw Error("Unexpected end of buffer")}let i=s.length;return i<=r?(tD+=r,s):(U=s,tP=tD,tM=tD+i,tD+=r,s.slice(0,r))}}tX=t(1),tQ=t(2),t0=t(3),t1=t(5)}(e.extractStrings)}catch(e){}}class rz{roomId;sessionId;reconnectionToken;name;connection;onStateChange=tT();onError=tT();onLeave=tT();onJoin=tT();serializerId;serializer;hasJoined=!1;rootSchema;onMessageHandlers=tI();packr;constructor(e,t){this.roomId=null,this.name=e,this.packr=new rE,this.packr.encode(void 0),t&&(this.serializer=new(tk("schema")),this.rootSchema=t,this.serializer.state=new t),this.onError((e,t)=>console.warn?.(`colyseus.js - onError => (${e}) ${t}`)),this.onLeave(()=>this.removeAllListeners())}connect(e,t,r=this,s,i){let n=new tx(s.protocol);if(r.connection=n,n.events.onmessage=rz.prototype.onMessageCallback.bind(r),n.events.onclose=function(e){if(!r.hasJoined){console.warn?.(`Room connection was closed unexpectedly (${e.code}): ${e.reason}`),r.onError.invoke(e.code,e.reason);return}e.code===w.DEVMODE_RESTART&&t?t():(r.onLeave.invoke(e.code,e.reason),r.destroy())},n.events.onerror=function(e){console.warn?.(`Room, onError (${e.code}): ${e.reason}`),r.onError.invoke(e.code,e.reason)},"h3"===s.protocol){let t=new URL(e);n.connect(t.origin,s)}else n.connect(e,i)}leave(e=!0){return new Promise(t=>{this.onLeave(e=>t(e)),this.connection?e?(this.packr.buffer[0]=R.LEAVE_ROOM,this.connection.send(this.packr.buffer.subarray(0,1))):this.connection.close():this.onLeave.invoke(w.CONSENTED)})}onMessage(e,t){return this.onMessageHandlers.on(this.getMessageHandlerKey(e),t)}send(e,t){let r={offset:1};this.packr.buffer[0]=R.ROOM_DATA,"string"==typeof e?ek.string(this.packr.buffer,e,r):ek.number(this.packr.buffer,e,r),this.packr.position=0;let s=void 0!==t?this.packr.pack(t,2048+r.offset):this.packr.buffer.subarray(0,r.offset);this.connection.send(s)}sendUnreliable(e,t){let r={offset:1};this.packr.buffer[0]=R.ROOM_DATA,"string"==typeof e?ek.string(this.packr.buffer,e,r):ek.number(this.packr.buffer,e,r),this.packr.position=0;let s=void 0!==t?this.packr.pack(t,2048+r.offset):this.packr.buffer.subarray(0,r.offset);this.connection.sendUnreliable(s)}sendBytes(e,t){let r={offset:1};if(this.packr.buffer[0]=R.ROOM_DATA_BYTES,"string"==typeof e?ek.string(this.packr.buffer,e,r):ek.number(this.packr.buffer,e,r),t.byteLength+r.offset>this.packr.buffer.byteLength){let e=new Uint8Array(r.offset+t.byteLength);e.set(this.packr.buffer),this.packr.useBuffer(e)}this.packr.buffer.set(t,r.offset),this.connection.send(this.packr.buffer.subarray(0,r.offset+t.byteLength))}get state(){return this.serializer.getState()}removeAllListeners(){this.onJoin.clear(),this.onStateChange.clear(),this.onError.clear(),this.onLeave.clear(),this.onMessageHandlers.events={},this.serializer instanceof tA&&(this.serializer.decoder.root.callbacks={})}onMessageCallback(e){let t=new Uint8Array(e.data),r={offset:1},s=t[0];if(s===R.JOIN_ROOM){let e=ez.utf8Read(t,r,t[r.offset++]);if(this.serializerId=ez.utf8Read(t,r,t[r.offset++]),!this.serializer){let e=tk(this.serializerId);this.serializer=new e}t.byteLength>r.offset&&this.serializer.handshake&&this.serializer.handshake(t,r),this.reconnectionToken=`${this.roomId}:${e}`,this.hasJoined=!0,this.onJoin.invoke(),this.packr.buffer[0]=R.JOIN_ROOM,this.connection.send(this.packr.buffer.subarray(0,1))}else if(s===R.ERROR){let e=ez.number(t,r),s=ez.string(t,r);this.onError.invoke(e,s)}else if(s===R.LEAVE_ROOM)this.leave();else if(s===R.ROOM_STATE)this.serializer.setState(t,r),this.onStateChange.invoke(this.serializer.getState());else if(s===R.ROOM_STATE_PATCH)this.serializer.patch(t,r),this.onStateChange.invoke(this.serializer.getState());else if(s===R.ROOM_DATA){let e=ez.stringCheck(t,r)?ez.string(t,r):ez.number(t,r),s=t.byteLength>r.offset?rd(t,{start:r.offset}):void 0;this.dispatchMessage(e,s)}else if(s===R.ROOM_DATA_BYTES){let e=ez.stringCheck(t,r)?ez.string(t,r):ez.number(t,r);this.dispatchMessage(e,t.subarray(r.offset))}}dispatchMessage(e,t){let r=this.getMessageHandlerKey(e);this.onMessageHandlers.events[r]?this.onMessageHandlers.emit(r,t):this.onMessageHandlers.events["*"]?this.onMessageHandlers.emit("*",e,t):console.warn?.(`colyseus.js: onMessage() not registered for type '${e}'.`)}destroy(){this.serializer&&this.serializer.teardown()}getMessageHandlerKey(e){switch(typeof e){case"string":return e;case"number":return`i${e}`;default:throw Error("invalid message type.")}}}var rq=r(95687),rH=r(13685),rG=r(57310);function rJ(e,t,r){(r=r||Error(t.statusMessage)).statusMessage=t.statusMessage,r.statusCode=t.statusCode,r.headers=t.headers,r.data=t.data,e(r)}function rK(e,t,r={}){return new Promise((s,i)=>{let n,o,a,l=!1,h="",{redirect:c=!0}=r;r.method=e,t&&t.toJSON&&(t=t.toJSON()),Object.assign(r,"string"==typeof t?(0,rG.parse)(t):t),r.agent="http:"===r.protocol?rH.globalAgent:void 0,(n=(0,rq.request)(r,t=>{if(t.statusCode>300&&c&&t.headers.location)return r.path=(0,rG.resolve)(r.path,t.headers.location),rK(e,r.path.startsWith("/")?r:r.path,r).then(s,i);t.on("data",e=>{h+=e}),t.on("end",()=>{if((o=t.headers["content-type"])&&h&&o.includes("application/json"))try{h=JSON.parse(h,r.reviver)}catch(e){return rJ(i,t,e)}t.data=h,t.statusCode>=400?rJ(i,t):s(t)})})).on("timeout",function(){l=!0,n.abort()}),n.on("error",e=>{e.timeout=l,e.aborted=a,i(e)}),r.signal&&r.signal.addEventListener("abort",function(){a=!0,n.destroy()}),r.body&&((o="object"==typeof r.body&&!Buffer.isBuffer(r.body))&&n.setHeader("content-type","application/json"),o=o?JSON.stringify(r.body):r.body,n.setHeader("content-length",Buffer.byteLength(o)),n.write(o)),n.end()})}let rY=rK.bind(rK,"GET"),rZ=rK.bind(rK,"POST"),rX=rK.bind(rK,"PATCH"),rQ=rK.bind(rK,"DELETE"),r0=rK.bind(rK,"PUT");class r1{client;headers;authToken;constructor(e,t={}){this.client=e,this.headers=t}get(e,t={}){return this.request("get",e,t)}post(e,t={}){return this.request("post",e,t)}del(e,t={}){return this.request("del",e,t)}put(e,t={}){return this.request("put",e,t)}request(e,t,r={}){return H[e](this.client.getHttpEndpoint(t),this.getOptions(r)).catch(e=>{if(e.aborted)throw new J("Request aborted");let t=e.statusCode,r=e.data?.error||e.statusMessage||e.message;if(!t&&!r)throw e;throw new G(t,r)})}getOptions(e){return e.headers=Object.assign({},this.headers,e.headers),this.authToken&&(e.headers.Authorization=`Bearer ${this.authToken}`),"undefined"!=typeof cc&&cc.sys&&cc.sys.isNative||(e.withCredentials=!0),e}}function r2(){if(!g)try{g="undefined"!=typeof cc&&cc.sys&&cc.sys.localStorage?cc.sys.localStorage:window.localStorage}catch(e){}return g||void 0===globalThis.indexedDB||(g=new r6),g||(g={cache:{},setItem:function(e,t){this.cache[e]=t},getItem:function(e){this.cache[e]},removeItem:function(e){delete this.cache[e]}}),g}class r6{dbPromise=new Promise(e=>{let t=indexedDB.open("_colyseus_storage",1);t.onupgradeneeded=()=>t.result.createObjectStore("store"),t.onsuccess=()=>e(t.result)});async tx(e,t){return t((await this.dbPromise).transaction("store",e).objectStore("store"))}setItem(e,t){return this.tx("readwrite",r=>r.put(t,e)).then()}async getItem(e){let t=await this.tx("readonly",t=>t.get(e));return new Promise(e=>{t.onsuccess=()=>e(t.result)})}removeItem(e){return this.tx("readwrite",t=>t.delete(e)).then()}}class r4{http;settings={path:"/auth",key:"colyseus-auth-token"};#e=!1;#t;#r=void 0;#s=tI();constructor(e){this.http=e,function(e,t){let r=r2().getItem(e);"undefined"!=typeof Promise&&r instanceof Promise?r.then(e=>t(e)):t(r)}(this.settings.key,e=>this.token=e)}set token(e){this.http.authToken=e}get token(){return this.http.authToken}onChange(e){let t=this.#s.on("change",e);return this.#e||(this.#t=new Promise((e,t)=>{this.getUserData().then(e=>{this.emitChange({...e,token:this.token})}).catch(e=>{this.emitChange({user:null,token:void 0})}).finally(()=>{e()})})),this.#e=!0,t}async getUserData(){if(this.token)return(await this.http.get(`${this.settings.path}/userdata`)).data;throw Error("missing auth.token")}async registerWithEmailAndPassword(e,t,r){let s=(await this.http.post(`${this.settings.path}/register`,{body:{email:e,password:t,options:r}})).data;return this.emitChange(s),s}async signInWithEmailAndPassword(e,t){let r=(await this.http.post(`${this.settings.path}/login`,{body:{email:e,password:t}})).data;return this.emitChange(r),r}async signInAnonymously(e){let t=(await this.http.post(`${this.settings.path}/anonymous`,{body:{options:e}})).data;return this.emitChange(t),t}async sendPasswordResetEmail(e){return(await this.http.post(`${this.settings.path}/forgot-password`,{body:{email:e}})).data}async signInWithProvider(e,t={}){return new Promise((r,s)=>{let i=t.width||480,n=t.height||768,o=this.token?`?token=${this.token}`:"",a=`Login with ${e[0].toUpperCase()+e.substring(1)}`,l=this.http.client.getHttpEndpoint(`${t.prefix||`${this.settings.path}/provider`}/${e}${o}`),h=screen.width/2-i/2,c=screen.height/2-n/2;this.#r=window.open(l,a,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+i+", height="+n+", top="+c+", left="+h);let u=e=>{(void 0!==e.data.user||void 0!==e.data.token)&&(clearInterval(f),this.#r.close(),this.#r=void 0,window.removeEventListener("message",u),void 0!==e.data.error?s(e.data.error):(r(e.data),this.emitChange(e.data)))},f=setInterval(()=>{(!this.#r||this.#r.closed)&&(this.#r=void 0,s("cancelled"),window.removeEventListener("message",u))},200);window.addEventListener("message",u)})}async signOut(){this.emitChange({user:null,token:null})}emitChange(e){if(void 0!==e.token){var t,r,s;(this.token=e.token,null===e.token)?(t=this.settings.key,r2().removeItem(t)):(r=this.settings.key,s=e.token,r2().setItem(r,s))}this.#s.emit("change",e)}}function r3(e){let t=window?.location?.hostname||"localhost",r=e.hostname.split("."),s=e.hostname.includes("trycloudflare.com")||e.hostname.includes("discordsays.com")||!(r.length>2)?"":`/${r[0]}`;return e.pathname.startsWith("/.proxy")?`${e.protocol}//${t}${s}${e.pathname}${e.search}`:`${e.protocol}//${t}/.proxy/colyseus${s}${e.pathname}${e.search}`}class r8 extends Error{code;constructor(e,t){super(e),this.code=t,this.name="MatchMakeError",Object.setPrototypeOf(this,r8.prototype)}}let r5="undefined"!=typeof window&&void 0!==window?.location?.hostname?`${window.location.protocol.replace("http","ws")}//${window.location.hostname}${window.location.port&&`:${window.location.port}`}`:"ws://127.0.0.1:2567";class r9{static VERSION="0.16.19";http;auth;settings;urlBuilder;constructor(e=r5,t){if("string"==typeof e){let t=e.startsWith("/")?new URL(e,r5):new URL(e),r="https:"===t.protocol||"wss:"===t.protocol,s=Number(t.port||(r?443:80));this.settings={hostname:t.hostname,pathname:t.pathname,port:s,secure:r,searchParams:t.searchParams.toString()||void 0}}else void 0===e.port&&(e.port=e.secure?443:80),void 0===e.pathname&&(e.pathname=""),this.settings=e;this.settings.pathname.endsWith("/")&&(this.settings.pathname=this.settings.pathname.slice(0,-1)),this.http=new r1(this,t?.headers||{}),this.auth=new r4(this.http),this.urlBuilder=t?.urlBuilder,!this.urlBuilder&&"undefined"!=typeof window&&window?.location?.hostname?.includes("discordsays.com")&&(this.urlBuilder=r3,console.log("Colyseus SDK: Discord Embedded SDK detected. Using custom URL builder."))}async joinOrCreate(e,t={},r){return await this.createMatchMakeRequest("joinOrCreate",e,t,r)}async create(e,t={},r){return await this.createMatchMakeRequest("create",e,t,r)}async join(e,t={},r){return await this.createMatchMakeRequest("join",e,t,r)}async joinById(e,t={},r){return await this.createMatchMakeRequest("joinById",e,t,r)}async reconnect(e,t){if("string"==typeof e&&"string"==typeof t)throw Error("DEPRECATED: .reconnect() now only accepts 'reconnectionToken' as argument.\nYou can get this token from previously connected `room.reconnectionToken`");let[r,s]=e.split(":");if(!r||!s)throw Error("Invalid reconnection token format.\nThe format should be roomId:reconnectionToken");return await this.createMatchMakeRequest("reconnect",r,{reconnectionToken:s},t)}async consumeSeatReservation(e,t,r){let s=this.createRoom(e.room.name,t);s.roomId=e.room.roomId,s.sessionId=e.sessionId;let i={sessionId:s.sessionId};e.reconnectionToken&&(i.reconnectionToken=e.reconnectionToken);let n=r||s;return s.connect(this.buildEndpoint(e.room,i,e.protocol),e.devMode&&(async()=>{console.info(`[Colyseus devMode]: ${String.fromCodePoint(128260)} Re-establishing connection with room id '${s.roomId}'...`);let r=0,i=async()=>{r++;try{await this.consumeSeatReservation(e,t,n),console.info(`[Colyseus devMode]: ${String.fromCodePoint(9989)} Successfully re-established connection with room '${s.roomId}'`)}catch(e){r<8?(console.info(`[Colyseus devMode]: ${String.fromCodePoint(128260)} retrying... (${r} out of 8)`),setTimeout(i,2e3)):console.info(`[Colyseus devMode]: ${String.fromCodePoint(10060)} Failed to reconnect. Is your server running? Please check server logs.`)}};setTimeout(i,2e3)}),n,e,this.http.headers),new Promise((e,t)=>{let r=(e,r)=>t(new G(e,r));n.onError.once(r),n.onJoin.once(()=>{n.onError.remove(r),e(n)})})}async createMatchMakeRequest(e,t,r={},s,i){let n=(await this.http.post(`matchmake/${e}/${t}`,{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)})).data;if(n.error)throw new r8(n.error,n.code);return"reconnect"===e&&(n.reconnectionToken=r.reconnectionToken),await this.consumeSeatReservation(n,s,i)}createRoom(e,t){return new rz(e,t)}buildEndpoint(e,t={},r="ws"){let s=this.settings.searchParams||"";for(let e in this.http.authToken&&(t._authToken=this.http.authToken),t)t.hasOwnProperty(e)&&(s+=(s?"&":"")+`${e}=${t[e]}`);"h3"===r&&(r="http");let i=this.settings.secure?`${r}s://`:`${r}://`;e.publicAddress?i+=`${e.publicAddress}`:i+=`${this.settings.hostname}${this.getEndpointPort()}${this.settings.pathname}`;let n=`${i}/${e.processId}/${e.roomId}?${s}`;return this.urlBuilder?this.urlBuilder(new URL(n)):n}getHttpEndpoint(e=""){let t=e.startsWith("/")?e:`/${e}`,r=`${this.settings.secure?"https":"http"}://${this.settings.hostname}${this.getEndpointPort()}${this.settings.pathname}${t}`;return this.settings.searchParams&&(r+=`?${this.settings.searchParams}`),this.urlBuilder?this.urlBuilder(new URL(r)):r}getEndpointPort(){return 80!==this.settings.port&&443!==this.settings.port?`:${this.settings.port}`:""}}class r7{setState(e){}getState(){return null}patch(e){}teardown(){}handshake(e){}}tC.schema=tA,tC.none=r7;class se{constructor(){this.client=null,this.room=null,this.isConnected=!1,this.endpoint="wss://au-syd-ab3eaf4e.colyseus.cloud",this.fallbackMode=!1,console.log("\uD83C\uDFAE TurfLoot Colyseus Client initialized"),console.log(`🔗 Primary Endpoint: ${this.endpoint}`)}async joinArena({privyUserId:e,playerName:t=null}){try{console.log("\uD83D\uDE80 Attempting Colyseus Cloud connection..."),console.log(`🔗 Endpoint: ${this.endpoint}`),console.log(`👤 User: ${e}, Name: ${t}`),this.client=new r9(this.endpoint);let r=new Promise((e,t)=>setTimeout(()=>t(Error("Connection timeout after 15 seconds")),15e3));console.log("\uD83C\uDFDF️ Looking for available arena rooms...");try{console.log("\uD83D\uDD0D Attempting to join existing arena room...");let s=this.client.join("arena",{privyUserId:e,playerName:t||`Player_${Math.random().toString(36).substring(7)}`});this.room=await Promise.race([s,r]),console.log("✅ Successfully joined existing arena room!")}catch(i){console.log("\uD83C\uDFD7️ No available rooms found, creating new arena room...");let s=this.client.create("arena",{privyUserId:e,playerName:t||`Player_${Math.random().toString(36).substring(7)}`});this.room=await Promise.race([s,r]),console.log("✅ Successfully created new arena room!")}return this.isConnected=!0,console.log("✅ Connected to Colyseus Cloud arena room"),console.log(`🎮 Room ID: ${this.room.roomId}`),console.log(`👥 Session ID: ${this.room.sessionId}`),this.setupEventListeners(),this.room}catch(e){throw console.error("❌ Colyseus connection failed:",e.message),console.error("\uD83D\uDD0D Full error details:",e),this.isConnected=!1,Error(`Colyseus connection failed: ${e.message}`)}}async createLocalMultiplayerRoom({privyUserId:e,playerName:t=null}){console.log("\uD83C\uDFE0 Creating local multiplayer room...");try{let t={id:`local_room_${Date.now()}`,roomId:`local_room_${Date.now()}`,sessionId:`session_${e}`,state:{players:new Map,coins:new Map,viruses:new Map},onStateChange:e=>{console.log("\uD83D\uDCCA Local room state change listener registered"),this.stateChangeCallback=e,setTimeout(()=>{this.simulateMultiplayerState()},1e3)},onError:e=>{this.errorCallback=e},onLeave:e=>{this.leaveCallback=e},send:(e,t)=>{console.log(`📤 Sending ${e}:`,t)},leave:()=>{console.log("\uD83D\uDC4B Leaving local multiplayer room"),this.isConnected=!1}};return this.room=t,this.isConnected=!0,this.fallbackMode=!0,console.log("✅ Local multiplayer room created"),console.log(`🎮 Local Room ID: ${t.roomId}`),t}catch(e){throw console.error("❌ Failed to create local multiplayer room:",e),e}}simulateMultiplayerState(){if(!this.stateChangeCallback||!this.room)return;let e={players:new Map,coins:new Map,viruses:new Map,size:0};e.players.set(this.room.sessionId,{x:1e3,y:1e3,radius:20,mass:20,name:"You",color:"#4ECDC4",score:0,alive:!0}),e.players.set("mock_player_1",{x:800,y:800,radius:15,mass:15,name:"Player 1",color:"#FF6B6B",score:50,alive:!0}),e.players.set("mock_player_2",{x:1200,y:1200,radius:25,mass:25,name:"Player 2",color:"#45B7D1",score:120,alive:!0}),e.players.size=e.players.size||3,console.log("\uD83C\uDFAD Simulating multiplayer state with",e.players.size,"players"),this.stateChangeCallback(e),this.isConnected&&setTimeout(()=>this.simulateMultiplayerState(),2e3)}setupEventListeners(){this.room&&(this.room.onStateChange(e=>{console.log("\uD83D\uDCCA Arena state updated"),e&&(console.log(`👥 Players: ${e.players?.size||0}`),console.log(`🪙 Coins: ${e.coins?.size||0}`),console.log(`🦠 Viruses: ${e.viruses?.size||0}`))}),this.room.onStateChange.once(e=>{e&&e.players&&(e.players.onAdd=(e,t)=>{console.log(`👋 Player joined: ${e.name||"Unknown"} (${t})`)},e.players.onRemove=(e,t)=>{console.log(`👋 Player left: ${t}`)},e.players.onChange=(e,t)=>{console.log(`🔄 Player updated: ${t}`)}),e&&e.coins&&(e.coins.onAdd=(e,t)=>{console.log(`🪙 Coin spawned: ${t}`)},e.coins.onRemove=(e,t)=>{console.log(`🪙 Coin collected: ${t}`)}),e&&e.viruses&&(e.viruses.onAdd=(e,t)=>{console.log(`🦠 Virus spawned: ${t}`)},e.viruses.onRemove=(e,t)=>{console.log(`🦠 Virus removed: ${t}`)})}),this.room.onMessage("gameState",e=>{console.log("\uD83C\uDFAE Game state message:",e)}),this.room.onMessage("playerJoined",e=>{console.log("\uD83D\uDC64 Player joined:",e)}),this.room.onMessage("playerLeft",e=>{console.log("\uD83D\uDC4B Player left:",e)}),this.room.onError((e,t)=>{console.error("\uD83D\uDEA8 Room error:",e,t)}),this.room.onLeave(e=>{console.log("\uD83D\uDEAA Left room with code:",e),this.isConnected=!1}))}sendInput(e,t,r){if(!this.room||!this.isConnected){console.warn("⚠️ Cannot send input: not connected to room");return}this.room.send("input",{seq:e,dx:t,dy:r})}sendPing(){this.room&&this.isConnected&&this.room.send("ping",{timestamp:Date.now()})}leave(){this.room&&(this.room.leave(),this.room=null),this.isConnected=!1,console.log("\uD83D\uDC4B Disconnected from Colyseus Cloud server")}getGameState(){return this.room?.state||null}getPlayer(e){return this.room?.state?.players?.get(e)||null}getCurrentPlayer(){return this.getPlayer(this.room?.sessionId)}getAllPlayers(){if(!this.room?.state?.players)return[];let e=[];return this.room.state.players.forEach((t,r)=>{e.push({...t,sessionId:r})}),e}getLeaderboard(){return this.getAllPlayers().filter(e=>e.alive).sort((e,t)=>t.score-e.score).slice(0,10).map(e=>({name:e.name,score:e.score,mass:Math.round(e.mass)}))}}let st=new se,sr=({privyUserId:e,playerName:t})=>st.joinArena({privyUserId:e,playerName:t})},17878:(e,t,r)=>{let{EMPTY_BUFFER:s}=r(39353),i=Buffer[Symbol.species];function n(e,t,r,s,i){for(let n=0;n<i;n++)r[s+n]=e[n]^t[3&n]}function o(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(e.exports={concat:function(e,t){if(0===e.length)return s;if(1===e.length)return e[0];let r=Buffer.allocUnsafe(t),n=0;for(let t=0;t<e.length;t++){let s=e[t];r.set(s,n),n+=s.length}return n<t?new i(r.buffer,r.byteOffset,n):r},mask:n,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){let r;return(e.readOnly=!0,Buffer.isBuffer(t))?t:(t instanceof ArrayBuffer?r=new i(t):ArrayBuffer.isView(t)?r=new i(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r)},unmask:o},!process.env.WS_NO_BUFFER_UTIL)try{let t=r(48664);e.exports.mask=function(e,r,s,i,o){o<48?n(e,r,s,i,o):t.mask(e,r,s,i,o)},e.exports.unmask=function(e,r){e.length<32?o(e,r):t.unmask(e,r)}}catch(e){}},39353:e=>{let t=["nodebuffer","arraybuffer","fragments"],r="undefined"!=typeof Blob;r&&t.push("blob"),e.exports={BINARY_TYPES:t,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:r,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},91368:(e,t,r)=>{let{kForOnEventAttribute:s,kListener:i}=r(39353),n=Symbol("kCode"),o=Symbol("kData"),a=Symbol("kError"),l=Symbol("kMessage"),h=Symbol("kReason"),c=Symbol("kTarget"),u=Symbol("kType"),f=Symbol("kWasClean");class d{constructor(e){this[c]=null,this[u]=e}get target(){return this[c]}get type(){return this[u]}}Object.defineProperty(d.prototype,"target",{enumerable:!0}),Object.defineProperty(d.prototype,"type",{enumerable:!0});class p extends d{constructor(e,t={}){super(e),this[n]=void 0===t.code?0:t.code,this[h]=void 0===t.reason?"":t.reason,this[f]=void 0!==t.wasClean&&t.wasClean}get code(){return this[n]}get reason(){return this[h]}get wasClean(){return this[f]}}Object.defineProperty(p.prototype,"code",{enumerable:!0}),Object.defineProperty(p.prototype,"reason",{enumerable:!0}),Object.defineProperty(p.prototype,"wasClean",{enumerable:!0});class g extends d{constructor(e,t={}){super(e),this[a]=void 0===t.error?null:t.error,this[l]=void 0===t.message?"":t.message}get error(){return this[a]}get message(){return this[l]}}Object.defineProperty(g.prototype,"error",{enumerable:!0}),Object.defineProperty(g.prototype,"message",{enumerable:!0});class m extends d{constructor(e,t={}){super(e),this[o]=void 0===t.data?null:t.data}get data(){return this[o]}}function y(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}Object.defineProperty(m.prototype,"data",{enumerable:!0}),e.exports={CloseEvent:p,ErrorEvent:g,Event:d,EventTarget:{addEventListener(e,t,r={}){let n;for(let n of this.listeners(e))if(!r[s]&&n[i]===t&&!n[s])return;if("message"===e)n=function(e,r){let s=new m("message",{data:r?e:e.toString()});s[c]=this,y(t,this,s)};else if("close"===e)n=function(e,r){let s=new p("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});s[c]=this,y(t,this,s)};else if("error"===e)n=function(e){let r=new g("error",{error:e,message:e.message});r[c]=this,y(t,this,r)};else{if("open"!==e)return;n=function(){let e=new d("open");e[c]=this,y(t,this,e)}}n[s]=!!r[s],n[i]=t,r.once?this.once(e,n):this.on(e,n)},removeEventListener(e,t){for(let r of this.listeners(e))if(r[i]===t&&!r[s]){this.removeListener(e,r);break}}},MessageEvent:m}},49964:(e,t,r)=>{let{tokenChars:s}=r(94568);function i(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}e.exports={format:function(e){return Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>[t].concat(Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){let t,r;let n=Object.create(null),o=Object.create(null),a=!1,l=!1,h=!1,c=-1,u=-1,f=-1,d=0;for(;d<e.length;d++)if(u=e.charCodeAt(d),void 0===t){if(-1===f&&1===s[u])-1===c&&(c=d);else if(0!==d&&(32===u||9===u))-1===f&&-1!==c&&(f=d);else if(59===u||44===u){if(-1===c)throw SyntaxError(`Unexpected character at index ${d}`);-1===f&&(f=d);let r=e.slice(c,f);44===u?(i(n,r,o),o=Object.create(null)):t=r,c=f=-1}else throw SyntaxError(`Unexpected character at index ${d}`)}else if(void 0===r){if(-1===f&&1===s[u])-1===c&&(c=d);else if(32===u||9===u)-1===f&&-1!==c&&(f=d);else if(59===u||44===u){if(-1===c)throw SyntaxError(`Unexpected character at index ${d}`);-1===f&&(f=d),i(o,e.slice(c,f),!0),44===u&&(i(n,t,o),o=Object.create(null),t=void 0),c=f=-1}else if(61===u&&-1!==c&&-1===f)r=e.slice(c,d),c=f=-1;else throw SyntaxError(`Unexpected character at index ${d}`)}else if(l){if(1!==s[u])throw SyntaxError(`Unexpected character at index ${d}`);-1===c?c=d:a||(a=!0),l=!1}else if(h){if(1===s[u])-1===c&&(c=d);else if(34===u&&-1!==c)h=!1,f=d;else if(92===u)l=!0;else throw SyntaxError(`Unexpected character at index ${d}`)}else if(34===u&&61===e.charCodeAt(d-1))h=!0;else if(-1===f&&1===s[u])-1===c&&(c=d);else if(-1!==c&&(32===u||9===u))-1===f&&(f=d);else if(59===u||44===u){if(-1===c)throw SyntaxError(`Unexpected character at index ${d}`);-1===f&&(f=d);let s=e.slice(c,f);a&&(s=s.replace(/\\/g,""),a=!1),i(o,r,s),44===u&&(i(n,t,o),o=Object.create(null),t=void 0),r=void 0,c=f=-1}else throw SyntaxError(`Unexpected character at index ${d}`);if(-1===c||h||32===u||9===u)throw SyntaxError("Unexpected end of input");-1===f&&(f=d);let p=e.slice(c,f);return void 0===t?i(n,p,o):(void 0===r?i(o,p,!0):a?i(o,r,p.replace(/\\/g,"")):i(o,r,p),i(n,t,o)),n}}},25936:e=>{let t=Symbol("kDone"),r=Symbol("kRun");class s{constructor(e){this[t]=()=>{this.pending--,this[r]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[r]()}[r](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[t])}}}e.exports=s},97959:(e,t,r)=>{let s;let i=r(59796),n=r(17878),o=r(25936),{kStatusCode:a}=r(39353),l=Buffer[Symbol.species],h=Buffer.from([0,0,255,255]),c=Symbol("permessage-deflate"),u=Symbol("total-length"),f=Symbol("callback"),d=Symbol("buffers"),p=Symbol("error");class g{constructor(e,t,r){this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,s||(s=new o(void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10))}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[f];this._deflate.close(),this._deflate=null,e&&e(Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,r=e.find(e=>(!1!==t.serverNoContextTakeover||!e.server_no_context_takeover)&&(!e.server_max_window_bits||!1!==t.serverMaxWindowBits&&("number"!=typeof t.serverMaxWindowBits||!(t.serverMaxWindowBits>e.server_max_window_bits)))&&("number"!=typeof t.clientMaxWindowBits||!!e.client_max_window_bits));if(!r)throw Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:(!0===r.client_max_window_bits||!1===t.clientMaxWindowBits)&&delete r.client_max_window_bits,r}acceptAsClient(e){let t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let r=e[t];if(r.length>1)throw Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){let e=+r;if(!Number.isInteger(e)||e<8||e>15)throw TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){let e=+r;if(!Number.isInteger(e)||e<8||e>15)throw TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if("client_no_context_takeover"===t||"server_no_context_takeover"===t){if(!0!==r)throw TypeError(`Invalid value for parameter "${t}": ${r}`)}else throw Error(`Unknown parameter "${t}"`);e[t]=r})}),e}decompress(e,t,r){s.add(s=>{this._decompress(e,t,(e,t)=>{s(),r(e,t)})})}compress(e,t,r){s.add(s=>{this._compress(e,t,(e,t)=>{s(),r(e,t)})})}_decompress(e,t,r){let s=this._isServer?"client":"server";if(!this._inflate){let e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?i.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=i.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[c]=this,this._inflate[u]=0,this._inflate[d]=[],this._inflate.on("error",b),this._inflate.on("data",y)}this._inflate[f]=r,this._inflate.write(e),t&&this._inflate.write(h),this._inflate.flush(()=>{let e=this._inflate[p];if(e){this._inflate.close(),this._inflate=null,r(e);return}let i=n.concat(this._inflate[d],this._inflate[u]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[u]=0,this._inflate[d]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),r(null,i)})}_compress(e,t,r){let s=this._isServer?"server":"client";if(!this._deflate){let e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?i.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=i.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[u]=0,this._deflate[d]=[],this._deflate.on("data",m)}this._deflate[f]=r,this._deflate.write(e),this._deflate.flush(i.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=n.concat(this._deflate[d],this._deflate[u]);t&&(e=new l(e.buffer,e.byteOffset,e.length-4)),this._deflate[f]=null,this._deflate[u]=0,this._deflate[d]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),r(null,e)})}}function m(e){this[d].push(e),this[u]+=e.length}function y(e){if(this[u]+=e.length,this[c]._maxPayload<1||this[u]<=this[c]._maxPayload){this[d].push(e);return}this[p]=RangeError("Max payload size exceeded"),this[p].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[p][a]=1009,this.removeListener("data",y),this.reset()}function b(e){this[c]._inflate=null,e[a]=1007,this[f](e)}e.exports=g},83958:(e,t,r)=>{let{Writable:s}=r(12781),i=r(97959),{BINARY_TYPES:n,EMPTY_BUFFER:o,kStatusCode:a,kWebSocket:l}=r(39353),{concat:h,toArrayBuffer:c,unmask:u}=r(17878),{isValidStatusCode:f,isValidUTF8:d}=r(94568),p=Buffer[Symbol.species];class g extends s{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||n[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[l]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let t=this._buffers[0];return this._buffers[0]=new p(t.buffer,t.byteOffset+e,t.length-e),new p(t.buffer,t.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let r=this._buffers[0],s=t.length-e;e>=r.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),s),this._buffers[0]=new p(r.buffer,r.byteOffset+e,r.length-e)),e-=r.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if((48&t[0])!=0){e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"));return}let r=(64&t[0])==64;if(r&&!this._extensions[i.extensionName]){e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));return}if(this._fin=(128&t[0])==128,this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(r){e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));return}if(!this._fragmented){e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"));return}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));return}this._compressed=r}else if(this._opcode>7&&this._opcode<11){if(!this._fin){e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"));return}if(r){e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));return}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"));return}}else{e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));return}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=(128&t[1])==128,this._isServer){if(!this._masked){e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"));return}}else if(this._masked){e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"));return}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),r=t.readUInt32BE(0);if(r>2097151){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"));return}this._payloadLength=4294967296*r+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));return}this._masked?this._state=3:this._state=4}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=4}getData(e){let t=o;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!=0&&u(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=5,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[i.extensionName].decompress(e,this._fin,(e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){t(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));return}this._fragments.push(r)}this.dataMessage(t),0===this._state&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=0;return}let t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?h(r,t):"arraybuffer"===this._binaryType?c(h(r,t)):"blob"===this._binaryType?new Blob(r):r,this._allowSynchronousEvents?(this.emit("message",s,!0),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",s,!0),this._state=0,this.startLoop(e)}))}else{let s=h(r,t);if(!this._skipUTF8Validation&&!d(s)){e(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));return}5===this._state||this._allowSynchronousEvents?(this.emit("message",s,!1),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",s,!1),this._state=0,this.startLoop(e)}))}}controlMessage(e,t){if(8===this._opcode){if(0===e.length)this._loop=!1,this.emit("conclude",1005,o),this.end();else{let r=e.readUInt16BE(0);if(!f(r)){t(this.createError(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE"));return}let s=new p(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!d(s)){t(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));return}this._loop=!1,this.emit("conclude",r,s),this.end()}this._state=0;return}this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate(()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)}))}createError(e,t,r,s,i){this._loop=!1,this._errored=!0;let n=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(n,this.createError),n.code=i,n[a]=s,n}}e.exports=g},74036:(e,t,r)=>{let s;let{Duplex:i}=r(12781),{randomFillSync:n}=r(6113),o=r(97959),{EMPTY_BUFFER:a,kWebSocket:l,NOOP:h}=r(39353),{isBlob:c,isValidStatusCode:u}=r(94568),{mask:f,toBuffer:d}=r(17878),p=Symbol("kByteLength"),g=Buffer.alloc(4),m=8192;class y{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=h,this[l]=void 0}static frame(e,t){let r,i;let o=!1,a=2,l=!1;t.mask&&(r=t.maskBuffer||g,t.generateMask?t.generateMask(r):(8192===m&&(void 0===s&&(s=Buffer.alloc(8192)),n(s,0,8192),m=0),r[0]=s[m++],r[1]=s[m++],r[2]=s[m++],r[3]=s[m++]),l=(r[0]|r[1]|r[2]|r[3])==0,a=6),"string"==typeof e?i=(!t.mask||l)&&void 0!==t[p]?t[p]:(e=Buffer.from(e)).length:(i=e.length,o=t.mask&&t.readOnly&&!l);let h=i;i>=65536?(a+=8,h=127):i>125&&(a+=2,h=126);let c=Buffer.allocUnsafe(o?i+a:a);return(c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=h,126===h?c.writeUInt16BE(i,2):127===h&&(c[2]=c[3]=0,c.writeUIntBE(i,4,6)),t.mask)?(c[1]|=128,c[a-4]=r[0],c[a-3]=r[1],c[a-2]=r[2],c[a-1]=r[3],l)?[c,e]:o?(f(e,r,c,a,i),[c]):(f(e,r,e,0,i),[c,e]):[c,e]}close(e,t,r,s){let i;if(void 0===e)i=a;else if("number"==typeof e&&u(e)){if(void 0!==t&&t.length){let r=Buffer.byteLength(t);if(r>123)throw RangeError("The message must not be greater than 123 bytes");(i=Buffer.allocUnsafe(2+r)).writeUInt16BE(e,0),"string"==typeof t?i.write(t,2):i.set(t,2)}else(i=Buffer.allocUnsafe(2)).writeUInt16BE(e,0)}else throw TypeError("First argument must be a valid error code number");let n={[p]:i.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,i,!1,n,s]):this.sendFrame(y.frame(i,n),s)}ping(e,t,r){let s,i;if("string"==typeof e?(s=Buffer.byteLength(e),i=!1):c(e)?(s=e.size,i=!1):(s=(e=d(e)).length,i=d.readOnly),s>125)throw RangeError("The data size must not be greater than 125 bytes");let n={[p]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};c(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,n,r]):this.getBlobData(e,!1,n,r):0!==this._state?this.enqueue([this.dispatch,e,!1,n,r]):this.sendFrame(y.frame(e,n),r)}pong(e,t,r){let s,i;if("string"==typeof e?(s=Buffer.byteLength(e),i=!1):c(e)?(s=e.size,i=!1):(s=(e=d(e)).length,i=d.readOnly),s>125)throw RangeError("The data size must not be greater than 125 bytes");let n={[p]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};c(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,n,r]):this.getBlobData(e,!1,n,r):0!==this._state?this.enqueue([this.dispatch,e,!1,n,r]):this.sendFrame(y.frame(e,n),r)}send(e,t,r){let s,i;let n=this._extensions[o.extensionName],a=t.binary?2:1,l=t.compress;"string"==typeof e?(s=Buffer.byteLength(e),i=!1):c(e)?(s=e.size,i=!1):(s=(e=d(e)).length,i=d.readOnly),this._firstFragment?(this._firstFragment=!1,l&&n&&n.params[n._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(l=s>=n._threshold),this._compress=l):(l=!1,a=0),t.fin&&(this._firstFragment=!0);let h={[p]:s,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:i,rsv1:l};c(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,h,r]):this.getBlobData(e,this._compress,h,r):0!==this._state?this.enqueue([this.dispatch,e,this._compress,h,r]):this.dispatch(e,this._compress,h,r)}getBlobData(e,t,r,s){this._bufferedBytes+=r[p],this._state=2,e.arrayBuffer().then(e=>{if(this._socket.destroyed){let e=Error("The socket was closed while the blob was being read");process.nextTick(b,this,e,s);return}this._bufferedBytes-=r[p];let i=d(e);t?this.dispatch(i,t,r,s):(this._state=0,this.sendFrame(y.frame(i,r),s),this.dequeue())}).catch(e=>{process.nextTick(_,this,e,s)})}dispatch(e,t,r,s){if(!t){this.sendFrame(y.frame(e,r),s);return}let i=this._extensions[o.extensionName];this._bufferedBytes+=r[p],this._state=1,i.compress(e,r.fin,(e,t)=>{if(this._socket.destroyed){b(this,Error("The socket was closed while data was being compressed"),s);return}this._bufferedBytes-=r[p],this._state=0,r.readOnly=!1,this.sendFrame(y.frame(t,r),s),this.dequeue()})}dequeue(){for(;0===this._state&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][p],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][p],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}function b(e,t,r){"function"==typeof r&&r(t);for(let r=0;r<e._queue.length;r++){let s=e._queue[r],i=s[s.length-1];"function"==typeof i&&i(t)}}function _(e,t,r){b(e,t,r),e.onerror(t)}e.exports=y},42504:(e,t,r)=>{let{Duplex:s}=r(12781);function i(e){e.emit("close")}function n(){!this.destroyed&&this._writableState.finished&&this.destroy()}function o(e){this.removeListener("error",o),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}e.exports=function(e,t){let r=!0,a=new s({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",function(t,r){let s=!r&&a._readableState.objectMode?t.toString():t;a.push(s)||e.pause()}),e.once("error",function(e){a.destroyed||(r=!1,a.destroy(e))}),e.once("close",function(){a.destroyed||a.push(null)}),a._destroy=function(t,s){if(e.readyState===e.CLOSED){s(t),process.nextTick(i,a);return}let n=!1;e.once("error",function(e){n=!0,s(e)}),e.once("close",function(){n||s(t),process.nextTick(i,a)}),r&&e.terminate()},a._final=function(t){if(e.readyState===e.CONNECTING){e.once("open",function(){a._final(t)});return}null!==e._socket&&(e._socket._writableState.finished?(t(),a._readableState.endEmitted&&a.destroy()):(e._socket.once("finish",function(){t()}),e.close()))},a._read=function(){e.isPaused&&e.resume()},a._write=function(t,r,s){if(e.readyState===e.CONNECTING){e.once("open",function(){a._write(t,r,s)});return}e.send(t,s)},a.on("end",n),a.on("error",o),a}},62444:(e,t,r)=>{let{tokenChars:s}=r(94568);e.exports={parse:function(e){let t=new Set,r=-1,i=-1,n=0;for(;n<e.length;n++){let o=e.charCodeAt(n);if(-1===i&&1===s[o])-1===r&&(r=n);else if(0!==n&&(32===o||9===o))-1===i&&-1!==r&&(i=n);else if(44===o){if(-1===r)throw SyntaxError(`Unexpected character at index ${n}`);-1===i&&(i=n);let s=e.slice(r,i);if(t.has(s))throw SyntaxError(`The "${s}" subprotocol is duplicated`);t.add(s),r=i=-1}else throw SyntaxError(`Unexpected character at index ${n}`)}if(-1===r||-1!==i)throw SyntaxError("Unexpected end of input");let o=e.slice(r,n);if(t.has(o))throw SyntaxError(`The "${o}" subprotocol is duplicated`);return t.add(o),t}}},94568:(e,t,r)=>{let{isUtf8:s}=r(14300),{hasBlob:i}=r(39353);function n(e){let t=e.length,r=0;for(;r<t;)if((128&e[r])==0)r++;else if((224&e[r])==192){if(r+1===t||(192&e[r+1])!=128||(254&e[r])==192)return!1;r+=2}else if((240&e[r])==224){if(r+2>=t||(192&e[r+1])!=128||(192&e[r+2])!=128||224===e[r]&&(224&e[r+1])==128||237===e[r]&&(224&e[r+1])==160)return!1;r+=3}else{if((248&e[r])!=240||r+3>=t||(192&e[r+1])!=128||(192&e[r+2])!=128||(192&e[r+3])!=128||240===e[r]&&(240&e[r+1])==128||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}if(e.exports={isBlob:function(e){return i&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:n,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},s)e.exports.isValidUTF8=function(e){return e.length<24?n(e):s(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let t=r(63248);e.exports.isValidUTF8=function(e){return e.length<32?n(e):t(e)}}catch(e){}},30359:(e,t,r)=>{let s=r(82361),i=r(13685),{Duplex:n}=r(12781),{createHash:o}=r(6113),a=r(49964),l=r(97959),h=r(62444),c=r(46342),{GUID:u,kWebSocket:f}=r(39353),d=/^[+/0-9A-Za-z]{22}==$/;class p extends s{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:c,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=i.createServer((e,t)=>{let r=i.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(let r of Object.keys(t))e.on(r,t[r]);return function(){for(let r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,s)=>{this.handleUpgrade(t,r,s,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state){e&&this.once("close",()=>{e(Error("The server is not running"))}),process.nextTick(g,this);return}if(e&&this.once("close",e),1!==this._state){if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(g,this);else{let e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close(()=>{g(this)})}}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,s){t.on("error",m);let i=e.headers["sec-websocket-key"],n=e.headers.upgrade,o=+e.headers["sec-websocket-version"];if("GET"!==e.method){b(this,e,t,405,"Invalid HTTP method");return}if(void 0===n||"websocket"!==n.toLowerCase()){b(this,e,t,400,"Invalid Upgrade header");return}if(void 0===i||!d.test(i)){b(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(8!==o&&13!==o){b(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(e)){y(t,400);return}let c=e.headers["sec-websocket-protocol"],u=new Set;if(void 0!==c)try{u=h.parse(c)}catch(r){b(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let f=e.headers["sec-websocket-extensions"],p={};if(this.options.perMessageDeflate&&void 0!==f){let r=new l(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let e=a.parse(f);e[l.extensionName]&&(r.accept(e[l.extensionName]),p[l.extensionName]=r)}catch(r){b(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let n={origin:e.headers[`${8===o?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(2===this.options.verifyClient.length){this.options.verifyClient(n,(n,o,a,l)=>{if(!n)return y(t,o||401,a,l);this.completeUpgrade(p,i,u,e,t,r,s)});return}if(!this.options.verifyClient(n))return y(t,401)}this.completeUpgrade(p,i,u,e,t,r,s)}completeUpgrade(e,t,r,s,i,n,h){if(!i.readable||!i.writable)return i.destroy();if(i[f])throw Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return y(i,503);let c=o("sha1").update(t+u).digest("base64"),d=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${c}`],p=new this.options.WebSocket(null,void 0,this.options);if(r.size){let e=this.options.handleProtocols?this.options.handleProtocols(r,s):r.values().next().value;e&&(d.push(`Sec-WebSocket-Protocol: ${e}`),p._protocol=e)}if(e[l.extensionName]){let t=e[l.extensionName].params,r=a.format({[l.extensionName]:[t]});d.push(`Sec-WebSocket-Extensions: ${r}`),p._extensions=e}this.emit("headers",d,s),i.write(d.concat("\r\n").join("\r\n")),i.removeListener("error",m),p.setSocket(i,n,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(p),p.on("close",()=>{this.clients.delete(p),this._shouldEmitClose&&!this.clients.size&&process.nextTick(g,this)})),h(p,s)}}function g(e){e._state=2,e.emit("close")}function m(){this.destroy()}function y(e,t,r,s){r=r||i.STATUS_CODES[t],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...s},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${i.STATUS_CODES[t]}\r
`+Object.keys(s).map(e=>`${e}: ${s[e]}`).join("\r\n")+"\r\n\r\n"+r)}function b(e,t,r,s,i){if(e.listenerCount("wsClientError")){let s=Error(i);Error.captureStackTrace(s,b),e.emit("wsClientError",s,r,t)}else y(r,s,i)}e.exports=p},46342:(e,t,r)=>{let s=r(82361),i=r(95687),n=r(13685),o=r(41808),a=r(24404),{randomBytes:l,createHash:h}=r(6113),{Duplex:c,Readable:u}=r(12781),{URL:f}=r(57310),d=r(97959),p=r(83958),g=r(74036),{isBlob:m}=r(94568),{BINARY_TYPES:y,EMPTY_BUFFER:b,GUID:_,kForOnEventAttribute:v,kListener:w,kStatusCode:E,kWebSocket:S,NOOP:x}=r(39353),{EventTarget:{addEventListener:C,removeEventListener:k}}=r(91368),{format:I,parse:O}=r(49964),{toBuffer:T}=r(17878),A=Symbol("kAborted"),D=[8,13],$=["CONNECTING","OPEN","CLOSING","CLOSED"],R=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class N extends s{constructor(e,t,r){super(),this._binaryType=y[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=b,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=N.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(r=t,t=[]):t=[t]),function e(t,r,s,o){let a,c,u,p;let g={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:D[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...o,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(t._autoPong=g.autoPong,!D.includes(g.protocolVersion))throw RangeError(`Unsupported protocol version: ${g.protocolVersion} (supported versions: ${D.join(", ")})`);if(r instanceof f)a=r;else try{a=new f(r)}catch(e){throw SyntaxError(`Invalid URL: ${r}`)}"http:"===a.protocol?a.protocol="ws:":"https:"===a.protocol&&(a.protocol="wss:"),t._url=a.href;let m="wss:"===a.protocol,y="ws+unix:"===a.protocol;if("ws:"===a.protocol||m||y?y&&!a.pathname?c="The URL's pathname is empty":a.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',c){let e=SyntaxError(c);if(0===t._redirects)throw e;L(t,e);return}let b=m?443:80,v=l(16).toString("base64"),w=m?i.request:n.request,E=new Set;if(g.createConnection=g.createConnection||(m?M:P),g.defaultPort=g.defaultPort||b,g.port=a.port||b,g.host=a.hostname.startsWith("[")?a.hostname.slice(1,-1):a.hostname,g.headers={...g.headers,"Sec-WebSocket-Version":g.protocolVersion,"Sec-WebSocket-Key":v,Connection:"Upgrade",Upgrade:"websocket"},g.path=a.pathname+a.search,g.timeout=g.handshakeTimeout,g.perMessageDeflate&&(u=new d(!0!==g.perMessageDeflate?g.perMessageDeflate:{},!1,g.maxPayload),g.headers["Sec-WebSocket-Extensions"]=I({[d.extensionName]:u.offer()})),s.length){for(let e of s){if("string"!=typeof e||!R.test(e)||E.has(e))throw SyntaxError("An invalid or duplicated subprotocol was specified");E.add(e)}g.headers["Sec-WebSocket-Protocol"]=s.join(",")}if(g.origin&&(g.protocolVersion<13?g.headers["Sec-WebSocket-Origin"]=g.origin:g.headers.Origin=g.origin),(a.username||a.password)&&(g.auth=`${a.username}:${a.password}`),y){let e=g.path.split(":");g.socketPath=e[0],g.path=e[1]}if(g.followRedirects){if(0===t._redirects){t._originalIpc=y,t._originalSecure=m,t._originalHostOrSocketPath=y?g.socketPath:a.host;let e=o&&o.headers;if(o={...o,headers:{}},e)for(let[t,r]of Object.entries(e))o.headers[t.toLowerCase()]=r}else if(0===t.listenerCount("redirect")){let e=y?!!t._originalIpc&&g.socketPath===t._originalHostOrSocketPath:!t._originalIpc&&a.host===t._originalHostOrSocketPath;e&&(!t._originalSecure||m)||(delete g.headers.authorization,delete g.headers.cookie,e||delete g.headers.host,g.auth=void 0)}g.auth&&!o.headers.authorization&&(o.headers.authorization="Basic "+Buffer.from(g.auth).toString("base64")),p=t._req=w(g),t._redirects&&t.emit("redirect",t.url,p)}else p=t._req=w(g);g.timeout&&p.on("timeout",()=>{B(t,p,"Opening handshake has timed out")}),p.on("error",e=>{null===p||p[A]||(p=t._req=null,L(t,e))}),p.on("response",i=>{let n=i.headers.location,a=i.statusCode;if(n&&g.followRedirects&&a>=300&&a<400){let i;if(++t._redirects>g.maxRedirects){B(t,p,"Maximum redirects exceeded");return}p.abort();try{i=new f(n,r)}catch(e){L(t,SyntaxError(`Invalid URL: ${n}`));return}e(t,i,s,o)}else t.emit("unexpected-response",p,i)||B(t,p,`Unexpected server response: ${i.statusCode}`)}),p.on("upgrade",(e,r,s)=>{let i;if(t.emit("upgrade",e),t.readyState!==N.CONNECTING)return;p=t._req=null;let n=e.headers.upgrade;if(void 0===n||"websocket"!==n.toLowerCase()){B(t,r,"Invalid Upgrade header");return}let o=h("sha1").update(v+_).digest("base64");if(e.headers["sec-websocket-accept"]!==o){B(t,r,"Invalid Sec-WebSocket-Accept header");return}let a=e.headers["sec-websocket-protocol"];if(void 0!==a?E.size?E.has(a)||(i="Server sent an invalid subprotocol"):i="Server sent a subprotocol but none was requested":E.size&&(i="Server sent no subprotocol"),i){B(t,r,i);return}a&&(t._protocol=a);let l=e.headers["sec-websocket-extensions"];if(void 0!==l){let e;if(!u){B(t,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}try{e=O(l)}catch(e){B(t,r,"Invalid Sec-WebSocket-Extensions header");return}let s=Object.keys(e);if(1!==s.length||s[0]!==d.extensionName){B(t,r,"Server indicated an extension that was not requested");return}try{u.accept(e[d.extensionName])}catch(e){B(t,r,"Invalid Sec-WebSocket-Extensions header");return}t._extensions[d.extensionName]=u}t.setSocket(r,s,{allowSynchronousEvents:g.allowSynchronousEvents,generateMask:g.generateMask,maxPayload:g.maxPayload,skipUTF8Validation:g.skipUTF8Validation})}),g.finishRequest?g.finishRequest(p,t):p.end()}(this,e,t,r)):(this._autoPong=r.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){y.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){let s=new p({allowSynchronousEvents:r.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation}),i=new g(e,this._extensions,r.generateMask);this._receiver=s,this._sender=i,this._socket=e,s[S]=this,i[S]=this,e[S]=this,s.on("conclude",j),s.on("drain",F),s.on("error",V),s.on("message",z),s.on("ping",q),s.on("pong",H),i.onerror=J,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Y),e.on("data",Z),e.on("end",X),e.on("error",Q),this._readyState=N.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=N.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[d.extensionName]&&this._extensions[d.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=N.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==N.CLOSED){if(this.readyState===N.CONNECTING){B(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===N.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=N.CLOSING,this._sender.close(e,t,!this._isServer,e=>{!e&&(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),K(this)}}pause(){this.readyState!==N.CONNECTING&&this.readyState!==N.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,r){if(this.readyState===N.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN){U(this,e,r);return}void 0===t&&(t=!this._isServer),this._sender.ping(e||b,t,r)}pong(e,t,r){if(this.readyState===N.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN){U(this,e,r);return}void 0===t&&(t=!this._isServer),this._sender.pong(e||b,t,r)}resume(){this.readyState!==N.CONNECTING&&this.readyState!==N.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,r){if(this.readyState===N.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN){U(this,e,r);return}let s={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[d.extensionName]||(s.compress=!1),this._sender.send(e||b,s,r)}terminate(){if(this.readyState!==N.CLOSED){if(this.readyState===N.CONNECTING){B(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=N.CLOSING,this._socket.destroy())}}}function L(e,t){e._readyState=N.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function P(e){return e.path=e.socketPath,o.connect(e)}function M(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=o.isIP(e.host)?"":e.host),a.connect(e)}function B(e,t,r){e._readyState=N.CLOSING;let s=Error(r);Error.captureStackTrace(s,B),t.setHeader?(t[A]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(L,e,s)):(t.destroy(s),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function U(e,t,r){if(t){let r=m(t)?t.size:T(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){let t=Error(`WebSocket is not open: readyState ${e.readyState} (${$[e.readyState]})`);process.nextTick(r,t)}}function j(e,t){let r=this[S];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[S]&&(r._socket.removeListener("data",Z),process.nextTick(G,r._socket),1005===e?r.close():r.close(e,t))}function F(){let e=this[S];e.isPaused||e._socket.resume()}function V(e){let t=this[S];void 0!==t._socket[S]&&(t._socket.removeListener("data",Z),process.nextTick(G,t._socket),t.close(e[E])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function W(){this[S].emitClose()}function z(e,t){this[S].emit("message",e,t)}function q(e){let t=this[S];t._autoPong&&t.pong(e,!this._isServer,x),t.emit("ping",e)}function H(e){this[S].emit("pong",e)}function G(e){e.resume()}function J(e){let t=this[S];t.readyState===N.CLOSED||(t.readyState===N.OPEN&&(t._readyState=N.CLOSING,K(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function K(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),3e4)}function Y(){let e;let t=this[S];this.removeListener("close",Y),this.removeListener("data",Z),this.removeListener("end",X),t._readyState=N.CLOSING,this._readableState.endEmitted||t._closeFrameReceived||t._receiver._writableState.errorEmitted||null===(e=t._socket.read())||t._receiver.write(e),t._receiver.end(),this[S]=void 0,clearTimeout(t._closeTimer),t._receiver._writableState.finished||t._receiver._writableState.errorEmitted?t.emitClose():(t._receiver.on("error",W),t._receiver.on("finish",W))}function Z(e){this[S]._receiver.write(e)||this.pause()}function X(){let e=this[S];e._readyState=N.CLOSING,e._receiver.end(),this.end()}function Q(){let e=this[S];this.removeListener("error",Q),this.on("error",x),e&&(e._readyState=N.CLOSING,this.destroy())}Object.defineProperty(N,"CONNECTING",{enumerable:!0,value:$.indexOf("CONNECTING")}),Object.defineProperty(N.prototype,"CONNECTING",{enumerable:!0,value:$.indexOf("CONNECTING")}),Object.defineProperty(N,"OPEN",{enumerable:!0,value:$.indexOf("OPEN")}),Object.defineProperty(N.prototype,"OPEN",{enumerable:!0,value:$.indexOf("OPEN")}),Object.defineProperty(N,"CLOSING",{enumerable:!0,value:$.indexOf("CLOSING")}),Object.defineProperty(N.prototype,"CLOSING",{enumerable:!0,value:$.indexOf("CLOSING")}),Object.defineProperty(N,"CLOSED",{enumerable:!0,value:$.indexOf("CLOSED")}),Object.defineProperty(N.prototype,"CLOSED",{enumerable:!0,value:$.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(e=>{Object.defineProperty(N.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(N.prototype,`on${e}`,{enumerable:!0,get(){for(let t of this.listeners(e))if(t[v])return t[w];return null},set(t){for(let t of this.listeners(e))if(t[v]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[v]:!0})}})}),N.prototype.addEventListener=C,N.prototype.removeEventListener=k,e.exports=N}};